<ValueTree xmlns="http://v8.1c.ru/8.1/data/core" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ValueTree">
	<column>
		<Name xsi:type="xs:string">Использовать</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Кнопка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Служебные</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Формула</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">СлужебныеТекст</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Сохранение</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Загрузка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">КоллекцияТЧ</Name>
		<ValueType/>
	</column>
	<row>
		<Value xsi:type="xs:boolean">true</Value>
		<Value xsi:type="xs:string">Создать реализацию товаров</Value>
		<Value xsi:type="xs:string">ИмяСобытия = "Создание документов по кнопке &lt;&lt;&lt; Создать реализацию товаров &gt;&gt;&gt;";
РазделятьРеализации = Настройка_Параметр_Прочитать("ЭКОМ_РазделятьРеализации", Ложь);

КвалификаторСтрок = Новый КвалификаторыСтроки(36);

ТаблицаВыбранныхЗаписей = Новый ТаблицаЗначений;
ТаблицаВыбранныхЗаписей.Колонки.Добавить("Документ", Новый ОписаниеТипов("ДокументСсылка.ЗаказКлиента"));
ТаблицаВыбранныхЗаписей.Колонки.Добавить("ИдентификаторЦепочки", Новый ОписаниеТипов("Строка",,,,КвалификаторСтрок));
ТаблицаВыбранныхЗаписей.Колонки.Добавить("Идентификатор", Новый ОписаниеТипов("Строка",,,,КвалификаторСтрок));

Для Каждого Элемент Из ВыбранныеСтроки Цикл
	Элемент.Вставить("Идентификатор", Элемент.Документ.УникальныйИдентификатор());
	НоваяСтрока = ТаблицаВыбранныхЗаписей.Добавить();
	ЗаполнитьЗначенияСвойств(НоваяСтрока, Элемент);
КонецЦикла;

// служебные переменные гибких настроек ++
ТипПриемника   = "РеализацияТоваровУслуг";
ОперацияЗапись = Ложь;
ЛогСобытий	   = ""; 
// служебные переменные гибких настроек --

Запрос = Новый Запрос;
Запрос.Текст = "ВЫБРАТЬ
               |	ВыбранныеЗаписи.Документ КАК Документ,
               |	ВыбранныеЗаписи.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
               |	ВыбранныеЗаписи.Идентификатор КАК Идентификатор
               |ПОМЕСТИТЬ ВыбранныеЗаписи
               |ИЗ
               |	&amp;ТаблицаВыбранныхЗаписей КАК ВыбранныеЗаписи
               |;
               |
               |////////////////////////////////////////////////////////////////////////////////
               |ВЫБРАТЬ
               |	ВыбранныеЗаписи.Документ КАК Документ,
               |	ВыбранныеЗаписи.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
               |	ВыбранныеЗаписи.Идентификатор КАК Идентификатор,
               |	Заказ_События.ИдентификаторОснования КАК ИдентификаторОснования
               |ПОМЕСТИТЬ ВТ_СобытияЗаказ
               |ИЗ
               |	ВыбранныеЗаписи КАК ВыбранныеЗаписи
               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.DR_События КАК Заказ_События
               |		ПО ВыбранныеЗаписи.Идентификатор = Заказ_События.Идентификатор
               |;
               |
               |////////////////////////////////////////////////////////////////////////////////
               |ВЫБРАТЬ
               |	ВТ_СобытияЗаказ.Документ КАК Источник,
               |	ВТ_СобытияЗаказ.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
               |	ORDER_События.Документ КАК DR_Документ,
               |	МАКСИМУМ(ЕСТЬNULL(Реализация_События.Документ, ЗНАЧЕНИЕ(Документ.РеализацияТоваровУслуг.ПустаяСсылка))) КАК ДокументРеализации
               |ПОМЕСТИТЬ Итог
               |ИЗ
               |	ВТ_СобытияЗаказ КАК ВТ_СобытияЗаказ
               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.DR_События КАК ORDER_События
               |		ПО ВТ_СобытияЗаказ.ИдентификаторЦепочки = ORDER_События.ИдентификаторЦепочки
               |			И (ORDER_События.ВидДокумента = ""ORDER_Входящий"")
               |			И ВТ_СобытияЗаказ.ИдентификаторОснования = ORDER_События.Идентификатор
               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.DR_События КАК Реализация_События
               |		ПО ВТ_СобытияЗаказ.ИдентификаторЦепочки = Реализация_События.ИдентификаторЦепочки
               |			И (Реализация_События.ВидДокумента = ""Накладная_исходящая"")
               |
               |СГРУППИРОВАТЬ ПО
               |	ВТ_СобытияЗаказ.Документ,
               |	ВТ_СобытияЗаказ.ИдентификаторЦепочки,
               |	ORDER_События.Документ
               |;
               |
               |////////////////////////////////////////////////////////////////////////////////
               |ВЫБРАТЬ
               |	Итог.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
               |	Итог.Источник КАК Источник,
               |	Итог.DR_Документ КАК DR_Документ,
               |	ВЫРАЗИТЬ(ДР_ДатаПоставки.Значение КАК ДАТА) КАК ДатаПоставки,
               |	ВЫРАЗИТЬ(ДР_NUMBER.Значение КАК СТРОКА(35)) КАК ЗаказНомер,
               |	ВЫРАЗИТЬ(ДР_ДатаЭлектронногоДокумента.Значение КАК ДАТА) КАК ЗаказДата,
               |	ЕСТЬNULL(ЗаказКлиента.Склад, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) КАК ИсточникСклад,
               |	ЕСТЬNULL(ЗаказКлиента.ДатаОтгрузки, ДАТАВРЕМЯ(1, 1, 1)) КАК ИсточникДатаОтгрузки,
               |	ЕСТЬNULL(ЗаказКлиента.Комментарий, """") КАК ИсточникКомментарий,
               |	ЕСТЬNULL(ЗаказКлиента.Дата, ДАТАВРЕМЯ(1, 1, 1)) КАК ИсточникДата,
               |	ЕСТЬNULL(ЗаказКлиента.Номер, """") КАК ИсточникНомер,
               |	Итог.ДокументРеализации КАК ДокументРеализации,
               |	ЕСТЬNULL(ЗаказКлиента.НомерПоДаннымКлиента, """") КАК НомерПоДаннымКлиента,
               |	ЕСТЬNULL(ЗаказКлиента.ДатаПоДаннымКлиента, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаПоДаннымКлиента
               |ИЗ
               |	Итог КАК Итог
               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказКлиента КАК ЗаказКлиента
               |		ПО Итог.Источник = ЗаказКлиента.Ссылка
               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ДР_ДатаПоставки
               |		ПО Итог.DR_Документ = ДР_ДатаПоставки.Ссылка
               |			И (ДР_ДатаПоставки.Реквизит = ""ДатаПоставки"")
               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ДР_NUMBER
               |		ПО Итог.DR_Документ = ДР_NUMBER.Ссылка
               |			И (ДР_NUMBER.Реквизит = ""NUMBER"")
               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ДР_ДатаЭлектронногоДокумента
               |		ПО Итог.DR_Документ = ДР_ДатаЭлектронногоДокумента.Ссылка
               |			И (ДР_ДатаЭлектронногоДокумента.Реквизит = ""ДатаЭлектронногоДокумента"")";
Запрос.УстановитьПараметр("ТаблицаВыбранныхЗаписей", ТаблицаВыбранныхЗаписей);
Выборка = Запрос.Выполнить().Выбрать();

Пока Выборка.Следующий() Цикл

	Если КэшированныеЗначения = Неопределено Тогда
		КэшированныеЗначения = ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруКэшируемыеЗначения();
	КонецЕсли;
	// Получение общих для всех документов значений.
	ПроводитьРеализацию			= Неопределено;
	Если НЕ КэшированныеЗначения.Свойство("ПроводитьРеализацию", ПроводитьРеализацию) Тогда
		ПроводитьРеализацию		= Настройка_Параметр_Прочитать("ЭКОМ_СоздаватьДокументРеализация1СПроведенным");
		КэшированныеЗначения.Вставить("ПроводитьРеализацию", ПроводитьРеализацию);
	КонецЕсли;
	ЗагружатьДатойПоставки		= Неопределено;
	Если НЕ КэшированныеЗначения.Свойство("ЗагружатьДатойПоставки", ЗагружатьДатойПоставки) Тогда
		ЗагружатьДатойПоставки	= Настройка_Параметр_Прочитать("ЭКОМ_РеализацииСоздаватьДатойПоставки");
		КэшированныеЗначения.Вставить("ЗагружатьДатойПоставки", ЗагружатьДатойПоставки);
	КонецЕсли;

	
	Приемник = Документы[ТипПриемника].СоздатьДокумент();

	ЗаказДата  = Выборка.ЗаказДата;
	ЗаказНомер = Выборка.ЗаказНомер;
	
	ДатаДокумента = Выборка.ДатаПоставки;
	Если ДатаДокумента &lt; Выборка.ИсточникДата Тогда
		ДатаДокумента = Выборка.ИсточникДата + 1; // дата РТУ должна быть больше даты заказа: такое возможно, если в настройках дата заказа = текущая дата и дата РТУ = дата поставки
	КонецЕсли;
	
	ДатаДокумента = ?(ЗагружатьДатойПоставки, ДатаДокумента, ТекущаяДатаСеанса());
	
	ПараметрыОснования = Новый Структура();
	
	ПараметрыОснования.Вставить("ДокументОснование", Выборка.Источник);
	ПараметрыОснования.Вставить("СкладОтгрузки", Выборка.ИсточникСклад);
	ПараметрыОснования.Вставить("ДатаОтгрузки", Выборка.ИсточникДатаОтгрузки);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	РеализацияТоваровУслуг.Ссылка КАК Накладная,
	|	РеализацияТоваровУслуг.Проведен КАК Проведен,
	|	РеализацияТоваровУслуг.Представление КАК РеализацияПредставление
	|ИЗ
	|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|ГДЕ
	|	РеализацияТоваровУслуг.Ссылка = &amp;Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", Выборка.ДокументРеализации);
	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаРеализация = РезультатЗапроса.Выбрать();
	ВыборкаРеализация.Следующий();
	
	НакладнаяПроведена		= ВыборкаРеализация.Проведен;  		
	Накладная			    = ВыборкаРеализация.Накладная;
	РеализацияПредставление = ВыборкаРеализация.РеализацияПредставление;
	
	Если ЗначениеЗаполнено(Накладная) И НЕ РазделятьРеализации И НЕ НакладнаяПроведена Тогда   
		ОперацияЗапись = Истина;
		
		Приемник = Накладная.ПолучитьОбъект();
		Приемник.Товары.Очистить();
	ИначеЕсли ЗначениеЗаполнено(Накладная) И НЕ РазделятьРеализации И НакладнаяПроведена Тогда
		НачатьТранзакцию();
				
		Попытка
			НакладнаяОбъект = Накладная.ПолучитьОбъект();
			НакладнаяОбъект.ПометкаУдаления = Истина;
			НакладнаяОбъект.Записать(РежимЗаписиДокумента.ОтменаПроведения);
			ЗафиксироватьТранзакцию();
			
			ТекстЛогаСобытий = "Помечен на удаление существующий документ " + РеализацияПредставление + " по заказу № " + ЗаказНомер + " от " + ЗаказДата;
			ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Предупреждение", ИмяСобытия);
			МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога); 
		Исключение
			ОтменитьТранзакцию();
			ТекстЛогаСобытий = "Не удалось пометить на удаление документ " + РеализацияПредставление + " по заказу № " + ЗаказНомер + " от " + ЗаказДата 
								+ Символы.ПС + "Создание нового документа отменено";
			ЗаписатьЛогСобытий(ЛогСобытий, ТекстЛогаСобытий); 
			Продолжить;
		КонецПопытки;
	КонецЕсли;
	
	Приемник.Заполнить(ПараметрыОснования);
	Приемник.Дата = ДатаДокумента;
	Если НЕ ПустаяСтрока(Выборка.ИсточникКомментарий) Тогда
		Приемник.Комментарий = Выборка.ИсточникКомментарий;
	Иначе
		Приемник.Комментарий = ?(ЗначениеЗаполнено(Выборка.НомерПоДаннымКлиента), "Заказ № " + Выборка.НомерПоДаннымКлиента, "");
		Приемник.Комментарий = Приемник.Комментарий
		+ ?(ЗначениеЗаполнено(Приемник.Комментарий) И ЗначениеЗаполнено(Выборка.ДатаПоДаннымКлиента), 
		" от " + Формат(Выборка.ДатаПоДаннымКлиента, "ДФ=dd.MM.yyyy"), "");
	КонецЕсли;
	
	Приемник.СкидкиРассчитаны = Истина;
	
	// Заполнение ТЧ Товары.
	Если Приемник.Товары.Количество() = 0 Тогда
		ДанныеОтбора = Новый Структура(
		"Дата,
		|Склад,
		|Партнер,
		|Сделка,
		|Контрагент,
		|Договор,
		|Организация,
		|ХозяйственнаяОперация,
		|Соглашение,
		|ВалютаВзаиморасчетов,
		|НалогообложениеНДС,
		|ЦенаВключаетНДС,
		|ПорядокРасчетов,
		|ВернутьМногооборотнуюТару,
		|ТребуетсяЗалогЗаТару,
		|Статус,
		|НаправлениеДеятельности,
		|Ссылка,
		|Валюта");
		
		ЗаполнитьЗначенияСвойств(ДанныеОтбора, Приемник);
		ДанныеОтбора.Вставить("ТоварыРеализации", Приемник.Товары);
		
		ПараметрыЗаполнения = Новый Структура;
		ПараметрыЗаполнения.Вставить("ОтображатьСообщение", Ложь);
		ПараметрыЗаполнения.Вставить("ПодборПоЗаказамОрдерам", Истина);
		ПараметрыЗаполнения.Вставить("Курс", Приемник.Курс);
		ПараметрыЗаполнения.Вставить("Кратность", Приемник.Кратность);
		
		ТаблицаСкидкиНаценки = Новый ТаблицаЗначений;
		ТаблицаСкидкиНаценки.Колонки.Добавить("Сумма");
		
		ТЧТовары = Приемник.Товары.Выгрузить();
		ТЧТовары.Колонки.Добавить("КоличествоВЗаказе");
		ТЧТовары.Колонки.Добавить("КоличествоУпаковокВЗаказе");
		ТЧТовары.Колонки.Добавить("КоличествоСобирается");
		ТЧТовары.Колонки.Добавить("КоличествоВОрдере");
		ТЧТовары.Колонки.Добавить("КоличествоУпаковокВОрдере");
		
		МассивЗаказов = Новый Массив;
		МассивЗаказов.Добавить(Выборка.Источник);
		Документы.РеализацияТоваровУслуг.ЗаполнитьПоОстаткамЗаказов(
			ДанныеОтбора,
			ТЧТовары,
			ТаблицаСкидкиНаценки,
			Приемник.Склад,
			МассивЗаказов,
			ПараметрыЗаполнения);
		
		Приемник.Товары.Загрузить(ТЧТовары);
	КонецЕсли;
	
	Если Приемник.Товары.Количество() = 0 Тогда
		ТекстЛогаСобытий = "Документ Реализация товаров и услуг по документу " + Строка(Выборка.Источник) +
			" не создан, т.к. не заполнены товары, возможно документ был сформирован вручную или весь товар по заказу уже реализован.";
		ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Предупреждение", ИмяСобытия);
		МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога); 
		Продолжить;
	КонецЕсли;
	
	// Заполнение этапов графика оплаты.
	Приемник.ЗаполнитьЭтапыГрафикаОплаты();
	
	ОшибокНеОбнаружено = Приемник.ПроверитьЗаполнение();
	Если ОшибокНеОбнаружено Тогда
		НачатьТранзакцию();
		Если ЗначениеЗаполнено(Накладная) И Не НакладнаяПроведена И Не РазделятьРеализации Тогда
			НоваяСсылка = Накладная; 
		Иначе   				
			НоваяСсылка = Документы.РеализацияТоваровУслуг.ПолучитьСсылку(Новый УникальныйИдентификатор);
			Приемник.УстановитьСсылкуНового(НоваяСсылка);
		КонецЕсли;
		
		Попытка
			Приемник.Записать(?(ПроводитьРеализацию, РежимЗаписиДокумента.Проведение, РежимЗаписиДокумента.Запись));

			ВидДокументаПриемник = "Накладная_Исходящая";													
			СтруктураРегистраDR_События = Новый Структура;
			СтруктураРегистраDR_События.Вставить("ИдентификаторЦепочки"		, Выборка.ИдентификаторЦепочки);
			СтруктураРегистраDR_События.Вставить("Документ"					, Приемник.Ссылка);
			СтруктураРегистраDR_События.Вставить("ВидДокумента"				, ВидДокументаПриемник);
			СтруктураРегистраDR_События.Вставить("Идентификатор"			, Приемник.Ссылка.УникальныйИдентификатор());
			СтруктураРегистраDR_События.Вставить("ИдентификаторОснования"	, Выборка.Источник.УникальныйИдентификатор());
			СтруктураРегистраDR_События.Вставить("ДатаЗаписи"				, ТекущаяДата());
			ЭКОМ_ОбщегоНазначения.Записать_DR_События(СтруктураРегистраDR_События);	            
			
		Исключение
			Ошибка = ОписаниеОшибки();
			ТекстОшибки = НСтр("ru = 'Ошибка %РежимЗаписиДокумента% документа на основе входящего документа № %ФайлНомер% от %ФайлДата%. '" + ОписаниеОшибки(), ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
			ТекстОшибки = СтрЗаменить(ТекстОшибки, "%РежимЗаписиДокумента%", ?(ПроводитьРеализацию, "проведения", "записи"));
			ТекстОшибки = СтрЗаменить(ТекстОшибки, "%ФайлНомер%", Выборка.ИсточникНомер);
			ТекстОшибки = СтрЗаменить(ТекстОшибки, "%ФайлДата%", Формат(Выборка.ИсточникДата, "ДФ=dd.MM.yyyy"));
			ЗаписатьЛогСобытий(ЛогСобытий, ТекстОшибки);
			ОтменитьТранзакцию();
			Продолжить;
		КонецПопытки;
		ЗафиксироватьТранзакцию();
		Если ЗначениеЗаполнено(Накладная) И Не РазделятьРеализации И Не НакладнаяПроведена Тогда   
			ТекстЛогаСобытий = "Перезаписан уже существующий документ " + РеализацияПредставление + " по заказу № " + ЗаказНомер + " от " + ЗаказДата;
			ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий,"Успешно", ИмяСобытия);
			МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога); 
		ИначеЕсли РазделятьРеализации И ЗначениеЗаполнено(Выборка.ДокументРеализации) Тогда
			ТекстЛогаСобытий = "Разделена цепочка по заказу " + Строка(Выборка.Источник) + ". Создан документ " + Строка(Приемник.Ссылка) + ".";
			ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Успешно", ИмяСобытия);
			МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога); 
		КонецЕсли; 
		
				
	КонецЕсли;			
	
	// служебные операции ++  
	Если ЗначениеЗаполнено(Приемник.Ссылка) И Не ОперацияЗапись Тогда
		КоличествоСозданныхДокументов = КоличествоСозданныхДокументов + 1;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ЛогСобытий) Тогда
		ТекстЛогаСобытий = ЛогСобытий;
		ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Информация", ИмяСобытия);
		МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
		
	КонецЕсли;  
	// служебные операции --
КонецЦикла;
   </Value>
		<Value xsi:type="xs:string"/>
		<Value xsi:type="xs:string"/>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="ValueListType">
			<valueType/>
			<lastId xsi:type="xs:decimal">3</lastId>
			<item>
				<value xsi:type="xs:string">Прайс-лист</value>
				<id xsi:type="xs:decimal">0</id>
			</item>
			<item>
				<value xsi:type="xs:string">Поставщик</value>
				<presentation>СписокЗаказыВходящие</presentation>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">1</id>
			</item>
			<item>
				<value xsi:type="xs:string">Покупатель</value>
				<id xsi:type="xs:decimal">2</id>
			</item>
			<item>
				<value xsi:type="xs:string">ИмяКнопки</value>
				<presentation>Создать реализацию товаров</presentation>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">3</id>
			</item>
		</Value>
	</row>
</ValueTree>