ТипДокументаУстановкаЦенНоменклатуры = "ДокументСсылка.УстановкаЦенНоменклатуры";
ТипДокументаЭКОМ_Документы = "ДокументСсылка.ЭКОМ_Документы";

// Заказ поставщику
Если ТипЗнч(Источник.Ссылка) = Тип(ТипДокументаУстановкаЦенНоменклатуры) Тогда
            
        Запрос = Новый Запрос;
        Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
                       |	DR_События.ИдентификаторЦепочки КАК ИдентификаторЦепочки
                       |ИЗ
                       |	РегистрСведений.DR_События КАК DR_События
                       |ГДЕ
                       |	DR_События.Документ = &Документ";
        Запрос.УстановитьПараметр("Документ", Источник.Ссылка);
        РезультатЗапроса = Запрос.Выполнить(); 
                                       
        Если РезультатЗапроса.Пустой() Тогда
	        
	        ИдентификаторДокумента = Источник.Ссылка.УникальныйИдентификатор();	
	        
	        ЗапросЦепочки = Новый Запрос;
        	ЗапросЦепочки.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
        	               |	ЭКОМ_Документы.ИдентификаторЦепочки КАК ИдентификаторЦепочки
        	               |ИЗ
        	               |	Документ.ЭКОМ_Документы КАК ЭКОМ_Документы
        	               |ГДЕ
        	               |	ЭКОМ_Документы.Документ1С = &Документ";
        	ЗапросЦепочки.УстановитьПараметр("Документ", Источник.Ссылка);
        	РезультатЗапросаЦепочки = ЗапросЦепочки.Выполнить(); 
	        Если  РезультатЗапросаЦепочки.Пустой() Тогда
	        	         
	        	СтруктураСобытия = Новый Структура("Документ, ВидДокумента, ИдентификаторЦепочки, Идентификатор, Статус" , Источник.Ссылка, Перечисления.ЭКОМ_ВидыДокументов.УстановкаЦенНоменклатуры_Исходящий, ИдентификаторДокумента, ИдентификаторДокумента, Перечисления.ЭКОМ_Статусы.ГотовКотправке); 
	   	        СтруктураЦепочки = Новый Структура("ДатаЗаказа, ИдентификаторЦепочки, ТипОбмена, НомерЗаказа", Источник.Дата, ИдентификаторДокумента, Перечисления.DR_ТипыОбмена.ПрайсЛист, Источник.Номер); 

                ЭКОМ_ОбщегоНазначения.Записать_DR_События(СтруктураСобытия);
	       		ЭКОМ_ОбщегоНазначения.Записать_DR_ЦепочкиДокументов(СтруктураЦепочки); 
	       		
	        Иначе
	            
	            ИдентификаторЦепочки = РезультатЗапросаЦепочки.Выгрузить()[0].ИдентификаторЦепочки;
	            СтруктураСобытия = Новый Структура("Документ, ВидДокумента, ИдентификаторЦепочки, Идентификатор, Статус" , Источник.Ссылка, Перечисления.ЭКОМ_ВидыДокументов.УстановкаЦенНоменклатуры_Исходящий, ИдентификаторЦепочки, ИдентификаторДокумента, Перечисления.ЭКОМ_Статусы.ГотовКотправке); 
	   	        
                ЭКОМ_ОбщегоНазначения.Записать_DR_События(СтруктураСобытия);  

	        КонецЕсли; 
	       	        
        КонецЕсли;                                                                                          
        
КонецЕсли;


// ЭКОМ_Документы
Если ТипЗнч(Источник.Ссылка) = Тип(ТипДокументаЭКОМ_Документы) Тогда
  
  		Запрос = Новый Запрос;	
		Если Источник.ВидДокумента = Перечисления.ЭКОМ_ВидыДокументов.PRICAT_Исходящий 
			И НЕ Источник.УточнениеОПоставке = "9" Тогда				
			// Исходящий ответ на входящий прайс-лист
			Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	ЭКОМ_ДокументыВхПрайс.Ссылка,
			|	ЭКОМ_ДокументыВхПрайс.ВидДокумента,
			|	ВЫБОР
			|		КОГДА ЭКОМ_ДокументыИсхОтвет.УточнениеОПоставке = ""99""
			|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ЭКОМ_Статусы.ОтклоненПолностью)
			|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ЭКОМ_Статусы.Подтвержден)
			|	КОНЕЦ КАК Статус
			|ИЗ
			|	Документ.ЭКОМ_Документы КАК ЭКОМ_ДокументыИсхОтвет
			|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭКОМ_Документы КАК ЭКОМ_ДокументыВхПрайс
			|		ПО ЭКОМ_ДокументыИсхОтвет.ФайлДата = ЭКОМ_ДокументыВхПрайс.ФайлДата
			|			И ЭКОМ_ДокументыИсхОтвет.ФайлНомер = ЭКОМ_ДокументыВхПрайс.ФайлНомер
			|			И (ЭКОМ_ДокументыВхПрайс.ВидДокумента = ЗНАЧЕНИЕ(Перечисление.ЭКОМ_ВидыДокументов.PRICAT_Входящий))
			|ГДЕ
			|	ЭКОМ_ДокументыИсхОтвет.Ссылка = &Ссылка";
			
		ИначеЕсли Источник.ВидДокумента = Перечисления.ЭКОМ_ВидыДокументов.PRICAT_Входящий 
			И НЕ Источник.УточнениеОПоставке = "9" Тогда	
			// Входящий ответ на исходящий прайс-лист		
			Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	ЭКОМ_ДокументыИсхПрайс.Ссылка,
			|	ЭКОМ_ДокументыИсхПрайс.ВидДокумента,
			|	ВЫБОР
			|		КОГДА ЭКОМ_ДокументыВхОтвет.УточнениеОПоставке = ""99""
			|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ЭКОМ_Статусы.ОтклоненПолностью)
			|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ЭКОМ_Статусы.Подтвержден)
			|	КОНЕЦ КАК Статус
			|ИЗ
			|	Документ.ЭКОМ_Документы КАК ЭКОМ_ДокументыВхОтвет
			|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭКОМ_Документы КАК ЭКОМ_ДокументыИсхПрайс
			|		ПО ЭКОМ_ДокументыВхОтвет.ФайлДата = ЭКОМ_ДокументыИсхПрайс.ФайлДата
			|			И ЭКОМ_ДокументыВхОтвет.ФайлНомер = ЭКОМ_ДокументыИсхПрайс.ФайлНомер
			|			И (ЭКОМ_ДокументыИсхПрайс.ВидДокумента = ЗНАЧЕНИЕ(Перечисление.ЭКОМ_ВидыДокументов.PRICAT_Исходящий))
			|ГДЕ
			|	ЭКОМ_ДокументыВхОтвет.Ссылка = &Ссылка";			
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Запрос.Текст) Тогда
			Запрос.УстановитьПараметр("Ссылка", Источник.Ссылка);
			РезультатЗапроса = Запрос.Выполнить();		
			Выборка = РезультатЗапроса.Выбрать();
			Выборка.Следующий();
			Если ЗначениеЗаполнено(Выборка.Ссылка) Тогда
				
				СтруктураРегистраDR_События = Новый Структура;
				СтруктураРегистраDR_События.Вставить("ИдентификаторЦепочки"		, Источник.ИдентификаторЦепочки);
				СтруктураРегистраDR_События.Вставить("Документ"					, Источник.Ссылка);
				СтруктураРегистраDR_События.Вставить("ВидДокумента"				, Источник.ВидДокумента);
				СтруктураРегистраDR_События.Вставить("Идентификатор"			, Источник.Ссылка.УникальныйИдентификатор());
				СтруктураРегистраDR_События.Вставить("ИдентификаторОснования"	, Источник.ИдентификаторЦепочки);
				СтруктураРегистраDR_События.Вставить("ДатаЗаписи"				, ТекущаяДата());
				СтруктураРегистраDR_События.Вставить("Статус"					, Выборка.Статус);
				
				ЭКОМ_ОбщегоНазначения.Записать_DR_События(СтруктураРегистраDR_События);			

			КонецЕсли;
		КонецЕсли;
	                                                                                 
        
КонецЕсли;