ТипДокументаЗаказа = "ДокументСсылка.ЗаказПоставщику";
ТипДокументаПоступления = "ДокументСсылка.ПоступлениеТоваровУслуг";
ТипДокументаСчетФактуры = "ДокументСсылка.СчетФактураПолученный";
ТипДокументаВозвратПоставщику = "ДокументСсылка.ВозвратТоваровПоставщику";
ТипДокументаКорректировкаПоступления = "ДокументСсылка.КорректировкаПоступления";

ИмяОрганизации = "Организация";
ИмяКонтрагента = "Контрагент";
ИмяТочкиДоставки = "Склад";
ИмяТочкиДоставкиКПТУ = "СкладОрдер";
ИмяДатаПоставки = "ЖелаемаяДатаПоступления";
ДатаЗаказа1С = "ДатаПоДаннымКлиента";
НомерЗаказа1С = "НомерПоДаннымКлиента";
НомерВходящегоДокумента = "НомерВходящегоДокумента";
ДатаВходящегоДокумента = "ДатаВходящегоДокумента";
ИмяЗаказа1С = "ЗаказПоставщику";
ОснованиеВозвратаПоставщику = "ДокументПоступления";

// Заказ поставщику
Если ТипЗнч(Источник.Ссылка) = Тип(ТипДокументаЗаказа) Тогда
    
    ВыборкаУчастниковВЭДО = DR_EDI_ОбщегоНазначения.КонтрагентУчаствуетВЭДО(Источник[ИмяОрганизации], Источник[ИмяКонтрагента], Источник[ИмяТочкиДоставки]);
    Если ВыборкаУчастниковВЭДО.Количество() > 0 Тогда          
          
        Запрос = Новый Запрос;
        Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
                       |	DR_События.ИдентификаторЦепочки КАК ИдентификаторЦепочки
                       |ИЗ
                       |	РегистрСведений.DR_События КАК DR_События
                       |ГДЕ
                       |	DR_События.Документ = &Документ";
        Запрос.УстановитьПараметр("Документ", Источник.Ссылка);
        РезультатЗапроса = Запрос.Выполнить(); 
                                       
        Если РезультатЗапроса.Пустой() Тогда
	        ИдентификаторДокумента = Источник.Ссылка.УникальныйИдентификатор();
	         
	        СтруктураСобытия = Новый Структура("Документ, ВидДокумента, ИдентификаторЦепочки, Идентификатор, Статус, ДатаЗаписи" , Источник.Ссылка, "Заказ_Исходящий", ИдентификаторДокумента, 
	        	ИдентификаторДокумента, "ГотовКотправке", ТекущаяДата()); 
	        
	        СтруктураЦепочки = Новый Структура("ДатаЗаказа, ИдентификаторЦепочки, ДатаПоставки, НомерЗаказа, Организация, Контрагент, ТочкаДоставки", Источник.Дата, ИдентификаторДокумента,  
	        Источник.ДатаПоступления, Источник.Номер, Источник[ИмяОрганизации], Источник[ИмяКонтрагента], Источник[ИмяТочкиДоставки]); 
	        
	        DR_EDI_ОбщегоНазначения.Записать_DR_События(СтруктураСобытия);
	        DR_EDI_ОбщегоНазначения.Записать_DR_ЦепочкиДокументов(СтруктураЦепочки); 
        КонецЕсли;           
                                                                                
    КонецЕсли;
    
КонецЕсли;

//КорректировкаПоступления
Если ТипЗнч(Источник) = Тип(ТипДокументаКорректировкаПоступления) Тогда
    
    ВыборкаУчастниковВЭДО = DR_EDI_ОбщегоНазначения.КонтрагентУчаствуетВЭДО(Источник[ИмяОрганизации], Источник[ИмяКонтрагента], Источник[ИмяТочкиДоставкиКПТУ]);
    Если НЕ ВыборкаУчастниковВЭДО.Количество() = 0 Тогда
       
        Запрос = Новый Запрос;
        Запрос.Текст = "ВЫБРАТЬ
                       |	DR_События.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
                       |	DR_События.Идентификатор КАК Идентификатор
                       |ИЗ
                       |	РегистрСведений.DR_События КАК DR_События
                       |ГДЕ
                       |	DR_События.Документ = &Документ
                       |	И DR_События.ВидДокумента = &ВидыДокументов";
        
        Запрос.УстановитьПараметр("Документ",		Источник);
        Запрос.УстановитьПараметр("ВидыДокументов",	"КорректировочнаяНакладная_входящая");        
        РезультатЗапроса = Запрос.Выполнить();                   
                                       
        Если РезультатЗапроса.Пустой() Тогда
             
            //Ищем по основанию, документ основание должен быть в цепочке
	        Запрос.УстановитьПараметр("Документ",		Источник.ДокументОснование);
	        Запрос.УстановитьПараметр("ВидыДокументов", "Накладная_входящая");
	        РезультатЗапроса = Запрос.Выполнить();
            
            Если НЕ РезультатЗапроса.Пустой() Тогда
		        
		        Выборка = РезультатЗапроса.Выбрать(); 
			    Выборка.Следующий();
                                              
                //добавим новую запись
                ИдентификаторОснования = ?(ЗначениеЗаполнено(Выборка.Идентификатор), Выборка.Идентификатор,"");
		               	
	           	СтруктураРегистраDR_События = Новый Структура;
				СтруктураРегистраDR_События.Вставить("ИдентификаторЦепочки"		, Выборка.ИдентификаторЦепочки);
				СтруктураРегистраDR_События.Вставить("Документ"					, Источник);
				СтруктураРегистраDR_События.Вставить("ВидДокумента"				, "КорректировочнаяНакладная_Входящая");
				СтруктураРегистраDR_События.Вставить("Идентификатор"			, Строка(Источник.УникальныйИдентификатор()));
				СтруктураРегистраDR_События.Вставить("ИдентификаторОснования"	, ИдентификаторОснования);
				СтруктураРегистраDR_События.Вставить("ДатаЗаписи"				, ТекущаяДата());
				
				DR_EDI_ОбщегоНазначения.Записать_DR_События(СтруктураРегистраDR_События);
                
            КонецЕсли;
            
        КонецЕсли;
        
     КонецЕсли;     
          
КонецЕсли;