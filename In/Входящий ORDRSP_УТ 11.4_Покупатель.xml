<ValueTree xmlns="http://v8.1c.ru/8.1/data/core" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ValueTree">
	<column>
		<Name xsi:type="xs:string">Использовать</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">ТипТранзакции</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Служебные</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">СлужебныеТекст</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Сохранение</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Загрузка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Кнопка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">КоллекцияТЧ</Name>
		<ValueType/>
	</column>
	<row>
		<Value xsi:type="xs:boolean">true</Value>
		<Value xsi:type="xs:string">Входящий ORDRSP</Value>
		<Value xsi:type="xs:string">//ВыполнитьГибкиеНастройкиORDRSP(, МассивЛогаСобытий, ИмяСобытия);

ТипДокумента = "ORDRSP";	
	ТипДокументооборота      = "EDI";
	ИдентификаторыУчастников = Новый Массив;
	ЕстьОшибкаПолученияИдентификаторов = Ложь;
	
	#Область ПолучениеИдентификаторовЦепочекПоВсемПрофилям	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЭКОМ_GLN.ПрофильОбмена КАК ПрофильОбмена,
	|	ЭКОМ_GLN.Объект КАК Организация,
	|	ЭКОМ_GLN.GLN КАК GLN,
	|	ЭКОМ_GLN.Ид_ОЭД КАК ИдУчастника
	|ИЗ
	|	РегистрСведений.ЭКОМ_GLN КАК ЭКОМ_GLN
	|ГДЕ
	|	НЕ ЭКОМ_GLN.ПрофильОбмена = НЕОПРЕДЕЛЕНО
	|	И НЕ ЭКОМ_GLN.ПрофильОбмена.ПометкаУдаления
	|ИТОГИ ПО
	|	ПрофильОбмена";
	
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		ТаблицаДокументовAPI = Новый ТаблицаЗначений;
		ТаблицаДокументовAPI.Колонки.Добавить("chainID"    , Новый ОписаниеТипов("Строка",,,, Новый КвалификаторыСтроки(36)));
		ТаблицаДокументовAPI.Колонки.Добавить("ftpFileName", Новый ОписаниеТипов("Строка",,,, Новый КвалификаторыСтроки(50)));
		ТаблицаДокументовAPI.Колонки.Добавить("docUUID"    , Новый ОписаниеТипов("Строка",,,, Новый КвалификаторыСтроки(36)));
		ТаблицаДокументовAPI.Колонки.Добавить("date"       , Новый ОписаниеТипов("Строка",,,, Новый КвалификаторыСтроки(36)));
		ТаблицаДокументовAPI.Индексы.Добавить("docUUID");
		
		ВыборкаПрофильОбмена = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		
		Пока ВыборкаПрофильОбмена.Следующий() Цикл
			
			ПрофильОбмена = ВыборкаПрофильОбмена.ПрофильОбмена;	
			
			#Область ПолучениеСпискаИдентификаторовПоПрофилюОбмена
			
			ЗапросИдентификаторов = Новый Запрос;
			ЗапросИдентификаторов.Текст ="ВЫБРАТЬ
			|	ЭКОМ_GLN.GLN КАК ИдентификаторУчастника
			|ИЗ
			|	РегистрСведений.ЭКОМ_GLN КАК ЭКОМ_GLN
			|ГДЕ
			|	ЭКОМ_GLN.ПрофильОбмена = &amp;ПрофильОбмена";
			ЗапросИдентификаторов.УстановитьПараметр("ПрофильОбмена", ПрофильОбмена);
			ЗапросИдентификаторов.УстановитьПараметр("ТипДокументооборота", ТипДокументооборота);
			ВыборкаИдентификаторов = ЗапросИдентификаторов.Выполнить().Выбрать();
			Пока ВыборкаИдентификаторов.Следующий() Цикл
				ИдентификаторыУчастников.Добавить(ВыборкаИдентификаторов.ИдентификаторУчастника);	 
			КонецЦикла; 
			
			#КонецОбласти
			
			#Область ПодготовкаВспомогательныхДанныхДляRestApi
			
			ИмяСобытия = "Заполнение идентификаторов цепочки для входящих файлов " + ТипДокумента + ".";  		
			ЛимитСообщений = ЭКОМ_ОбщегоНазначения.Настройка_Параметр_Прочитать("ЭКОМ_ЛимитСообщенийRESTv2", "1000");
			ДанныеДляREST = Новый Структура("ЕстьОшибка, ВидДокумента, ДанныеПодключения, doc_type", Ложь, Неопределено, Неопределено, Неопределено); 
			
			ДанныеДляREST.ВидДокумента 	=  "ORDRSP_Входящий";
			ДанныеДляREST.doc_type 		= "ordrsp";
			
			ДанныеАвторизации = ЭКОМ_ВзаимодействиеREST_API.ВыполнитьАвторизациюАтолл(ПрофильОбмена);
			Если Не ДанныеАвторизации.Получены Тогда
				ТекстЛогаСобытий = "Не удалось выполнить авторизацию. ";
				ДобавитьЗаписьВМассивЛога(МассивЛогаСобытий, ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
				ДанныеДляREST.ЕстьОшибка = Истина;
			КонецЕсли;	
			ДанныеПодключения = ЭКОМ_ВзаимодействиеREST_API.ПолучитьДанныеПодключенияEvolution(ПрофильОбмена);
			Если Не ДанныеПодключения.ПолученПрофиль ИЛИ Не ДанныеПодключения.ПолученТокен Тогда
				ТекстЛогаСобытий = "Не удалось получить данные для подключения к REST API. ";
				ДобавитьЗаписьВМассивЛога(МассивЛогаСобытий, ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
				ДанныеДляREST.ЕстьОшибка = Истина;
			КонецЕсли;
			ДанныеДляREST.ДанныеПодключения = ДанныеПодключения;	
			
			#КонецОбласти
			
			#Область ПолучитьИдентификаторыЦепочекВходящихФайлов
			
			Если Не ДанныеДляREST.ЕстьОшибка Тогда	
				НачалоПериода = Дата(1,1,1);
				Запрос = Новый Запрос;
				Запрос.Текст = "ВЫБРАТЬ
				|	МАКСИМУМ(DR_События.ДатаСообщения) КАК ДатаПоследнегоСообщения
				|ИЗ
				|	РегистрСведений.DR_События КАК DR_События
				|ГДЕ
				|	DR_События.ВидДокумента = &amp;ВидДокумента
				|	И DR_События.АктуализироватьИдентификатор = ЛОЖЬ";
				
				Запрос.УстановитьПараметр("ВидДокумента", ДанныеДляREST.ВидДокумента);
				ВыборкаДата = Запрос.Выполнить().Выбрать();
				Если ВыборкаДата.Следующий() Тогда
					НачалоПериода = ВыборкаДата.ДатаПоследнегоСообщения;
				КонецЕсли;   
				
				МинимальнаяДата =  НачалоПериода;
				Сутки         = 60*60*24;
				ТекущаяДата   = ТекущаяДата(); 
				Если ЗначениеЗаполнено(МинимальнаяДата) Тогда
					МинимальнаяДата = МинимальнаяДата - Сутки;
				Иначе
					МинимальнаяДата = ТекущаяДата - Сутки * 30;					
				КонецЕсли;         
				МаксимальнаяДата =  ТекущаяДата + Сутки; 
				
				НачалоПериода = Формат(МинимальнаяДата , "ДФ=yyyy-MM-dd");
				КонецПериода  = Формат(МаксимальнаяДата, "ДФ=yyyy-MM-dd");  	
				
				ВсеСообщенияAPI  = Новый Массив;
				
				Для Каждого ИдУчастника Из ИдентификаторыУчастников Цикл
					ПараметрыМетода = Новый Структура("gln, doc_type, time_from, time_to, limit, direction", ИдУчастника, ДанныеДляREST.doc_type, НачалоПериода, КонецПериода, ЛимитСообщений, "0");
					МассивСообщенийAPI = ЭКОМ_ВзаимодействиеREST_API.ПолучитьСписокВходящихДокументовEDI(ПараметрыМетода, ДанныеПодключения);
					
					Для Каждого Сообщение Из МассивСообщенийAPI Цикл
						ВсеСообщенияAPI.Добавить(Сообщение);
					КонецЦикла;
				КонецЦикла;
				
				Для Каждого Соответствие Из ВсеСообщенияAPI Цикл
					НовСтр = ТаблицаДокументовAPI.Добавить();
					НовСтр.chainID     = Соответствие.Получить("chainID");
					НовСтр.ftpFileName = Соответствие.Получить("ftpFileName");
					НовСтр.docUUID     = Соответствие.Получить("docUUID");
					НовСтр.date        = Соответствие.Получить("date");
				КонецЦикла;
			Иначе
				ЕстьОшибкаПолученияИдентификаторов = Истина;
			КонецЕсли
			#КонецОбласти
			
		КонецЦикла;
	КонецЕсли;
	
	#КонецОбласти
	
	Если Не ЕстьОшибкаПолученияИдентификаторов Тогда
	
			
		/////////////////////////////////////////////////////////////////////////////////
		//          					ВХОДЯЩИЙ ORDRSP                                //
		/////////////////////////////////////////////////////////////////////////////////
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	DR_Документ.Ссылка КАК DR_Документ,
		|	ПРЕДСТАВЛЕНИЕ(DR_Документ.Ссылка) КАК Представление,
		|	DR_Документ.Статус КАК СтатусДокумента,
		|	DR_Документ.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
		|	DR_Документ.ИдентификаторДокумента КАК ИдентификаторДокумента
		|ИЗ
		|	Документ.DR_Документ КАК DR_Документ
		|ГДЕ
		|	DR_Документ.ИдентификаторЦепочки В(&amp;ИдентификаторЦепочки)
		|	И DR_Документ.ИдентификаторДокумента В(&amp;ИдентификаторДокумента)
		|	И НЕ DR_Документ.ПометкаУдаления
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	DR_Документ.Ссылка КАК Ссылка,
		|	DR_Документ.ДанныеФайла КАК ДанныеФайла,
		|	DR_Документ.Статус КАК Статус,
		|	DR_Документ.ИдентификаторДокумента КАК ИдентификаторДокумента
		|ПОМЕСТИТЬ ВТ_Загружен
		|ИЗ
		|	Документ.DR_Документ КАК DR_Документ
		|ГДЕ
		|	DR_Документ.Статус = &amp;Загружен
		|	И DR_Документ.ВидДокумента = &amp;ВидДокумента
		|	И НЕ DR_Документ.ПометкаУдаления
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Загружен.Ссылка КАК DR_Документ,
		|	ПРЕДСТАВЛЕНИЕ(ВТ_Загружен.Ссылка) КАК Представление,
		|	ВТ_Загружен.ДанныеФайла КАК ДанныеФайла,
		|	ВТ_Загружен.Статус КАК СтатусДокумента,
		|	ВТ_Загружен.ИдентификаторДокумента КАК ИдентификаторДокумента,
		|	ТЧ_ДатаФайла.Значение КАК ДатаФайла,
		|	ТЧ_ФайлЗагруженЛокально.Значение КАК ФайлЗагруженЛокально
		|ИЗ
		|	ВТ_Загружен КАК ВТ_Загружен
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ДатаФайла
		|		ПО ВТ_Загружен.Ссылка = ТЧ_ДатаФайла.Ссылка
		|			И (ТЧ_ДатаФайла.Реквизит = ""ДатаФайла"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ФайлЗагруженЛокально
		|		ПО ВТ_Загружен.Ссылка = ТЧ_ФайлЗагруженЛокально.Ссылка
		|			И (ТЧ_ФайлЗагруженЛокально.Реквизит = ""ФайлЗагруженЛокально"")
		|
		|УПОРЯДОЧИТЬ ПО
		|	ДатаФайла,
		|	ИдентификаторДокумента
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	DR_Документ.Ссылка КАК Ссылка,
		|	DR_Документ.Комментарий КАК Комментарий,
		|	DR_Документ.ИдентификаторДокумента КАК ИдентификаторДокумента,
		|	DR_Документ.ИдентификаторЦепочки КАК ИдентификаторЦепочки
		|ПОМЕСТИТЬ ВТ_НеОбработан
		|ИЗ
		|	Документ.DR_Документ КАК DR_Документ
		|ГДЕ
		|	DR_Документ.Статус = &amp;НеОбработан
		|	И DR_Документ.ВидДокумента = &amp;ВидДокумента
		|	И НЕ DR_Документ.ПометкаУдаления
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_НеОбработан.Ссылка КАК DR_Документ,
		|	ВТ_НеОбработан.Комментарий КАК Комментарий,
		|	ВТ_НеОбработан.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
		|	ВТ_НеОбработан.ИдентификаторДокумента КАК ИдентификаторДокумента,
		|	ВЫРАЗИТЬ(ТЧ_NUMBER.Значение КАК СТРОКА(35)) КАК NUMBER,
		|	ТЧ_HEAD.ХранилищеЗначения КАК HEAD,
		|	ВЫРАЗИТЬ(ТЧ_Организация.Значение КАК Справочник.Организации) КАК Организация,
		|	ВЫРАЗИТЬ(ТЧ_Контрагент.Значение КАК Справочник.Контрагенты) КАК Контрагент,
		|	ТЧ_ТочкаДоставки.Значение КАК ТочкаДоставки,
		|	ВЫРАЗИТЬ(ТЧ_ЗаполнитьУчастниковЭДО.Значение КАК БУЛЕВО) КАК ЗаполнитьУчастниковЭДО,
		|	ВЫРАЗИТЬ(ТЧ_ДатаЭлектронногоДокумента.Значение КАК ДАТА) КАК ДатаЭлектронногоДокумента,
		|	ВЫРАЗИТЬ(ТЧ_ДатаПоставки.Значение КАК ДАТА) КАК ДатаПоставки,
		|	ВЫРАЗИТЬ(ТЧ_ДатаЗаказа.Значение КАК ДАТА) КАК ДатаЗаказа
		|ИЗ
		|	ВТ_НеОбработан КАК ВТ_НеОбработан
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_NUMBER
		|		ПО ВТ_НеОбработан.Ссылка = ТЧ_NUMBER.Ссылка
		|			И (ТЧ_NUMBER.Реквизит = ""NUMBER"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_HEAD
		|		ПО ВТ_НеОбработан.Ссылка = ТЧ_HEAD.Ссылка
		|			И (ТЧ_HEAD.Реквизит = ""HEAD"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_Организация
		|		ПО ВТ_НеОбработан.Ссылка = ТЧ_Организация.Ссылка
		|			И (ТЧ_Организация.Реквизит = ""Организация"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_Контрагент
		|		ПО ВТ_НеОбработан.Ссылка = ТЧ_Контрагент.Ссылка
		|			И (ТЧ_Контрагент.Реквизит = ""Контрагент"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ТочкаДоставки
		|		ПО ВТ_НеОбработан.Ссылка = ТЧ_ТочкаДоставки.Ссылка
		|			И (ТЧ_ТочкаДоставки.Реквизит = ""ТочкаДоставки"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ЗаполнитьУчастниковЭДО
		|		ПО ВТ_НеОбработан.Ссылка = ТЧ_ЗаполнитьУчастниковЭДО.Ссылка
		|			И (ТЧ_ЗаполнитьУчастниковЭДО.Реквизит = ""ЗаполнитьУчастниковЭДО"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ДатаЭлектронногоДокумента
		|		ПО ВТ_НеОбработан.Ссылка = ТЧ_ДатаЭлектронногоДокумента.Ссылка
		|			И (ТЧ_ДатаЭлектронногоДокумента.Реквизит = ""ДатаЭлектронногоДокумента"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ДатаПоставки
		|		ПО ВТ_НеОбработан.Ссылка = ТЧ_ДатаПоставки.Ссылка
		|			И (ТЧ_ДатаПоставки.Реквизит = ""ДатаПоставки"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ДатаЗаказа
		|		ПО ВТ_НеОбработан.Ссылка = ТЧ_ДатаЗаказа.Ссылка
		|			И (ТЧ_ДатаЗаказа.Реквизит = ""ДатаЗаказа"")";
		
		//&lt;Полученный список ID раскладываем по массивам для передачи их ввиде параметров в запрос&gt;
		DocUUID_API = ТаблицаДокументовAPI.ВыгрузитьКолонку("docUUID");
		ChainID_API = ТаблицаДокументовAPI.ВыгрузитьКолонку("chainID");
				
		Запрос.УстановитьПараметр("ВидДокумента"			, ТипДокумента + "_входящий");
		Запрос.УстановитьПараметр("Загружен"				, "Загружен");
		Запрос.УстановитьПараметр("НеОбработан"				, "НеОбработан");
		Запрос.УстановитьПараметр("ИдентификаторЦепочки"	, ChainID_API);
		Запрос.УстановитьПараметр("ИдентификаторДокумента"	, DocUUID_API);
		
		МассивРезультатов = Запрос.ВыполнитьПакет();
		
		//&lt;Таблица используется для поиска Дублей&gt;
		ТаблицаDR_ДокументовПоID  = МассивРезультатов[0].Выгрузить();
		
		//&lt;Таблица DR_Документов со статусом "Загружен"&gt;
		ТаблицаЗагруженных	= МассивРезультатов[2].Выгрузить();
		
		//&lt;Инициализация массива примитивных типов&gt;
		ПримитивныеТипы = Новый Массив;
		ПримитивныеТипы.Добавить(Тип("Строка"));
		ПримитивныеТипы.Добавить(Тип("Число"));		
		
		//&lt;Инициализация квалификаторов&gt;
		КвалификаторСтрока	= Новый КвалификаторыСтроки(200);
		КвалификаторЧисло 	= Новый КвалификаторыЧисла(15, 3, ДопустимыйЗнак.Неотрицательный);
		
		//&lt;Создание описателей типов&gt;
		ОписаниеПримитивныхТипов 	= Новый ОписаниеТипов(ПримитивныеТипы,,,КвалификаторЧисло,КвалификаторСтрока);
		ОписаниеТипаТЗ 				= Новый ОписаниеТипов("ТаблицаЗначений");
		ОписаниеТиповНоменклатура 	= Новый ОписаниеТипов("СправочникСсылка.Номенклатура");
		ОписаниеТиповХарактеристи 	= Новый ОписаниеТипов("СправочникСсылка.ХарактеристикиНоменклатуры");
		
		МассивТиповЕдИзм = Новый Массив;
		ИмяОбъектов 	 = Новый Массив;
		ИмяОбъектов.Добавить("УпаковкиЕдиницыИзмерения");
		ИмяОбъектов.Добавить("КлассификаторЕдиницИзмерения");
		ИмяОбъектов.Добавить("ЕдиницыИзмерения");
		
		Для каждого ИмяСпр Из ИмяОбъектов Цикл
			Если Метаданные.Справочники.Найти(ИмяСпр) &lt;&gt; Неопределено Тогда
				МассивТиповЕдИзм.Добавить(Тип("СправочникСсылка." + ИмяСпр));		
			КонецЕсли;
		КонецЦикла;
			
		ОписаниеТиповЕдИзм 	= Новый ОписаниеТипов(МассивТиповЕдИзм);
		
		//&lt;Элементы по спецификации множественные, т.е. могут в ORDRSP переданы несколько раз. 
		//В созданной структуре будут иметь тип Таблица значений не зависимо от их количества в электронном документе&gt;
		ЭлементыТипаТЗ = Новый Массив;
		ЭлементыТипаТЗ.Добавить("LIMES");
		ЭлементыТипаТЗ.Добавить("SELFSHIPLIMES");
		ЭлементыТипаТЗ.Добавить("POSITION");   
		ЭлементыТипаТЗ.Добавить("PACKING");
		
		//&lt;В таблицу добавляются данные по распарсенным XML&gt;
		ТаблицаНовДокументов = Новый ТаблицаЗначений;
		ТаблицаНовДокументов.Колонки.Добавить("ChainID");         //Тип - Строка
		ТаблицаНовДокументов.Колонки.Добавить("DocUUID");         //Тип - Строка
		ТаблицаНовДокументов.Колонки.Добавить("ДатаФайла");       //Тип - Дата
		ТаблицаНовДокументов.Колонки.Добавить("ДанныеДокумента"); //Тип - Структура
		
		//&lt;Создание индекса для поиска по таблице&gt;
		ТаблицаНовДокументов.Индексы.Добавить("DocUUID");
		
		//&lt;Получение значения доп. константы&gt;
		СрокПовторнойОбработки = Настройка_Параметр_Прочитать("СрокПовторнойОбработкиДокументов", 2);
		
		#Область СозданиеКоллекцииДанныхПоНовымДокументам
		
		Для каждого СтрокаТаблицы ИЗ ТаблицаЗагруженных Цикл
			
			//&lt;Тип - Структура&gt;
			ДанныеДокумента = Новый Структура;	
			ДанныеФайла 	= Новый Структура;
			ПараметрыОтбора = Новый Структура;
			
			//&lt;Тип - Строка&gt;
			Комментарий = "";
			
			//&lt;Получение данных XML&gt;
			Попытка
				
				ДвоичныеДанныеФайла = СтрокаТаблицы.ДанныеФайла.Получить();	
				ИмяВременногоФайла = ПолучитьИмяВременногоФайла("xml");
				
				Если ЗначениеЗаполнено(ДвоичныеДанныеФайла) Тогда					
					ДвоичныеДанныеФайла.Записать(ИмяВременногоФайла);					
				Иначе					
					ТекстЛогаСобытий = СтрокаТаблицы.Представление + "не обработан. Причина: отсутствуют Двоичные данные XML";
					ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Предупреждение", ИмяСобытия);
					МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
					
					Продолжить;
				КонецЕсли;
				
			Исключение				
				ТекстЛогаСобытий = СтрокаТаблицы.Представление + "не обработан." + "Описание ошибки: " + ОписаниеОшибки();
				ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Предупреждение", ИмяСобытия);				
				ЗаписьЖурналаРегистрации(НСтр("ru = 'Обработка ""Интеграция Docrobot""'"), УровеньЖурналаРегистрации.Ошибка, , , ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
				
				Продолжить;	
			КонецПопытки;
			
			ТекущийФайл = Новый Файл(ИмяВременногоФайла);
			
			КодировкаXML = "UTF-8";
			ЧтениеXMLДляТекущегоФайла = ПолучитьЧтениеXMLДляФайла(ТекущийФайл.Имя, ТекущийФайл, КодировкаXML, МассивЛогаСобытий); 							
			Если ЧтениеXMLДляТекущегоФайла = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			ОбъектXDTO = Неопределено;
			ОбъектXDTO = ФабрикаXDTO.ПрочитатьXML(ЧтениеXMLДляТекущегоФайла);
			
			//&lt;Преобразование данных из XDTO в Структуру - "ДанныеФайла"&gt;
			Если ОбъектXDTO &lt;&gt; Неопределено Тогда
				РекурсивноПостроитьСтруктуруEDI(ОбъектXDTO, ЭлементыТипаТЗ, ДанныеФайла, ОписаниеПримитивныхТипов, ОписаниеТипаТЗ);
			Иначе
				Продолжить;
			КонецЕсли;
			
			ЧтениеXMLДляТекущегоФайла.Закрыть();
			
			//&lt;Удаление временного файл&gt;
			Попытка
				УдалитьФайлы(ИмяВременногоФайла);
			Исключение				
				ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), "Предупреждение", ИмяСобытия);
				МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);				
				ЗаписьЖурналаРегистрации(НСтр("ru = 'Обработка ""Интеграция Docrobot""'"), УровеньЖурналаРегистрации.Ошибка, , , ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));				
			КонецПопытки;
			
			//&lt;Поиск ID цепочки по ID эл.документа&gt;
			НайденнаяСтрока = ТаблицаДокументовAPI.Найти(СтрокаТаблицы.ИдентификаторДокумента, "docUUID");
			
			//&lt;Найденный ID цепочки присваиваем эл. документу&gt;
			Если НайденнаяСтрока &lt;&gt; Неопределено Тогда
				
				ДатаAPI = СтрЗаменить(НайденнаяСтрока.date, "-", "");
				ДатаAPI = СтрЗаменить(ДатаAPI, ":", "");
				ДатаAPI = СтрЗаменить(ДатаAPI, " ", "");
				
				ДанныеДокумента.Вставить("ИдентификаторЦепочки", НайденнаяСтрока.chainID);
				ДанныеДокумента.Вставить("ДатаСообщения", Дата(ДатаAPI));
				
			ИначеЕсли СтрокаТаблицы.ФайлЗагруженЛокально = Истина Тогда
				ДанныеДокумента.Вставить("ИдентификаторЦепочки", "TMP_" + СтрокаТаблицы.ИдентификаторДокумента);
				ДанныеДокумента.Вставить("ДатаСообщения", ТекущаяДата());
				
			Иначе
				Комментарий = "По ORDRSP (Подтверждение заказа) № " + ДанныеФайла.NUMBER + " не найден идентификатор цепочки в списке полученных идентификаторов с сервера.";	
				 
				DR_ДокументОбъект = СтрокаТаблицы.DR_Документ.ПолучитьОбъект();
				DR_ДокументОбъект.Комментарий = Комментарий;
				DR_ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
				
				ТекстЛогаСобытий = СтрокаТаблицы.Представление + " не обработан. Причина: " + Комментарий;
				ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
				МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
				
				Продолжить;				
			КонецЕсли;
			
			//&lt;Параметры отбора для поиска дублей&gt;
			ПараметрыОтбора.Вставить("ИдентификаторЦепочки", ДанныеДокумента.ИдентификаторЦепочки);
			ПараметрыОтбора.Вставить("ИдентификаторДокумента", СтрокаТаблицы.ИдентификаторДокумента);
			
			//&lt;Поиск дублей. РезультатПоиска - тип Массив&gt;
			РезультатПоиска = ТаблицаDR_ДокументовПоID.НайтиСтроки(ПараметрыОтбора);
			
			//&lt;Проверка на дубли по DR_Документам со статусом "Обработан" или "Не обработан" по установленному отбору&gt;
			Если НЕ РезультатПоиска.Количество() = 0 Тогда
				
				ЭлементМассива = РезультатПоиска[0];
				
				Если ВРег(ЭлементМассива.СтатусДокумента) = "НЕОБРАБОТАН" 
					ИЛИ ВРег(ЭлементМассива.СтатусДокумента) = "ОБРАБОТАН" Тогда 
					
					//&lt;Для Нового DR_Документа изменяем статус&gt;
					DR_ДокументОбъект = СтрокаТаблицы.DR_Документ.ПолучитьОбъект();
					DR_ДокументОбъект.Статус = "Архивный";
					DR_ДокументОбъект.ДанныеФайла = Новый ХранилищеЗначения(Неопределено);
					DR_ДокументОбъект.Комментарий = "Документ является дублем по ранее созданному " + ЭлементМассива.Представление;
					
					ТабличнаяЧасть = DR_ДокументОбъект.ДополнительныеРеквизиты;
					
					НовСтр = ТабличнаяЧасть.Добавить();
					НовСтр.Реквизит = "НеОбрабатывать";
					НовСтр.Значение = Истина;
					DR_ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
					
					Причина = "Документ является дублем по ранее созданному " + ЭлементМассива.Представление; 
					ТекстЛогаСобытий = СтрокаТаблицы.Представление + " не обработан. Причина: " + Причина;
					ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Предупреждение", ИмяСобытия);
					МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
					
					Продолжить;					
				КонецЕсли;
				
			КонецЕсли;
			
			//&lt;Проверка дублей по DR_Документам со статусом "Загружен"&gt; 
			ЭлементКоллекции = ТаблицаНовДокументов.Найти(СтрокаТаблицы.ИдентификаторДокумента, "DocUUID");
			
			Если ЭлементКоллекции &lt;&gt; Неопределено Тогда
				
				//&lt;Изменям статус DR_Документа определенного как дубль&gt;
				DR_ДокументСсылка = ЭлементКоллекции.ДанныеДокумента.DR_Документ; 
				DR_ДокументОбъект = DR_ДокументСсылка.ПолучитьОбъект();
				DR_ДокументОбъект.Статус = "Архивный";
				DR_ДокументОбъект.ДанныеФайла = Новый ХранилищеЗначения(Неопределено);
				DR_ДокументОбъект.Комментарий = "Документ определен как дубль";
				
				ТабличнаяЧасть = DR_ДокументОбъект.ДополнительныеРеквизиты;
				
				НовСтр = ТабличнаяЧасть.Добавить();
				НовСтр.Реквизит = "НеОбрабатывать";
				НовСтр.Значение = Истина;
				DR_ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
				
				ТекстЛогаСобытий =  "В процессе обработки " + СтрокаТаблицы.Представление + ". " + Строка(DR_ДокументСсылка) + " определен как дубль и обработан не будет.";
				ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Предупреждение", ИмяСобытия);
				МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
				
				//&lt;Удаляем найденную запись из таблицы&gt;
				ТаблицаНовДокументов.Удалить(ЭлементКоллекции);
				
			КонецЕсли;
			
			ДанныеДокумента.Вставить("ИдентификаторДокумента"	, СтрокаТаблицы.ИдентификаторДокумента);
			ДанныеДокумента.Вставить("DR_Документ"				, СтрокаТаблицы.DR_Документ);
			ДанныеДокумента.Вставить("Статус"					, СтрокаТаблицы.СтатусДокумента);
			ДанныеДокумента.Вставить("ДанныеФайла"				, ДанныеФайла);
			ДанныеДокумента.Вставить("ДатаФайла"				, СтрокаТаблицы.ДатаФайла);
			
			//&lt;Классификатор валют&gt;
			КлассификаторВалюты = Новый Соответствие;
			КлассификаторВалюты.Вставить("RUB"	,643);
			КлассификаторВалюты.Вставить("KZT"	,398);
			КлассификаторВалюты.Вставить("UAH"	,980);
			КлассификаторВалюты.Вставить("USD"	,840);
			КлассификаторВалюты.Вставить("EUR"	,978);
			КлассификаторВалюты.Вставить("MDL"	,498);
			КлассификаторВалюты.Вставить("BYR"	,974);
			КлассификаторВалюты.Вставить("TMT"	,934);
			КлассификаторВалюты.Вставить("USD"	,840);
			КлассификаторВалюты.Вставить("kz"	,398);
			КлассификаторВалюты.Вставить("ru"	,643);
			
			//&lt;БКВ - Буквенный код валюты. ЦКВ - цифровой код валюты&gt;
			БКВ = Неопределено;
			ДанныеФайла.Свойство("CURRENCY", БКВ);
			
			//&lt;Получение валюты из классификатора валют по буквенному коду&gt;
			Если БКВ &lt;&gt; Неопределено Тогда
				ЦКВ = КлассификаторВалюты[БКВ];
				ВалютаСсылка = Справочники.Валюты.НайтиПоКоду(ЦКВ);
			Иначе //&lt;иначе получаем по коду страны из профиля обмена&gt;
				ЗапросКодаСтраны = Новый Запрос;
				ЗапросКодаСтраны.Текст = 
				"ВЫБРАТЬ
				|	ВЫРАЗИТЬ(DR_НастройкиДополнительныеРеквизиты.Значение КАК СТРОКА(3)) КАК Страна
				|ИЗ
				|	Справочник.DR_Настройки КАК DR_Настройки
				|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.DR_Настройки.ДополнительныеРеквизиты КАК DR_НастройкиДополнительныеРеквизиты
				|		ПО DR_Настройки.Ссылка = DR_НастройкиДополнительныеРеквизиты.Ссылка
				|			И (DR_Настройки.ВидНастройки = ""ПрофилиОбмена"")
				|ГДЕ
				|	DR_Настройки.ПометкаУдаления = ЛОЖЬ
				|	И DR_Настройки.Статус = ""Активный""
				|	И DR_НастройкиДополнительныеРеквизиты.Реквизит = ""Страна""";
				
				РезультатЗапроса = ЗапросКодаСтраны.Выполнить();
				ВыборкаЗапрос = РезультатЗапроса.Выбрать();
				
				ВыборкаЗапрос.Следующий();
				ЦКВ = КлассификаторВалюты.Получить(ВыборкаЗапрос.Страна);
				ВалютаСсылка = Справочники.Валюты.НайтиПоКоду(ЦКВ);
				
			КонецЕсли;
			
			//&lt;Добавление валюты&gt;
			ДанныеФайла.Вставить("Валюта", ВалютаСсылка);
			
			//&lt;Создаем временную структуру "ЭДО_GLN"&gt;
			//&lt;Полученную структуру преобразуем в Таблицу значений "HEAD" для поиска УчастниковЭДО в базе&gt;
			HEAD 	= Новый ТаблицаЗначений;
			ЭДО_GLN = Новый Структура;
			
			ЭДО_GLN.Вставить("SUPPLIER"			, ДанныеФайла.SUPPLIER);	  //Продавец			
			ЭДО_GLN.Вставить("RECIPIENT"		, ДанныеФайла.RECIPIENT);     //Получатель
			ЭДО_GLN.Вставить("DELIVERYPLACE"	, ДанныеФайла.DELIVERYPLACE); //Грузополучатель
			
			//&lt;Заполнение таблицы GLN&gt;
			ДобавитьСтрокуВТаблицуШапка(HEAD, ЭДО_GLN);
			ДанныеФайла.Вставить("HEAD", HEAD);
			
			//&lt;Добавление реквизитов по Участникам ЭДО для последующего их заполнения&gt;
			ДанныеФайла.Вставить("Организация"		, ""); //RECIPIENT
			ДанныеФайла.Вставить("Контрагент"		, ""); //SUPPLIER
			ДанныеФайла.Вставить("ТочкаДоставки"	, ""); //DELIVERYPLACE
			
			//&lt;Добавление тригеров:&gt; 
			//&lt;..С целью проверки необходимости получения данных из базы по участникам ЭДО&gt;
			ДанныеФайла.Вставить("ЗаполнитьУчастниковЭДО", Истина);
			//&lt;..С целью проверки необходимости обработки DR_Документа по кастомному условию&gt;
			ДанныеФайла.Вставить("НеОбрабатывать", Ложь);
			
			//&lt;Преобразование даты формата 2023-02-12 в формат 12.02.2022 00:00:00&gt;
			ЭлементыТипаДата = Новый Структура("DATE, ORDERDATE, DELIVERYDATE", "ДатаЭлектронногоДокумента", "ДатаЗаказа", "ДатаПоставки");
			
			Для каждого Элемент Из ЭлементыТипаДата Цикл 
				Если ДанныеФайла.Свойство(Элемент.Ключ) Тогда
					ДанныеФайла.Вставить(Элемент.Значение, Дата(СтрЗаменить(ДанныеФайла[Элемент.Ключ], "-", "")));	 	
				Иначе
					ДанныеФайла.Вставить(Элемент.Значение, Дата(0001,01,01));
				КонецЕсли;				
			КонецЦикла;
			
			Если ДанныеФайла.Свойство("DELIVERYTIME") Тогда
				DELIVERYTIME = СтрЗаменить(ДанныеФайла.DELIVERYTIME, ":", "");
				DELIVERYTIME = ?(СтрДлина(DELIVERYTIME) = 3, "0" + DELIVERYTIME, DELIVERYTIME);
				ДанныеФайла.Вставить("ВремяПоставки", ДАТА("00010101" + DELIVERYTIME));
			КонецЕсли;
			
			Если ДанныеФайла.Свойство("FRESH") Тогда 
				ДанныеФайла.FRESH = ?(ДанныеФайла.FRESH = "0", "Нет", "Да");
			КонецЕсли;
			
			ТипСтрока = Новый ОписаниеТипов("Строка",,,, Новый КвалификаторыСтроки(200));
			ТипЧисло = Новый ОписаниеТипов("Число",,,Новый КвалификаторыЧисла(15,3));
			
			//&lt;Поля табличной части POSITION&gt;
			Поля = Новый Структура;
			Поля.Вставить("Номенклатура"		, ОписаниеТиповНоменклатура);
			Поля.Вставить("ЕдиницаИзмерения"	, ОписаниеТиповЕдИзм);
			Поля.Вставить("PRODUCTIDBUYER"		, ТипСтрока);
			Поля.Вставить("PRODUCTIDSUPPLIER"	, ТипСтрока);
			Поля.Вставить("ORDRSPUNIT"			, ТипСтрока);
			Поля.Вставить("QUANTITYOFCUINTU"	, ТипЧисло);
			Поля.Вставить("PRICE"				, ТипЧисло);
			Поля.Вставить("PRICEWITHVAT"		, ТипЧисло);
			Поля.Вставить("VAT"					, ТипЧисло);
			Поля.Вставить("AMOUNTWITHVAT"		, ТипЧисло);
			Поля.Вставить("AMOUNT"				, ТипЧисло);
			Поля.Вставить("TAXAMOUNT"			, ТипЧисло);
			
			POSITION = ДанныеФайла.POSITION;
			
			//&lt;Добавление полей в табличную часть POSITION&gt;
			Для каждого Поле Из Поля Цикл
				
				Если POSITION.Колонки.Найти(Поле.Ключ) = Неопределено Тогда
					POSITION.Колонки.Добавить(Поле.Ключ, Поле.Значение);
				КонецЕсли;
				
			КонецЦикла;
			
			ИтогACCEPTEDQUANTITY = 0;
			
			//&lt;Преобразование строковых значений в число&gt;
			Для Каждого Стр Из POSITION Цикл
				
				Стр.POSITIONNUMBER      = ЭКОМ_ПреобразоватьВЧисло(Стр.POSITIONNUMBER);                                     //Порядковый номер строки
				Стр.PRICE		   		= ?(Стр.PRICE = "", 			0, ЭКОМ_ПреобразоватьВЧисло(Стр.PRICE));  				//Цена продукта без НДС
				Стр.PRICEWITHVAT  		= ?(Стр.PRICEWITHVAT = "", 		0, ЭКОМ_ПреобразоватьВЧисло(Стр.PRICEWITHVAT));		//Цена продукта с НДС		
				Стр.VAT 				= ?(Стр.VAT = "", 				0, ЭКОМ_ПреобразоватьВЧисло(Стр.VAT));          	//Ставка НДС
				Стр.ORDEREDQUANTITY 	= ЭКОМ_ПреобразоватьВЧисло(Стр.ORDEREDQUANTITY);									//Заказанное количество
				Стр.ACCEPTEDQUANTITY 	= ЭКОМ_ПреобразоватьВЧисло(Стр.ACCEPTEDQUANTITY);									//Имеющееся количество
				Стр.QUANTITYOFCUINTU  	= ?(Стр.QUANTITYOFCUINTU = "", 	0, ЭКОМ_ПреобразоватьВЧисло(Стр.QUANTITYOFCUINTU)); //Количество в упаковке
				Стр.AMOUNTWITHVAT  		= ?(Стр.AMOUNTWITHVAT = "", 	0, ЭКОМ_ПреобразоватьВЧисло(Стр.AMOUNTWITHVAT)); 	//Сумма с НДС
				Стр.AMOUNT  			= ?(Стр.AMOUNT = "", 			0, ЭКОМ_ПреобразоватьВЧисло(Стр.AMOUNT)); 			//Сумма без НДС
				Стр.TAXAMOUNT  			= ?(Стр.TAXAMOUNT = "", 		0, ЭКОМ_ПреобразоватьВЧисло(Стр.TAXAMOUNT)); 		//Сумма НДС
				
				//&lt;Сравниваем количество заказанное с поставляемым&gt;
				Если Стр.ORDEREDQUANTITY &lt;&gt; Стр.ACCEPTEDQUANTITY Тогда
					Комментарий = Комментарий + ?(ЗначениеЗаполнено(Комментарий), Символы.ПС, "")
					+ "Позиция № " + Стр.POSITIONNUMBER + "."
					+ " Штрихкод " + Стр.PRODUCT + " (" + Стр.DESCRIPTION + ")" + " заказано - " + Формат(Стр.ORDEREDQUANTITY,"ЧДЦ=3; ЧРД=.; ЧН=0; ЧГ=0") 
					+ ", будет поставлено - " + Формат(Стр.ACCEPTEDQUANTITY,"ЧДЦ=3; ЧРД=.; ЧН=0; ЧГ=0");			
				КонецЕсли;
				
				ИтогACCEPTEDQUANTITY = ИтогACCEPTEDQUANTITY + Стр.ACCEPTEDQUANTITY;
				
			КонецЦикла;
			
			Если ИтогACCEPTEDQUANTITY = 0 Тогда
				Комментарий = "Поставка отменена!";
			ИначеЕсли ЗначениеЗаполнено(Комментарий) Тогда
				Комментарий = "Поставка подтверждена частично:" + Символы.ПС + Комментарий;
			Иначе
				Комментарий = "Поставка подтверждена в полном объеме!";
			КонецЕсли;
			
			ДанныеФайла.Вставить("Комментарий", Комментарий);
			
			//////////////////////////////////////////////////////////////////////////////////////////////////////////
			//Для того, что бы не обрабатывать Новый DR_Документы необходимо, значение реквизита "НеОбрабатывать"	//
			//по условию установить в Истина. Условие может быть любым.												//
			//////////////////////////////////////////////////////////////////////////////////////////////////////////			
			
			//&lt;Пример&gt;			
			//МассивТочкеДоставок = новый Массив;
			//МассивТочкеДоставок.Добавить("9864398478404");
			//
			//Если НЕ МассивТочкеДоставок.Найти(ДанныеФайла.DELIVERYPLACE) = Неопределено Тогда
			//	ДанныеФайла.Вставить("НеОбрабатывать", Истина);
			//КонецЕсли;
			
			Если ДанныеФайла.НеОбрабатывать Тогда
				
				//&lt;Для Нового DR_Документа устанавливаем статус "Обработан"&gt;
				DR_ДокументОбъект = СтрокаТаблицы.DR_Документ.ПолучитьОбъект();
				DR_ДокументОбъект.Статус = "Архивный";
				DR_ДокументОбъект.ДанныеФайла = Новый ХранилищеЗначения(Неопределено);
				DR_ДокументОбъект.Комментарий = "Документ не был обработан по условию описанному в шаблоне ""ORDRSP входящий""";
				
				ТабличнаяЧасть = DR_ДокументОбъект.ДополнительныеРеквизиты;
				
				НовСтр = ТабличнаяЧасть.Добавить();
				НовСтр.Реквизит = "НеОбрабатывать";
				НовСтр.Значение = Истина;
				DR_ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
				
				Продолжить;
			КонецЕсли;
			
			НовЭлКоллекции 				   = ТаблицаНовДокументов.Добавить();	
			НовЭлКоллекции.ChainID		   = ДанныеДокумента.ИдентификаторЦепочки;		
			НовЭлКоллекции.DocUUID         = ДанныеДокумента.ИдентификаторДокумента;
			НовЭлКоллекции.ДатаФайла       = ДанныеДокумента.ДатаФайла;
			НовЭлКоллекции.ДанныеДокумента = ДанныеДокумента;
						
		КонецЦикла;
		
		#КонецОбласти
		
		#Область ОбработкаКоллекцииДанных
		
		//&lt;Очищаем коллекцию, данные которой уже не нужны&gt;
		ТаблицаЗагруженных = Неопределено;
		
		//&lt;Выполняем сортировку документов в порядке их появления на FTP, т.е. в рамках цепочки по дате файла&gt;
		ТаблицаНовДокументов.Сортировать("ChainID, ДатаФайла");
		
		//&lt;ТаблицаНовДокументов - Тип ТаблицаЗначений&gt;
		//&lt;Поля&gt;
		//    &lt;ChainID 	- Тип Строка (Идентификатор цепочки)&gt;
		//    &lt;DocUIID 	- Тип Строка (Идентификатор документа)&gt;
		//    &lt;ДатаФайла - Тип Дата&gt;
		//    &lt;ДанныеДокумента 	- Тип Структура&gt;:
		//      	&lt;Ключ&gt;:
		//			- ДанныеФайла - Тип Структура
		//			- ИдентификаторДокумента - Тип Строка
		//			- ИдентификаторЦепочки - Тип Строка
		//			- DR_Документ - Тип ДокументСсылка.DR_Документ
		//			- Статус - Тип Строка
		//			- ДатаФайла - Тип Дата

		Для каждого Элемент ИЗ ТаблицаНовДокументов Цикл
			
			//&lt;Тип - Структура&gt;
			ДанныеДокумента 			= Элемент.ДанныеДокумента;
			ДанныеФайла					= ДанныеДокумента.ДанныеФайла;  
			СтруктураРегистра_DRСобытия = Новый Структура;
			
			//&lt;Тип - Ссылка&gt;
			DR_ДокументСсылка = ДанныеДокумента.DR_Документ; 
			
			//&lt;Тип - Строка&gt;
			ИдентификаторДокумента	= ДанныеДокумента.ИдентификаторДокумента;
			ИдентификаторЦепочки	= ДанныеДокумента.ИдентификаторЦепочки;
			СтатусДокумента			= "НеОбработан";
			ТекстОшибки 			= "";
			Комментарий				= ДанныеФайла.Комментарий;
			ЗаписьСообщение 		= "";
			
			//&lt;Тип - Соответствие&gt;
			СоответствиеУчастникиЭДО = Новый Соответствие;
			
			//&lt;Поиск и заполнение Участников ЭДО&gt;
			Запрос = Новый Запрос;	
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	ПОДСТРОКА(ТаблицаGLN.RECIPIENT		, 1, 13) КАК xmlОрганизацияGLN,
			|	ПОДСТРОКА(ТаблицаGLN.SUPPLIER		, 1, 13) КАК xmlКонтрагентGLN,
			|	ПОДСТРОКА(ТаблицаGLN.DELIVERYPLACE	, 1, 13) КАК xmlТочкаДоставкиGLN
			|ПОМЕСТИТЬ ВТ_УчастиникиЭДО
			|ИЗ
			|	&amp;ТаблицаGLN КАК ТаблицаGLN
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ЭКОМ_GLN_Организация.Объект КАК Организация,
			|	ЭКОМ_GLN_Контрагент.Объект КАК Контрагент,
			|	ЭКОМ_ТочкиДоставки.Объект КАК ТочкаДоставки,
			|	ЭКОМ_GLN_Контрагент.РасчетСумм КАК РасчетСумм
			|ИЗ
			|	ВТ_УчастиникиЭДО КАК ВТ_УчастиникиЭДО
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_GLN КАК ЭКОМ_GLN_Организация
			|		ПО ВТ_УчастиникиЭДО.xmlОрганизацияGLN = ЭКОМ_GLN_Организация.GLN
			|			И (НЕ ЭКОМ_GLN_Организация.Объект ССЫЛКА Справочник.Контрагенты)
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_GLN КАК ЭКОМ_GLN_Контрагент
			|		ПО ВТ_УчастиникиЭДО.xmlКонтрагентGLN = ЭКОМ_GLN_Контрагент.GLN
			|			И (ЭКОМ_GLN_Контрагент.Объект ССЫЛКА Справочник.Контрагенты)
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_ТочкиДоставки КАК ЭКОМ_ТочкиДоставки
			|		ПО ВТ_УчастиникиЭДО.xmlТочкаДоставкиGLN = ЭКОМ_ТочкиДоставки.GLN
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	ВТ_УчастиникиЭДО.xmlОрганизацияGLN,
			|	ВТ_УчастиникиЭДО.xmlКонтрагентGLN,
			|	ВТ_УчастиникиЭДО.xmlТочкаДоставкиGLN,
			|	ЛОЖЬ
			|ИЗ
			|	ВТ_УчастиникиЭДО КАК ВТ_УчастиникиЭДО";
			
			ТаблицаGLN = ДанныеФайла.HEAD;
			
			Запрос.УстановитьПараметр("ТаблицаGLN", ТаблицаGLN);
			
			РезультатЗапроса = Запрос.Выполнить();			
			УчастникиЭДО = РезультатЗапроса.Выгрузить();
			
			РасчитатьСуммыПоДокументу = Ложь;
			
			Для Каждого Колонка Из УчастникиЭДО.Колонки Цикл
				
				Если Колонка.Имя = "РасчетСумм" Тогда
					РасчитатьСуммыПоДокументу = УчастникиЭДО[0][Колонка.Имя];
					Продолжить;
				КонецЕсли;
				
				УчастникЭДО = УчастникиЭДО[0][Колонка.Имя];
				
				Ссылка = УчастникиЭДО[0][Колонка.Имя];
				GLN = УчастникиЭДО[1][Колонка.Имя];
				
				Если ЗначениеЗаполнено(Ссылка) Тогда					
					ДанныеФайла[Колонка.Имя] = Ссылка;					
				Иначе					
					//&lt;Заполнение текста ошибки&gt;
					ТекстОшибки = ТекстОшибки + ?(ЗначениеЗаполнено(ТекстОшибки), Символы.ПС, "")
								+ "Не заполнен(а) " + Колонка.Имя + " (" + GLN + ")";
					
					СоотвествиеУчастник = Новый Соответствие;
					СоотвествиеУчастник.Вставить(Колонка.Имя + "_" + GLN, GLN);					
					СоответствиеУчастникиЭДО.Вставить(Колонка.Имя + "_", СоотвествиеУчастник);					
				КонецЕсли;
				
			КонецЦикла;                                                     
			
			Если ПустаяСтрока(ТекстОшибки) Тогда 
				ДанныеФайла.ЗаполнитьУчастниковЭДО = Ложь;
			КонецЕсли;
			
			//&lt;Поиск и заполнение номенклатуры&gt;
			ТекстЗапроса = "ВЫБРАТЬ
			|	ВЫРАЗИТЬ(ТЧ_PRODUCT.PRODUCT КАК Строка(30)) КАК Штрихкод
			|ПОМЕСТИТЬ ВТ
			|ИЗ
			|	&amp;ТЧ_PRODUCT КАК ТЧ_PRODUCT
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ВТ.Штрихкод КАК Штрихкод,
			|	ШтрихкодыНоменклатуры.*
			|ИЗ
			|	ВТ КАК ВТ
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
			|		ПО ВТ.Штрихкод = ШтрихкодыНоменклатуры.Штрихкод";
			
			//Определяем источник 
			Если Метаданные.РегистрыСведений.Найти("ШтрихкодыНоменклатуры") = Неопределено Тогда
				ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "РегистрСведений.ШтрихкодыНоменклатуры", "РегистрСведений.Штрихкоды");
			КонецЕсли;
			
			ЗапросНоменклатуры = Новый Запрос;
			ЗапросНоменклатуры.Текст = ТекстЗапроса;
			
			POSITION = ДанныеФайла.POSITION;
			
			ЗапросНоменклатуры.УстановитьПараметр("ТЧ_PRODUCT", POSITION.Скопировать(,"PRODUCT"));
			
			Результат = ЗапросНоменклатуры.Выполнить();
			СписокНоменклатуры = Результат.Выгрузить();
			
			POSITION.Индексы.Добавить("PRODUCT");
			
			//&lt;Определяем имя колонки&gt;
			ИмяКолонкиНоменклатура = ?(СписокНоменклатуры.Колонки.Найти("Номенклатура") &lt;&gt; Неопределено, "Номенклатура", "Владелец");
			ИмяКолонкиЕдИзм = ?(СписокНоменклатуры.Колонки.Найти("Упаковка") &lt;&gt; Неопределено, "Упаковка", "ЕдиницаИзмерения");
			
			Для Каждого Строка Из СписокНоменклатуры Цикл
				
				Номенклатура = Неопределено;
				НайденнаяСтрока = POSITION.Найти(СокрЛП(Строка.Штрихкод), "PRODUCT");
				
				Если ЗначениеЗаполнено(Строка[ИмяКолонкиНоменклатура]) Тогда
					
					Номенклатура     = Строка[ИмяКолонкиНоменклатура];
					ЕдиницаИзмерения = Строка[ИмяКолонкиЕдИзм];
					
					Если Не ЗначениеЗаполнено(ЕдиницаИзмерения) Тогда
						
						Если Номенклатура.Метаданные().Реквизиты.найти("ЕдиницаХраненияОстатков") = Неопределено Тогда 
							ЕдиницаИзмерения = Номенклатура.ЕдиницаИзмерения;
						Иначе 
							ЕдиницаИзмерения = Номенклатура.ЕдиницаХраненияОстатков;	
						КонецЕсли;
						
					КонецЕсли;
					
				ИначеЕсли НайденнаяСтрока.PRODUCTIDBUYER &lt;&gt; "" Тогда  
					//&lt;Если элемент не найден метод вернет пустую ссылку&gt;
					Номенклатура = Справочники.Номенклатура.НайтиПоКоду(СокрЛП(НайденнаяСтрока.PRODUCTIDBUYER));
					 
					Если Номенклатура.Метаданные().Реквизиты.найти("ЕдиницаХраненияОстатков") = Неопределено Тогда 
						ЕдиницаИзмерения = Номенклатура.ЕдиницаИзмерения;
					Иначе 
						ЕдиницаИзмерения = Номенклатура.ЕдиницаХраненияОстатков;	
					КонецЕсли;
					
				КонецЕсли;
				
				Если ЗначениеЗаполнено(Номенклатура) Тогда
					
					НайденнаяСтрока.Номенклатура = Номенклатура;
					НайденнаяСтрока.ЕдиницаИзмерения = ЕдиницаИзмерения;
					
				Иначе
					ТекстОшибки = ТекстОшибки + ?(ЗначениеЗаполнено(ТекстОшибки), Символы.ПС, "") 
								+ "Позиция № " + НайденнаяСтрока.POSITIONNUMBER + ". По " + """" + НайденнаяСтрока.DESCRIPTION + """"
								+ " не заполнен товар, проверьте корректность штрихкода или код товара.";
				КонецЕсли;
				
				Если РасчитатьСуммыПоДокументу Тогда
					
					ЦенаБезНДС	 = НайденнаяСтрока.PRICE;
					ЦенаСНДС     = НайденнаяСтрока.PRICEWITHVAT;
					ИмеющеесяКол = НайденнаяСтрока.ACCEPTEDQUANTITY;
					
					СуммаСНДС 	= НайденнаяСтрока.AMOUNTWITHVAT;
					СуммаНДС	= НайденнаяСтрока.TAXAMOUNT;
					СуммаБезНДС = НайденнаяСтрока.AMOUNT;
					
					Если ЦенаСНДС &lt;&gt; 0 И ИмеющеесяКол &lt;&gt; 0 Тогда
						СуммаСНДС = Окр(ЦенаСНДС * ИмеющеесяКол, 2);	
					КонецЕсли;
					
					Если ЦенаБезНДС &lt;&gt; 0 И ИмеющеесяКол &lt;&gt; 0 Тогда
						СуммаБезНДС = Окр(ЦенаБезНДС * ИмеющеесяКол, 2);
					КонецЕсли;
					
					Если СуммаСНДС &lt;&gt; 0 И СуммаБезНДС &lt;&gt; 0 Тогда
						СуммаНДС = Окр(СуммаСНДС - СуммаБезНДС, 2);
					КонецЕсли;
					
					НайденнаяСтрока.AMOUNTWITHVAT 	= СуммаСНДС;
					НайденнаяСтрока.TAXAMOUNT		= СуммаНДС;
					НайденнаяСтрока.AMOUNT 			= СуммаБезНДС;
					
				КонецЕсли;
				
			КонецЦикла;
			
			//&lt;Проверка по изменению статуса&gt;
			Если ПустаяСтрока(ТекстОшибки) Тогда
				СтатусДокумента = "Обработан";
			КонецЕсли;
			
			//&lt;Добавление записей в РС ЭКОМ_ЗначениеДополнительныхКонстант по не сопоставленным данным&gt;
			Если НЕ СоответствиеУчастникиЭДО.Количество() = 0 Тогда				    
				Для Каждого Участник Из СоответствиеУчастникиЭДО Цикл
					НастройкиПараметровЗаписатьНабором(Участник.Значение, Участник.Ключ);
				КонецЦикла;			
			КонецЕсли;
			
			//&lt;Заполнение данных по DR_Документу&gt;
			DR_ДокументОбъект 						= DR_ДокументСсылка.ПолучитьОбъект();
			DR_ДокументОбъект.ИдентификаторЦепочки	= ИдентификаторЦепочки;
			DR_ДокументОбъект.ДанныеФайла 			= Новый ХранилищеЗначения(Неопределено);
			DR_ДокументОбъект.Статус 				= СтатусДокумента;
			DR_ДокументОбъект.Сообщение 			= ТекстОшибки;
			DR_ДокументОбъект.Комментарий			= Комментарий;
			DR_ДокументОбъект.Пользователь 			= НайтиТекущегоПользователя();
			
			ТЧ_Документа = DR_ДокументОбъект.ДополнительныеРеквизиты;
			
			Для каждого ЭлСтруктуры Из ДанныеФайла Цикл
				
				Если ЭлСтруктуры.Ключ = "Комментарий" Тогда
					Продолжить;
				КонецЕсли;
				
				НоваяСтрока = ТЧ_Документа.Добавить();
				НоваяСтрока.Реквизит = ЭлСтруктуры.Ключ;
				
				Если ТипЗнч(ЭлСтруктуры.Значение) = Тип("ТаблицаЗначений") Тогда				
					Хранилище = Новый ХранилищеЗначения(ЭлСтруктуры.Значение);
					НоваяСтрока.ХранилищеЗначения = Хранилище;
				Иначе
					НоваяСтрока.Значение = ЭлСтруктуры.Значение;				
				КонецЕсли;
				
			КонецЦикла;
			
			//&lt;Текст сообщения в событии по документу&gt;
			Если Не ПустаяСтрока(ТекстОшибки) Тогда
				ЗаписьСообщение = "В документе есть ошибка";
			КонецЕсли;
			
			Если Не ПустаяСтрока(Комментарий) Тогда
				Если ПустаяСтрока(ЗаписьСообщение) Тогда
					ЗаписьСообщение = "Документ содержит комментарий";
				Иначе
					ЗаписьСообщение = ЗаписьСообщение + " и комментарий";
				КонецЕсли;
			КонецЕсли;
			
			НачатьТранзакцию();
			
			#Область Меняем_статус_заказа
			
			Если ДанныеФайла.Свойство(&quot;ACTION&quot;) = Истина Тогда
				Запрос = Новый Запрос;
				Запрос.Текст = &quot;ВЫБРАТЬ
				|	DR_События.Документ КАК Заказ
				|ИЗ
				|	РегистрСведений.DR_События КАК DR_События
				|ГДЕ
				|	DR_События.ИдентификаторЦепочки = &amp;ИдентификаторЦепочки
				|	И DR_События.ВидДокумента = &quot;&quot;Заказ_Исходящий&quot;&quot;&quot;;
				
				Запрос.УстановитьПараметр(&quot;ИдентификаторЦепочки&quot;, DR_ДокументОбъект.ИдентификаторЦепочки);
				
				РезультатЗапроса = Запрос.Выполнить();
				
				ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
				
				Если ВыборкаДетальныеЗаписи.Следующий() Тогда
					ДокументЗаказа = ВыборкаДетальныеЗаписи.Заказ.ПолучитьОбъект();
					
					Если ДанныеФайла.ACTION = &quot;29&quot;
						ИЛИ ДанныеФайла.ACTION = &quot;4&quot; Тогда // Поставка принята или изменена
						ДокументЗаказа.Статус = Перечисления.СтатусыЗаказовПоставщикам.Подтвержден;
					КонецЕсли;
					
					Если ЗначениеЗаполнено(ДанныеФайла.ДатаПоставки) Тогда
						ДатаПоступления = ДанныеФайла.ДатаПоставки;
					Иначе
						ДатаПоступления = ТекущаяДата();
					КонецЕсли;
					
					Если ДокументЗаказа.ПоступлениеОднойДатой Тогда
						Если НЕ ЗначениеЗаполнено(ДокументЗаказа.ДатаПоступления) Тогда
							ДокументЗаказа.ДатаПоступления = ДатаПоступления;
						КонецЕсли;                 
					КонецЕсли;
					Для каждого Стр Из ДокументЗаказа.Товары Цикл
						Если НЕ ЗначениеЗаполнено(Стр.ДатаПоступления) Тогда
							Стр.ДатаПоступления = ДатаПоступления;
						КонецЕсли;            
					КонецЦикла;  
					
					Если ДокументЗаказа.Проведен Тогда
						ДокументЗаказа.Записать(РежимЗаписиДокумента.Проведение);
					Иначе
						ДокументЗаказа.Записать();
					КонецЕсли
				КонецЕсли;
				
				// Обрабатываем ACTION = 27.
				Если СокрЛП(ДанныеФайла.ACTION) = &quot;27&quot; Тогда
					ПометитьНаУдаление = Истина;
					
					Запрос = Новый Запрос;
					Запрос.Текст = &quot;ВЫБРАТЬ
					|	DR_События.Документ КАК Заказ
					|ИЗ
					|	РегистрСведений.DR_События КАК DR_События
					|ГДЕ
					|	DR_События.ИдентификаторЦепочки = &amp;ИдентификаторЦепочки
					|	И DR_События.ВидДокумента = ЗНАЧЕНИЕ(Перечисление.ЭКОМ_ВидыДокументов.Заказ_Исходящий)
					|	И DR_События.Документ ССЫЛКА Документ.ЗаказПоставщику
					|	И ВЫРАЗИТЬ(DR_События.Документ КАК Документ.ЗаказПоставщику).Проведен = ЛОЖЬ&quot;;
					
					Запрос.УстановитьПараметр(&quot;ИдентификаторЦепочки&quot;, DR_ДокументОбъект.ИдентификаторЦепочки);
					
					РезультатЗапроса = Запрос.Выполнить();
					ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
					
					Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
						ЗаказОбъект = ВыборкаДетальныеЗаписи.Заказ.ПолучитьОбъект();
						ЗаказОбъект.УстановитьПометкуУдаления(Истина);
					КонецЦикла;
					
				КонецЕсли;			
				
			КонецЕсли;
			
			#КонецОбласти
			Попытка				
				//&lt;Запись DR_Документа&gt;
				DR_ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
				
				////////////////////////////&lt;Создание записи в РС DR_События&gt;/////////////////////////////////////
				
				//&lt;Заполнение структуры для DR_События&gt;
				СтруктураРегистра_DRСобытия.Вставить("ДатаСообщения"			, ДанныеДокумента.ДатаСообщения);
				СтруктураРегистра_DRСобытия.Вставить("ИдентификаторЦепочки"		, ИдентификаторЦепочки);
				СтруктураРегистра_DRСобытия.Вставить("ДатаЗаписи"				, ТекущаяДата());
				СтруктураРегистра_DRСобытия.Вставить("Документ"					, DR_ДокументСсылка);
				СтруктураРегистра_DRСобытия.Вставить("ВидДокумента"				, "ORDRSP_Входящий");
				СтруктураРегистра_DRСобытия.Вставить("Идентификатор"			, ИдентификаторДокумента);
				СтруктураРегистра_DRСобытия.Вставить("Статус"					, СтатусДокумента);
				СтруктураРегистра_DRСобытия.Вставить("Сообщение"				, ЗаписьСообщение);
				
				НЗ_DRСобытия = РегистрыСведений.DR_События.СоздатьНаборЗаписей();
				НЗ_DRСобытия.Отбор.ИдентификаторЦепочки.Установить(СтруктураРегистра_DRСобытия.ИдентификаторЦепочки);
				НЗ_DRСобытия.Отбор.Документ.Установить(СтруктураРегистра_DRСобытия.Документ);
				НЗ_DRСобытия.Отбор.ВидДокумента.Установить(СтруктураРегистра_DRСобытия.ВидДокумента);
				НЗ_DRСобытия.Отбор.Идентификатор.Установить(СтруктураРегистра_DRСобытия.Идентификатор);
				НЗ_DRСобытия.Прочитать();
				
				Если НЗ_DRСобытия.Количество() = 0 Тогда
					НоваяЗапись = НЗ_DRСобытия.Добавить();
				Иначе
					НоваяЗапись = НЗ_DRСобытия[0];
				КонецЕсли;
				
				Для Каждого Элемент Из СтруктураРегистра_DRСобытия Цикл			
						НоваяЗапись[Элемент.Ключ] = Элемент.Значение; 	
				КонецЦикла;
				
				НЗ_DRСобытия.Записать();
								
				ЗафиксироватьТранзакцию();
				
			Исключение				
				ОтменитьТранзакцию();
				
				ТекстЛогаСобытий = НСтр("ru = 'Формирование записей в Регистрах Docrobot по %ПредставлениеДокументаXML% не выполнено.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
				ПредставлениеДокументаXML = "ORDRSP (Подтверждение заказа)" + " № " + ДанныеФайла.NUMBER + " от " + Формат(ДанныеФайла.ДатаЭлектронногоДокумента, "ДЛФ=D");
				ТекстЛогаСобытий = СтрЗаменить(ТекстЛогаСобытий, "%ПредставлениеДокументаXML%", ПредставлениеДокументаXML);
				ТекстЛогаСобытий = ТекстЛогаСобытий + Символы.ПС + "По причине: "+ ОписаниеОшибки();
				
				ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
				МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);				
				ЗаписьЖурналаРегистрации("Обработка ""Интеграция Docrobot""", УровеньЖурналаРегистрации.Ошибка, , , "Описание ошибки: " + ОписаниеОшибки());
				
			КонецПопытки;
			
		КонецЦикла;
		
		#КонецОбласти
		
		#Область ОбработкаДокументовСоСтатустомНеОбработан
		
		//&lt;Очищаем коллекцию, данные которой уже не нужны&gt;
		ТаблицаНовДокументов = Неопределено;
		
		Индекс = МассивРезультатов.ВГраница();
		
		Если НЕ МассивРезультатов[Индекс].Пустой() Тогда
			
			//&lt;Получение коллекции колонок. По которым будет выполнен обход строки&gt;
			Колонки = МассивРезультатов[Индекс].Колонки;
			
			ВыборкаДетальныеЗаписи = МассивРезультатов[Индекс].Выбрать();
			
			Пока ВыборкаДетальныеЗаписи.Следующий() Цикл 
				
				//&lt;Тип - Булево&gt;
				DRДокументМодифицирован = Ложь;
				
				//&lt;Тип - Строка&gt;
				СтатусДокумента	= "НеОбработан";
				ТекстОшибки 	= "";			
				ЗаписьСообщение	= "";
				
				//&lt;Тип - Ссылка&gt;
				DR_ДокументСсылка = ВыборкаДетальныеЗаписи.DR_Документ;
				
				//&lt;Тип - Структура&gt;
				СтруктураДанных 			= Новый Структура;
				СтруктураРегистра_DRСобытия = Новый Структура;
				
				//&lt;Заполнение структуры данными&gt;
				Для каждого Колонка ИЗ Колонки Цикл
					
					Значение = ВыборкаДетальныеЗаписи[Колонка.Имя];
					
					Если ТипЗнч(Значение) = Тип("ХранилищеЗначения") Тогда
						
						ЗначениеИзХранилища = Значение.Получить();
						
						Если ЗначениеЗаполнено(ЗначениеИзХранилища) Тогда			
							СтруктураДанных.Вставить(Колонка.Имя, ЗначениеИзХранилища);		
						КонецЕсли;
						
					Иначе	
						СтруктураДанных.Вставить(Колонка.Имя, Значение);	
					КонецЕсли;
					
				КонецЦикла;
				
				Комментарий	= СтруктураДанных.Комментарий;
				
				//&lt;Получение возраста ORDRSP в днях&gt;
				ТекДата = КонецДня(ТекущаяДата()) + 1; 		//Текущая дата включительно.
				ВозрастВДнях = (ТекДата - СтруктураДанных.ДатаЭлектронногоДокумента) / 86400;
				
				//&lt;Если возраст ORDRSP больше срока обработки DR_Документов со статусом "Не обработан"&gt;
				//&lt;Тогда по таким документам меняем статус и переходим к обработке следующего DR_Документа&gt;
				Если ВозрастВДнях &gt; СрокПовторнойОбработки Тогда
					
					DR_ДокументОбъект = DR_ДокументСсылка.ПолучитьОбъект();
					DR_ДокументОбъект.Статус = "Архивный";
					DR_ДокументОбъект.Комментарий = Комментарий + ?(ЗначениеЗаполнено(Комментарий), Символы.ПС, "")
													+ "Документу изменен статус на ""Архивный"" по причине: Срок повторной обработки Документа истек.";
					
					НачатьТранзакцию();
					
					Попытка
						
						//&lt;Запись DR_Документа&gt;
						DR_ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
						
						МЗ_DRСобытия = РегистрыСведений.DR_События.СоздатьМенеджерЗаписи();
						МЗ_DRСобытия.ИдентификаторЦепочки 	= СтруктураДанных.ИдентификаторЦепочки;
						МЗ_DRСобытия.Документ 				= DR_ДокументСсылка;
						МЗ_DRСобытия.ВидДокумента 			= "ORDRSP_Входящий";
						МЗ_DRСобытия.Идентификатор 			= СтруктураДанных.ИдентификаторДокумента;
						МЗ_DRСобытия.Прочитать();
						
						Если МЗ_DRСобытия.Выбран() Тогда							
							МЗ_DRСобытия.ДатаЗаписи = ТекущаяДата();
							МЗ_DRСобытия.Статус = "Архивный";
							МЗ_DRСобытия.Записать();							
						КонецЕсли;
						
						ЗафиксироватьТранзакцию();
						
					Исключение						
						ОтменитьТранзакцию();
						
						ПредставлениеДокументаXML = "ORDRSP (Подтверждение заказа)" + " № " + СтруктураДанных.NUMBER + " от " + Формат(СтруктураДанных.ДатаЭлектронногоДокумента, "ДЛФ=D");
						ТекстЛогаСобытий = "Изменение статуса " + ПредставлениеДокументаXML + ", срок обработки которого истек, не выполнено. По причине - " + ОписаниеОшибки();
						ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
						МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);						
						ЗаписьЖурналаРегистрации("Обработка ""Интеграция Docrobot""", УровеньЖурналаРегистрации.Ошибка, , , "Описание ошибки - " + ОписаниеОшибки());
						
					КонецПопытки;
					
					Продолжить;					
				КонецЕсли;
				
				//&lt;Поиск и заполнение Участников ЭДО&gt;		
				Если СтруктураДанных["ЗаполнитьУчастниковЭДО"] Тогда 
					
					//&lt;Поиск данных по Участникам ЭДО&gt;
					Запрос = Новый Запрос;	
					Запрос.Текст = 
					"ВЫБРАТЬ
					|	ПОДСТРОКА(ТаблицаGLN.RECIPIENT		, 1, 13) КАК xmlОрганизацияGLN,
					|	ПОДСТРОКА(ТаблицаGLN.SUPPLIER		, 1, 13) КАК xmlКонтрагентGLN,
					|	ПОДСТРОКА(ТаблицаGLN.DELIVERYPLACE	, 1, 13) КАК xmlТочкаДоставкиGLN
					|ПОМЕСТИТЬ ВТ_УчастиникиЭДО
					|ИЗ
					|	&amp;ТаблицаGLN КАК ТаблицаGLN
					|;
					|
					|////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	ЭКОМ_GLN_Организация.Объект КАК Организация,
					|	ЭКОМ_GLN_Контрагент.Объект КАК Контрагент,
					|	ЭКОМ_ТочкиДоставки.Объект КАК ТочкаДоставки
					|ИЗ
					|	ВТ_УчастиникиЭДО КАК ВТ_УчастиникиЭДО
					|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_GLN КАК ЭКОМ_GLN_Организация
					|		ПО ВТ_УчастиникиЭДО.xmlОрганизацияGLN = ЭКОМ_GLN_Организация.GLN
					|			И (НЕ ЭКОМ_GLN_Организация.Объект ССЫЛКА Справочник.Контрагенты)
					|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_GLN КАК ЭКОМ_GLN_Контрагент
					|		ПО ВТ_УчастиникиЭДО.xmlКонтрагентGLN = ЭКОМ_GLN_Контрагент.GLN
					|			И (ЭКОМ_GLN_Контрагент.Объект ССЫЛКА Справочник.Контрагенты)
					|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_ТочкиДоставки КАК ЭКОМ_ТочкиДоставки
					|		ПО ВТ_УчастиникиЭДО.xmlТочкаДоставкиGLN = ЭКОМ_ТочкиДоставки.GLN
					|
					|ОБЪЕДИНИТЬ ВСЕ
					|
					|ВЫБРАТЬ
					|	ВТ_УчастиникиЭДО.xmlОрганизацияGLN,
					|	ВТ_УчастиникиЭДО.xmlКонтрагентGLN,
					|	ВТ_УчастиникиЭДО.xmlТочкаДоставкиGLN
					|ИЗ
					|	ВТ_УчастиникиЭДО КАК ВТ_УчастиникиЭДО";
					
					ТаблицаGLN = СтруктураДанных.HEAD;
					
					Запрос.УстановитьПараметр("ТаблицаGLN", ТаблицаGLN);
					РезультатЗапроса = Запрос.Выполнить();
					
					УчастникиЭДО = РезультатЗапроса.Выгрузить();
					
					Для Каждого Колонка Из УчастникиЭДО.Колонки Цикл
						
						УчастникЭДО = Неопределено;				
						СтруктураДанных.Свойство(Колонка.Имя, УчастникЭДО);
						
						Если ЗначениеЗаполнено(УчастникЭДО) Тогда
							Продолжить;	
						КонецЕсли;
						
						Ссылка = УчастникиЭДО[0][Колонка.Имя];
						GLN = УчастникиЭДО[1][Колонка.Имя];
						
						Если ЗначениеЗаполнено(Ссылка) Тогда							
							
							СтруктураДанных[Колонка.Имя] = Ссылка;							
							МодификацияЦепочки 			 = Истина;
							DRДокументМодифицирован 	 = Истина;
							
						Иначе							
							ТекстОшибки = ТекстОшибки + ?(ЗначениеЗаполнено(ТекстОшибки), Символы.ПС, "")
										+ "Не заполнен(а) " + Колонка.Имя + " (" + GLN + ")";							
						КонецЕсли;
						
					КонецЦикла;                                                     
					
					Если ПустаяСтрока(ТекстОшибки) Тогда 
						СтруктураДанных.ЗаполнитьУчастниковЭДО = Ложь;
					КонецЕсли;
					
				КонецЕсли;
				
				//&lt;Получение Таблицы значений POSITION&gt;
				ТЧ_ДопРеквизиты = DR_ДокументСсылка.ДополнительныеРеквизиты;
				
				НайденнаяСтрока = ТЧ_ДопРеквизиты.Найти("POSITION", "Реквизит");
				
				Если НайденнаяСтрока &lt;&gt; Неопределено Тогда 
					
					POSITION = НайденнаяСтрока.ХранилищеЗначения.Получить();
					
					Если ЗначениеЗаполнено(POSITION) Тогда
						СтруктураДанных.Вставить("POSITION", POSITION);	
					Иначе
						ПредставлениеДокументаXML = "ORDRSP (Подтверждение заказа)" + " № " + СтруктураДанных.NUMBER + " от " + Формат(СтруктураДанных.ДатаЭлектронногоДокумента, "ДЛФ=D");
						ТекстЛогаСобытий = "По " + ПредставлениеДокументаXML + ", отсутсвует значение реквизита POSITION";
						ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Предупреждение", ИмяСобытия);
						МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
						
						Продолжить;	
					КонецЕсли;
					
				Иначе
					ПредставлениеДокументаXML = "ORDRSP (Подтверждение заказа)" + " № " + СтруктураДанных.NUMBER + " от " + Формат(СтруктураДанных.ДатаЭлектронногоДокумента, "ДЛФ=D");
					ТекстЛогаСобытий = "По " + ПредставлениеДокументаXML + ", отсутсвует реквизит POSITION";
					ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Предупреждение", ИмяСобытия);
					МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
					
					Продолжить;					
				КонецЕсли;
				
				//&lt;Поиск и заполнение номенклатуры&gt;
				ТекстЗапроса = "ВЫБРАТЬ
				|	ВЫРАЗИТЬ(ТЧ_PRODUCT.PRODUCT КАК Строка(30)) КАК Штрихкод
				|ПОМЕСТИТЬ ВТ
				|ИЗ
				|	&amp;ТЧ_PRODUCT КАК ТЧ_PRODUCT
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ.Штрихкод КАК Штрихкод,
				|	ШтрихкодыНоменклатуры.*
				|ИЗ
				|	ВТ КАК ВТ
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
				|		ПО ВТ.Штрихкод = ШтрихкодыНоменклатуры.Штрихкод";
				
				//&lt;Определяем источник&gt;
				Если Метаданные.РегистрыСведений.Найти("ШтрихкодыНоменклатуры") = Неопределено Тогда
					ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "РегистрСведений.ШтрихкодыНоменклатуры", "РегистрСведений.Штрихкоды");
				КонецЕсли;
				
				ЗапросНоменклатуры = Новый Запрос;
				ЗапросНоменклатуры.Текст = ТекстЗапроса;
				
				ЗапросНоменклатуры.УстановитьПараметр("ТЧ_PRODUCT", POSITION.Скопировать(,"PRODUCT"));
				
				Результат = ЗапросНоменклатуры.Выполнить();
				СписокНоменклатуры = Результат.Выгрузить();
				
				POSITION.Индексы.Добавить("PRODUCT");
				
				//&lt;Определяем имя колонки&gt;
				ИмяКолонкиНоменклатура = ?(СписокНоменклатуры.Колонки.Найти("Номенклатура") &lt;&gt; Неопределено, "Номенклатура", "Владелец");
				ИмяКолонкиЕдИзм = ?(СписокНоменклатуры.Колонки.Найти("Упаковка") &lt;&gt; Неопределено, "Упаковка", "ЕдиницаИзмерения");
				
				Для Каждого Строка Из СписокНоменклатуры Цикл
					
					Номенклатура = Неопределено;
					НайденнаяСтрока = POSITION.Найти(СокрЛП(Строка.Штрихкод), "PRODUCT");
					
					Если ЗначениеЗаполнено(НайденнаяСтрока.Номенклатура) Тогда
						Продолжить;
					КонецЕсли;
					
					Если ЗначениеЗаполнено(Строка[ИмяКолонкиНоменклатура]) Тогда
						
						Номенклатура     = Строка[ИмяКолонкиНоменклатура];
						ЕдиницаИзмерения = Строка[ИмяКолонкиЕдИзм];
						
						Если Не ЗначениеЗаполнено(ЕдиницаИзмерения) Тогда
							Если Номенклатура.Метаданные().Реквизиты.Найти("ЕдиницаХраненияОстатков") = Неопределено Тогда 
								ЕдиницаИзмерения = Номенклатура.ЕдиницаИзмерения;
							Иначе 
								ЕдиницаИзмерения = Номенклатура.ЕдиницаХраненияОстатков;	
							КонецЕсли;
							
						КонецЕсли;
						
					ИначеЕсли НайденнаяСтрока.PRODUCTIDBUYER &lt;&gt; "" Тогда  
						//&lt;Если элемент не найден метод вернет пустую ссылку&gt;
						Номенклатура = Справочники.Номенклатура.НайтиПоКоду(СокрЛП(НайденнаяСтрока.PRODUCTIDBUYER));
						
						Если Номенклатура.Метаданные().Реквизиты.Найти("ЕдиницаХраненияОстатков") = Неопределено Тогда 
							ЕдиницаИзмерения = Номенклатура.ЕдиницаИзмерения;
						Иначе 
							ЕдиницаИзмерения = Номенклатура.ЕдиницаХраненияОстатков;	
						КонецЕсли;
						
					КонецЕсли;
					
					Если ЗначениеЗаполнено(Номенклатура) Тогда						
						
						НайденнаяСтрока.Номенклатура 	 = Номенклатура;
						НайденнаяСтрока.ЕдиницаИзмерения = ЕдиницаИзмерения;						
						DRДокументМодифицирован 		 = Истина;
						
					Иначе
						ТекстОшибки = ТекстОшибки + ?(ЗначениеЗаполнено(ТекстОшибки), Символы.ПС, "") 
										+ "Позиция № " + НайденнаяСтрока.POSITIONNUMBER + ". По " + """" + НайденнаяСтрока.DESCRIPTION + """"
										+ " не заполнен товар, проверьте корректность штрихкода или код товара";
					КонецЕсли; 
					
				КонецЦикла;
				
				//&lt;Проверка на перезапись повторно обрабатываемых документов&gt;
				Если НЕ DRДокументМодифицирован Тогда 
					Продолжить; 	
				КонецЕсли;
				
				//&lt;Проверка на изменение статуса&gt;
				Если ПустаяСтрока(ТекстОшибки) Тогда
					СтатусДокумента = "Обработан";
				КонецЕсли;
				
				//&lt;Обновление данных в DR_Документе&gt;
				DR_ДокументОбъект 				= DR_ДокументСсылка.ПолучитьОбъект();
				DR_ДокументОбъект.Статус 		= СтатусДокумента;
				DR_ДокументОбъект.Сообщение 	= ТекстОшибки;
				DR_ДокументОбъект.Комментарий   = Комментарий;
				
				ТЧ_Документа = DR_ДокументОбъект.ДополнительныеРеквизиты;
				
				Для каждого ЭлСтруктуры Из СтруктураДанных Цикл
					
					НайденнаяСтрока	= ТЧ_Документа.Найти(ЭлСтруктуры.Ключ, "Реквизит");
					
					Если ТипЗнч(ЭлСтруктуры.Значение) = Тип("ТаблицаЗначений") Тогда				
						Хранилище = Новый ХранилищеЗначения(ЭлСтруктуры.Значение);
						НайденнаяСтрока.ХранилищеЗначения = Хранилище;
					Иначе
						
						Если НайденнаяСтрока = Неопределено Тогда
							Продолжить;
						Иначе
							НайденнаяСтрока.Значение = ЭлСтруктуры.Значение;
						КонецЕсли;
						
					КонецЕсли;
					
				КонецЦикла;
				
				//&lt;Текст сообщения в событии по документу&gt;
				Если Не ПустаяСтрока(ТекстОшибки) Тогда
					ЗаписьСообщение = "В документе есть ошибка";
				КонецЕсли;
				
				Если Не ПустаяСтрока(Комментарий) Тогда
					Если ПустаяСтрока(ЗаписьСообщение) Тогда
						ЗаписьСообщение = "Документ содержит комментарий";
					Иначе
						ЗаписьСообщение = ЗаписьСообщение + " и комментарий";
					КонецЕсли;
				КонецЕсли;
				
				НачатьТранзакцию();
				
				Попытка					
					//&lt;Запись DR_Документа&gt;
					DR_ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
					
					//&lt;Перезапись события по DR_документу&gt;
					Если ВРег(СтатусДокумента) = "ОБРАБОТАН" Тогда
						
						СтруктураРегистра_DRСобытия.Вставить("ИдентификаторЦепочки"		, СтруктураДанных.ИдентификаторЦепочки);
						СтруктураРегистра_DRСобытия.Вставить("ДатаЗаписи"				, ТекущаяДата());
						СтруктураРегистра_DRСобытия.Вставить("Документ"					, DR_ДокументСсылка);
						СтруктураРегистра_DRСобытия.Вставить("ВидДокумента"				, "ORDRSP_Входящий");
						СтруктураРегистра_DRСобытия.Вставить("Идентификатор"			, СтруктураДанных.ИдентификаторДокумента);
						СтруктураРегистра_DRСобытия.Вставить("Статус"					, СтатусДокумента);
						СтруктураРегистра_DRСобытия.Вставить("Сообщение"				, ЗаписьСообщение);
						
						НЗ_DRСобытия = РегистрыСведений.DR_События.СоздатьНаборЗаписей();
						НЗ_DRСобытия.Отбор.ИдентификаторЦепочки.Установить(СтруктураРегистра_DRСобытия.ИдентификаторЦепочки);
						НЗ_DRСобытия.Отбор.Документ.Установить(СтруктураРегистра_DRСобытия.Документ);
						НЗ_DRСобытия.Отбор.ВидДокумента.Установить(СтруктураРегистра_DRСобытия.ВидДокумента);
						НЗ_DRСобытия.Отбор.Идентификатор.Установить(СтруктураРегистра_DRСобытия.Идентификатор);
						НЗ_DRСобытия.Прочитать();
						
						Если НЗ_DRСобытия.Количество() = 0 Тогда
							НоваяЗапись = НЗ_DRСобытия.Добавить();
						Иначе
							НоваяЗапись = НЗ_DRСобытия[0];
						КонецЕсли;
						
						Для Каждого Элемент Из СтруктураРегистра_DRСобытия Цикл			
							НоваяЗапись[Элемент.Ключ] = Элемент.Значение; 	
						КонецЦикла;
						
						НЗ_DRСобытия.Записать();
						
					КонецЕсли;
					
					ЗафиксироватьТранзакцию();
					
				Исключение					
					ОтменитьТранзакцию();
					
					ТекстЛогаСобытий = НСтр("ru = 'Изменение данных в Регистрах Docrobot по %ПредставлениеДокументаXML% не выполнено.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
					ПредставлениеДокументаXML = "ORDRSP (Подтверждение заказа)" + " № " + СтруктураДанных.NUMBER + " от " + Формат(СтруктураДанных.ДатаЭлектронногоДокумента, "ДЛФ=D");
					ТекстЛогаСобытий = СтрЗаменить(ТекстЛогаСобытий, "%ПредставлениеДокументаXML%", ПредставлениеДокументаXML);
					ТекстЛогаСобытий = ТекстЛогаСобытий + Символы.ПС + "По причине: "+ ОписаниеОшибки();
					
					ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
					МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);				
					ЗаписьЖурналаРегистрации("Обработка ""Интеграция Docrobot""", УровеньЖурналаРегистрации.Ошибка, , , "Описание ошибки: " + ОписаниеОшибки());
					
				КонецПопытки;
				
			КонецЦикла;
			
		КонецЕсли;
		
		#КонецОбласти
		
	Иначе
		ТекстЛогаСобытий = "Ошибка получения Идентификаторов. Проверьте доступность сети и корректность заполнения профилей обмена.";
		ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
		МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
		
	КонецЕсли;

	</Value>
		<Value xsi:type="xs:string"/>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="xs:string">Подтверждения заказов (ORDRSP)</Value>
		<Value xsi:type="ValueListType">
			<valueType/>
			<lastId xsi:type="xs:decimal">3</lastId>
			<item>
				<value xsi:type="xs:string">Прайс-лист</value>
				<id xsi:type="xs:decimal">0</id>
			</item>
			<item>
				<value xsi:type="xs:string">Поставщик</value>
				<id xsi:type="xs:decimal">1</id>
			</item>
			<item>
				<value xsi:type="xs:string">Покупатель</value>
				<presentation>СписокOrdrspВходящие</presentation>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">2</id>
			</item>
			<item>
				<value xsi:type="xs:string">ИмяКнопки</value>
				<presentation>Подтверждения заказов (ORDRSP)</presentation>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">3</id>
			</item>
		</Value>
	</row>
</ValueTree>