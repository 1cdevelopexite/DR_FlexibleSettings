<ValueTree xmlns="http://v8.1c.ru/8.1/data/core" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ValueTree">
	<column>
		<Name xsi:type="xs:string">Использовать</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">ТипТранзакции</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Служебные</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">СлужебныеТекст</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Сохранение</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Загрузка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Кнопка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">КоллекцияТЧ</Name>
		<ValueType/>
	</column>
	<row>
		<Value xsi:type="xs:boolean">true</Value>
		<Value xsi:type="xs:string">Входящий RECADV</Value>
		<Value xsi:type="xs:string">//ВыполнитьГибкиеНастройки(, МассивЛогаСобытий, ИмяСобытия);

ТипДокумента = "RECADV";	
	ТипДокументооборота      = "EDI";
	ИдентификаторыУчастников = Новый Массив;
	ЕстьОшибкаПолученияИдентификаторов = Ложь;
	
	#Область ПолучениеИдентификаторовЦепочекПоВсемПрофилям	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЭКОМ_GLN.ПрофильОбмена КАК ПрофильОбмена,
	|	ЭКОМ_GLN.Объект КАК Организация,
	|	ЭКОМ_GLN.GLN КАК GLN,
	|	ЭКОМ_GLN.Ид_ОЭД КАК ИдУчастника
	|ИЗ
	|	РегистрСведений.ЭКОМ_GLN КАК ЭКОМ_GLN
	|ГДЕ
	|	НЕ ЭКОМ_GLN.ПрофильОбмена = НЕОПРЕДЕЛЕНО
	|	И НЕ ЭКОМ_GLN.ПрофильОбмена.ПометкаУдаления
	|ИТОГИ ПО
	|	ПрофильОбмена";
	
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		ТаблицаДокументовAPI = Новый ТаблицаЗначений;
		ТаблицаДокументовAPI.Колонки.Добавить("chainID"    , Новый ОписаниеТипов("Строка",,,, Новый КвалификаторыСтроки(36)));
		ТаблицаДокументовAPI.Колонки.Добавить("ftpFileName", Новый ОписаниеТипов("Строка",,,, Новый КвалификаторыСтроки(50)));
		ТаблицаДокументовAPI.Колонки.Добавить("docUUID"    , Новый ОписаниеТипов("Строка",,,, Новый КвалификаторыСтроки(36)));
		ТаблицаДокументовAPI.Колонки.Добавить("date"       , Новый ОписаниеТипов("Строка",,,, Новый КвалификаторыСтроки(36)));
		ТаблицаДокументовAPI.Индексы.Добавить("docUUID");
		
		ВыборкаПрофильОбмена = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		
		Пока ВыборкаПрофильОбмена.Следующий() Цикл
			
			ПрофильОбмена = ВыборкаПрофильОбмена.ПрофильОбмена;
			
			#Область ПолучениеСпискаИдентификаторовПоПрофилюОбмена
			
			ВыборкаДетальныеЗаписи = ВыборкаПрофильОбмена.Выбрать();
			
			Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
				ИдентификаторыУчастников.Добавить(ВыборкаДетальныеЗаписи.GLN);	 
			КонецЦикла; 
			
			#КонецОбласти
			
			#Область ПодготовкаВспомогательныхДанныхДляRestApi
			
			ИмяСобытия = "Заполнение идентификаторов цепочки для входящих файлов " + ТипДокумента + ".";  		
			ЛимитСообщений = ЭКОМ_ОбщегоНазначения.Настройка_Параметр_Прочитать("ЭКОМ_ЛимитСообщенийRESTv2", "1000");
			ДанныеДляREST = Новый Структура("ЕстьОшибка, ВидДокумента, ДанныеПодключения, doc_type", Ложь, Неопределено, Неопределено, Неопределено); 
			
			ДанныеДляREST.ВидДокумента 	=  "RECADV_Входящий";
			ДанныеДляREST.doc_type 		= "recadv";

			
			ДанныеАвторизации = ЭКОМ_ВзаимодействиеREST_API.ВыполнитьАвторизациюАтолл(ПрофильОбмена);
			Если Не ДанныеАвторизации.Получены Тогда
				ТекстЛогаСобытий = "Не удалось выполнить авторизацию. ";
				ДобавитьЗаписьВМассивЛога(МассивЛогаСобытий, ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
				ДанныеДляREST.ЕстьОшибка = Истина;
			КонецЕсли;	
			ДанныеПодключения = ЭКОМ_ВзаимодействиеREST_API.ПолучитьДанныеПодключенияEvolution(ПрофильОбмена);
			Если Не ДанныеПодключения.ПолученПрофиль ИЛИ Не ДанныеПодключения.ПолученТокен Тогда
				ТекстЛогаСобытий = "Не удалось получить данные для подключения к REST API. ";
				ДобавитьЗаписьВМассивЛога(МассивЛогаСобытий, ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
				ДанныеДляREST.ЕстьОшибка = Истина;
			КонецЕсли;
			ДанныеДляREST.ДанныеПодключения = ДанныеПодключения;	
			
			#КонецОбласти
			
			#Область ПолучитьИдентификаторыЦепочекВходящихФайлов
			
			Если Не ДанныеДляREST.ЕстьОшибка Тогда	
				НачалоПериода = Дата(1,1,1);
				Запрос = Новый Запрос;
				Запрос.Текст = "ВЫБРАТЬ
				|	МАКСИМУМ(DR_События.ДатаСообщения) КАК ДатаПоследнегоСообщения
				|ИЗ
				|	РегистрСведений.DR_События КАК DR_События
				|ГДЕ
				|	DR_События.ВидДокумента = &amp;ВидДокумента
				|	И DR_События.АктуализироватьИдентификатор = ЛОЖЬ";
				
				Запрос.УстановитьПараметр("ВидДокумента", ДанныеДляREST.ВидДокумента);
				ВыборкаДата = Запрос.Выполнить().Выбрать();
				Если ВыборкаДата.Следующий() Тогда
					НачалоПериода = ВыборкаДата.ДатаПоследнегоСообщения;
				КонецЕсли;   
				
				МинимальнаяДата =  НачалоПериода;
				Сутки         = 60*60*24;
				ТекущаяДата   = ТекущаяДата(); 
				Если ЗначениеЗаполнено(МинимальнаяДата) Тогда
					МинимальнаяДата = МинимальнаяДата - Сутки;
				Иначе
					МинимальнаяДата = ТекущаяДата - Сутки * 30;					
				КонецЕсли;         
				МаксимальнаяДата =  ТекущаяДата + Сутки; 
				
				НачалоПериода = Формат(МинимальнаяДата , "ДФ=yyyy-MM-dd");
				КонецПериода  = Формат(МаксимальнаяДата, "ДФ=yyyy-MM-dd");  	
				
				ВсеСообщенияAPI  = Новый Массив;
				
				Для Каждого ИдУчастника Из ИдентификаторыУчастников Цикл
					ПараметрыМетода = Новый Структура("gln, doc_type, time_from, time_to, limit, direction", ИдУчастника, ДанныеДляREST.doc_type, НачалоПериода, КонецПериода, ЛимитСообщений, "0");
					МассивСообщенийAPI = ЭКОМ_ВзаимодействиеREST_API.ПолучитьСписокВходящихДокументовEDI(ПараметрыМетода, ДанныеПодключения);
					
					Для Каждого Сообщение Из МассивСообщенийAPI Цикл
						ВсеСообщенияAPI.Добавить(Сообщение);
					КонецЦикла;
				КонецЦикла;
				
				Для Каждого Соответствие Из ВсеСообщенияAPI Цикл
					НовСтр = ТаблицаДокументовAPI.Добавить();
					НовСтр.chainID     = Соответствие.Получить("chainID");
					НовСтр.ftpFileName = Соответствие.Получить("ftpFileName");
					НовСтр.docUUID     = Соответствие.Получить("docUUID");
					НовСтр.date        = Соответствие.Получить("date");
				КонецЦикла;
			Иначе
				ЕстьОшибкаПолученияИдентификаторов = Истина;
			КонецЕсли
			#КонецОбласти
			
		КонецЦикла;
	КонецЕсли;
	
	#КонецОбласти
	
	Если Не ЕстьОшибкаПолученияИдентификаторов Тогда
		
		/////////////////////////////////////////////////////////////////////////////////
		//          					ВХОДЯЩИЙ RECADV                                //
		/////////////////////////////////////////////////////////////////////////////////
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	DR_События.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
		|	DR_События.Документ КАК Накладная,
		|	DR_События.Идентификатор КАК ИдентификаторНакладной
		|ИЗ
		|	РегистрСведений.DR_События КАК DR_События
		|ГДЕ
		|	DR_События.ИдентификаторЦепочки В(&amp;ИдентификаторЦепочки)
		|	И DR_События.ВидДокумента = ""Накладная_Исходящая""
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	DR_Документ.Ссылка КАК Ссылка,
		|	DR_Документ.ДанныеФайла КАК ДанныеФайла,
		|	DR_Документ.Статус КАК Статус,
		|	DR_Документ.ИдентификаторДокумента КАК ИдентификаторДокумента
		|ПОМЕСТИТЬ ВТ_Загружен
		|ИЗ
		|	Документ.DR_Документ КАК DR_Документ
		|ГДЕ
		|	DR_Документ.Статус = &amp;Загружен
		|	И DR_Документ.ВидДокумента = &amp;ВидДокумента
		|	И НЕ DR_Документ.ПометкаУдаления
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Загружен.Ссылка КАК DR_Документ,
		|	ПРЕДСТАВЛЕНИЕ(ВТ_Загружен.Ссылка) КАК Представление,
		|	ВТ_Загружен.ДанныеФайла КАК ДанныеФайла,
		|	ВТ_Загружен.Статус КАК СтатусДокумента,
		|	ВТ_Загружен.ИдентификаторДокумента КАК ИдентификаторДокумента,
		|	ВЫРАЗИТЬ(ТЧ_ДатаФайла.Значение КАК ДАТА) КАК ДатаФайла,
		|	ТЧ_ФайлЗагруженЛокально.Значение КАК ФайлЗагруженЛокально
		|ИЗ
		|	ВТ_Загружен КАК ВТ_Загружен
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ДатаФайла
		|		ПО ВТ_Загружен.Ссылка = ТЧ_ДатаФайла.Ссылка
		|			И (ТЧ_ДатаФайла.Реквизит = ""ДатаФайла"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ФайлЗагруженЛокально
		|		ПО ВТ_Загружен.Ссылка = ТЧ_ФайлЗагруженЛокально.Ссылка
		|			И (ТЧ_ФайлЗагруженЛокально.Реквизит = ""ФайлЗагруженЛокально"")
		|
		|УПОРЯДОЧИТЬ ПО
		|	ДатаФайла,
		|	ИдентификаторДокумента
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	DR_Документ.Ссылка КАК Ссылка
		|ПОМЕСТИТЬ DR_НеОбработан
		|ИЗ
		|	Документ.DR_Документ КАК DR_Документ
		|ГДЕ
		|	DR_Документ.Статус = &amp;НеОбработан
		|	И DR_Документ.ВидДокумента = &amp;ВидДокумента
		|	И НЕ DR_Документ.ПометкаУдаления
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	DR_НеОбработан.Ссылка КАК Ссылка,
		|	РАЗНОСТЬДАТ(ВЫРАЗИТЬ(ТЧ_ДатаЭлектронногоДокумента.Значение КАК ДАТА), &amp;ТекущаяДата, ДЕНЬ) КАК ВозрастДокДней,
		|	ТЧ_ДатаЭлектронногоДокумента.Значение КАК ДатаЭлектронногоДокумента
		|ПОМЕСТИТЬ DR_ВозрастДокумента
		|ИЗ
		|	DR_НеОбработан КАК DR_НеОбработан
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ДатаЭлектронногоДокумента
		|		ПО DR_НеОбработан.Ссылка = ТЧ_ДатаЭлектронногоДокумента.Ссылка
		|			И (ТЧ_ДатаЭлектронногоДокумента.Реквизит = ""ДатаЭлектронногоДокумента"")
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	DR_ВозрастДокумента.Ссылка КАК Ссылка,
		|	DR_ВозрастДокумента.ДатаЭлектронногоДокумента КАК ДатаЭлектронногоДокумента,
		|	ТЧ_Контрагент.Значение КАК Контрагент,
		|	ТЧ_ЗаполнитьУчастниковЭДО.Значение КАК ЗаполнитьУчастниковЭДО,
		|	ТЧ_ПервичныйПоискНоменклатуры.Значение КАК ПервичныйПоискНоменклатуры
		|ПОМЕСТИТЬ DR_Данные
		|ИЗ
		|	DR_ВозрастДокумента КАК DR_ВозрастДокумента
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_Контрагент
		|		ПО DR_ВозрастДокумента.Ссылка = ТЧ_Контрагент.Ссылка
		|			И (ТЧ_Контрагент.Реквизит = ""Контрагент"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ЗаполнитьУчастниковЭДО
		|		ПО DR_ВозрастДокумента.Ссылка = ТЧ_ЗаполнитьУчастниковЭДО.Ссылка
		|			И (ТЧ_ЗаполнитьУчастниковЭДО.Реквизит = ""ЗаполнитьУчастниковЭДО"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ПервичныйПоискНоменклатуры
		|		ПО DR_ВозрастДокумента.Ссылка = ТЧ_ПервичныйПоискНоменклатуры.Ссылка
		|			И (ТЧ_ПервичныйПоискНоменклатуры.Реквизит = ""ПервичныйПоискНоменклатуры"")
		|ГДЕ
		|	DR_ВозрастДокумента.ВозрастДокДней &lt;= &amp;СрокОбработкиДокументаДней
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	DR_Данные.Ссылка КАК Ссылка,
		|	ИСТИНА КАК Сопоставлен
		|ПОМЕСТИТЬ DR_ТоварСопоставлен
		|ИЗ
		|	DR_Данные КАК DR_Данные
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ШК_НеСопоставлен
		|		ПО DR_Данные.Ссылка = ТЧ_ШК_НеСопоставлен.Ссылка
		|			И (ТЧ_ШК_НеСопоставлен.Реквизит = ""ШК_НеСопоставлен"")
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_НоменклатураКонтрагентов КАК ЭКОМ_НоменклатураКонтрагентов
		|		ПО DR_Данные.Контрагент = ЭКОМ_НоменклатураКонтрагентов.Контрагент
		|			И (ТЧ_ШК_НеСопоставлен.Значение = ЭКОМ_НоменклатураКонтрагентов.ШтрихКодНоменклатурыКонтрагента)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	DR_Данные.Ссылка КАК Ссылка,
		|	ТЧ_HEAD.ХранилищеЗначения КАК HEAD,
		|	ТЧ_Организация.Значение КАК Организация,
		|	ТЧ_ТочкаДоставки.Значение КАК ТочкаДоставки
		|ПОМЕСТИТЬ DR_УчастникиЭДО
		|ИЗ
		|	DR_Данные КАК DR_Данные
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_HEAD
		|		ПО DR_Данные.Ссылка = ТЧ_HEAD.Ссылка
		|			И (ТЧ_HEAD.Реквизит = ""HEAD"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_Организация
		|		ПО DR_Данные.Ссылка = ТЧ_Организация.Ссылка
		|			И (ТЧ_Организация.Реквизит = ""Организация"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ТочкаДоставки
		|		ПО DR_Данные.Ссылка = ТЧ_ТочкаДоставки.Ссылка
		|			И (ТЧ_ТочкаДоставки.Реквизит = ""ТочкаДоставки"")
		|ГДЕ
		|	(DR_Данные.ЗаполнитьУчастниковЭДО = ИСТИНА
		|			ИЛИ DR_Данные.ПервичныйПоискНоменклатуры = ИСТИНА)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЕСТЬNULL(DR_ТоварСопоставлен.Ссылка, DR_УчастникиЭДО.Ссылка) КАК Ссылка,
		|	ЕСТЬNULL(DR_ТоварСопоставлен.Сопоставлен, ЛОЖЬ) КАК ШК_Сопоставлен,
		|	ЕСТЬNULL(DR_УчастникиЭДО.HEAD, НЕОПРЕДЕЛЕНО) КАК HEAD,
		|	ЕСТЬNULL(DR_УчастникиЭДО.Организация, НЕОПРЕДЕЛЕНО) КАК Организация,
		|	ЕСТЬNULL(DR_УчастникиЭДО.ТочкаДоставки, НЕОПРЕДЕЛЕНО) КАК ТочкаДоставки
		|ПОМЕСТИТЬ DR_Обработать
		|ИЗ
		|	DR_УчастникиЭДО КАК DR_УчастникиЭДО
		|		ПОЛНОЕ СОЕДИНЕНИЕ DR_ТоварСопоставлен КАК DR_ТоварСопоставлен
		|		ПО (DR_ТоварСопоставлен.Ссылка = DR_УчастникиЭДО.Ссылка)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	DR_ВозрастДокумента.Ссылка КАК Ссылка,
		|	ИСТИНА КАК СрокОбработкиДокИстек
		|ПОМЕСТИТЬ DR_ВАрхив
		|ИЗ
		|	DR_ВозрастДокумента КАК DR_ВозрастДокумента
		|ГДЕ
		|	DR_ВозрастДокумента.ВозрастДокДней &gt; &amp;СрокОбработкиДокументаДней
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЕСТЬNULL(DR_Обработать.Ссылка, DR_ВАрхив.Ссылка) КАК Ссылка,
		|	ЕСТЬNULL(DR_Обработать.ШК_Сопоставлен, ЛОЖЬ) КАК ШК_Сопоставлен,
		|	ЕСТЬNULL(DR_ВАрхив.СрокОбработкиДокИстек, ЛОЖЬ) КАК СрокОбработкиДокИстек,
		|	ЕСТЬNULL(DR_Обработать.HEAD, НЕОПРЕДЕЛЕНО) КАК HEAD,
		|	ЕСТЬNULL(DR_Обработать.Организация, НЕОПРЕДЕЛЕНО) КАК Организация,
		|	ЕСТЬNULL(DR_Обработать.ТочкаДоставки, НЕОПРЕДЕЛЕНО) КАК ТочкаДоставки
		|ПОМЕСТИТЬ DR_Итог
		|ИЗ
		|	DR_Обработать КАК DR_Обработать
		|		ПОЛНОЕ СОЕДИНЕНИЕ DR_ВАрхив КАК DR_ВАрхив
		|		ПО DR_Обработать.Ссылка = DR_ВАрхив.Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	DR_Итог.Ссылка КАК DR_Документ,
		|	Docrobot_Документ.Комментарий КАК Комментарий,
		|	Docrobot_Документ.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
		|	Docrobot_Документ.ИдентификаторДокумента КАК ИдентификаторДокумента,
		|	ТЧ_NUMBER.Значение КАК NUMBER,
		|	DR_Итог.HEAD КАК HEAD,
		|	DR_Итог.Организация КАК Организация,
		|	DR_Данные.Контрагент КАК Контрагент,
		|	DR_Итог.ТочкаДоставки КАК ТочкаДоставки,
		|	DR_Данные.ЗаполнитьУчастниковЭДО КАК ЗаполнитьУчастниковЭДО,
		|	DR_Данные.ДатаЭлектронногоДокумента КАК ДатаЭлектронногоДокумента,
		|	DR_Данные.ПервичныйПоискНоменклатуры КАК ПервичныйПоискНоменклатуры,
		|	ТЧ_ORDERNUMBER.Значение КАК ORDERNUMBER,
		|	ТЧ_ДатаЗаказа.Значение КАК ДатаЗаказа,
		|	ТЧ_ДатаУвОбОтгрузке.Значение КАК ДатаУвОбОтгрузке,
		|	ТЧ_СозданиеЦепочки.Значение КАК СозданиеЦепочки,
		|	ТЧ_Накладная1С.Значение КАК Накладная1С,
		|	DR_Итог.ШК_Сопоставлен КАК ШК_Сопоставлен,
		|	DR_Итог.СрокОбработкиДокИстек КАК СрокОбработкиДокИстек
		|ИЗ
		|	DR_Итог КАК DR_Итог
		|		ЛЕВОЕ СОЕДИНЕНИЕ DR_Данные КАК DR_Данные
		|		ПО DR_Итог.Ссылка = DR_Данные.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ КАК Docrobot_Документ
		|		ПО DR_Итог.Ссылка = Docrobot_Документ.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_NUMBER
		|		ПО DR_Итог.Ссылка = ТЧ_NUMBER.Ссылка
		|			И (ТЧ_NUMBER.Реквизит = ""NUMBER"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ДатаУвОбОтгрузке
		|		ПО DR_Итог.Ссылка = ТЧ_ДатаУвОбОтгрузке.Ссылка
		|			И (ТЧ_ДатаУвОбОтгрузке.Реквизит = ""ДатаУвОбОтгрузке"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ORDERNUMBER
		|		ПО DR_Итог.Ссылка = ТЧ_ORDERNUMBER.Ссылка
		|			И (ТЧ_ORDERNUMBER.Реквизит = ""ORDERNUMBER"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_ДатаЗаказа
		|		ПО DR_Итог.Ссылка = ТЧ_ДатаЗаказа.Ссылка
		|			И (ТЧ_ДатаЗаказа.Реквизит = ""ДатаЗаказа"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_СозданиеЦепочки
		|		ПО DR_Итог.Ссылка = ТЧ_СозданиеЦепочки.Ссылка
		|			И (ТЧ_СозданиеЦепочки.Реквизит = ""СозданиеЦепочки"")
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК ТЧ_Накладная1С
		|		ПО DR_Итог.Ссылка = ТЧ_Накладная1С.Ссылка
		|			И (ТЧ_Накладная1С.Реквизит = ""Накладная1С"")";
		
		//&lt;Выгрузка массива ID цепочек полученных по REST для передачи его параметром в запрос&gt;
		ChainID_API = ТаблицаДокументовAPI.ВыгрузитьКолонку("ChainID");
		
		Запрос.УстановитьПараметр("ВидДокумента"			, ТипДокумента + "_входящий");
		Запрос.УстановитьПараметр("Загружен"				, "Загружен");
		Запрос.УстановитьПараметр("НеОбработан"				, "НеОбработан");
		Запрос.УстановитьПараметр("ИдентификаторЦепочки"	, ChainID_API);
		Запрос.УстановитьПараметр("ТекущаяДата"				, ТекущаяДата());
		Запрос.УстановитьПараметр("СрокОбработкиДокументаДней"	, Настройка_Параметр_Прочитать("СрокПовторнойОбработкиДокументовRECADV", 7));
		
		МассивРезультатов = Запрос.ВыполнитьПакет();
		
		//&lt;Таблица используется для поиска принадлежности RECADV к одной цепочки с ORDER&gt;
		//&lt;В запросе установден отбор по Накладной, потому что предпологается, что ID цепочки ORDER и найденной Накладной равны&gt;
		ТаблицаIDЦепочкиORDER	= МассивРезультатов[0].Выгрузить();
		ТаблицаIDЦепочкиORDER.Индексы.Добавить("ИдентификаторЦепочки");
		
		//&lt;Таблица DR_Документов со статусом "Загружен"&gt;
		ТаблицаЗагруженных	= МассивРезультатов[2].Выгрузить();
		
		//&lt;Инициализация массива примитивных типов&gt;
		ПримитивныеТипы = Новый Массив;
		ПримитивныеТипы.Добавить(Тип("Строка"));
		ПримитивныеТипы.Добавить(Тип("Число"));		
		
		//&lt;Инициализация квалификаторов&gt;
		КвалификаторСтрока	= Новый КвалификаторыСтроки(200);
		КвалификаторЧисло 	= Новый КвалификаторыЧисла(15, 3, ДопустимыйЗнак.Неотрицательный);
		
		//&lt;Инициализация описателей типов&gt;
		ОписаниеПримитивныхТипов 	= Новый ОписаниеТипов(ПримитивныеТипы,,,КвалификаторЧисло,КвалификаторСтрока);
		ОписаниеТипаТЗ 				= Новый ОписаниеТипов("ТаблицаЗначений");
		ОписаниеТиповНоменклатура 	= Новый ОписаниеТипов("СправочникСсылка.Номенклатура");
		ОписаниеТиповХарактеристи 	= Новый ОписаниеТипов("СправочникСсылка.ХарактеристикиНоменклатуры");
		
		МассивТиповЕдИзм = Новый Массив;
		ИмяОбъектов 	 = Новый Массив;
		ИмяОбъектов.Добавить("УпаковкиЕдиницыИзмерения");
		ИмяОбъектов.Добавить("КлассификаторЕдиницИзмерения");
		ИмяОбъектов.Добавить("ЕдиницыИзмерения");
		
		Для каждого ИмяСпр Из ИмяОбъектов Цикл
			Если Метаданные.Справочники.Найти(ИмяСпр) &lt;&gt; Неопределено Тогда
				МассивТиповЕдИзм.Добавить(Тип("СправочникСсылка." + ИмяСпр));		
			КонецЕсли;
		КонецЦикла;
			
		ОписаниеТиповЕдИзм 	= Новый ОписаниеТипов(МассивТиповЕдИзм);
		
		//&lt;Заполнение массивов выполняется в области СозданиеКоллекцииДанныхПоНовымДокументам&gt;
		DocUUID = Новый Массив;
		ChainID = Новый Массив;
		
		//&lt;Элементы по спецификации множественные, т.е. могут в RECADV переданы несколько раз. 
		//В созданной структуре будут иметь тип Таблица значений не зависимо от их количества в электронном документе&gt;
		ЭлементыТипаТЗ = Новый Массив;
		ЭлементыТипаТЗ.Добавить("POSITION");   
		ЭлементыТипаТЗ.Добавить("MARKCODE");
		
		//&lt;В таблицу добавляются данные по распарсенным XML&gt;
		ТаблицаНовДокументов = Новый ТаблицаЗначений;
		ТаблицаНовДокументов.Колонки.Добавить("ChainID");         //Тип - Строка
		ТаблицаНовДокументов.Колонки.Добавить("DocUUID");         //Тип - Строка
		ТаблицаНовДокументов.Колонки.Добавить("ДатаФайла");       //Тип - Дата
		ТаблицаНовДокументов.Колонки.Добавить("ДанныеДокумента"); //Тип - Структура

		//&lt;Создание индекса для поиска по таблице&gt;
		ТаблицаНовДокументов.Индексы.Добавить("DocUUID");
		
		//&lt;Получение значения доп. константы&gt;
		ПереводТрафика = Настройка_Параметр_Прочитать("ПереводТрафика", Ложь);
		КоличествоДнейОтДатыПоставки = Настройка_Параметр_Прочитать("КоличествоДнейОтДатыПоставки", 14);
		
		#Область СозданиеКоллекцииДанныхПоНовымДокументам
		
		Для каждого СтрокаТаблицы ИЗ ТаблицаЗагруженных Цикл
			
			//&lt;Тип - Структура&gt;
			ДанныеДокумента = Новый Структура;	
			ДанныеФайла 	= Новый Структура;
			ПараметрыОтбора = Новый Структура;
			
			//&lt;Тип - Строка&gt;
			ChainID_RECADV = "";
			ChainID_ORDER  = "";
			
			//&lt;Получение данных XML&gt;
			Попытка
				
				ДвоичныеДанныеФайла = СтрокаТаблицы.ДанныеФайла.Получить();	
				ИмяВременногоФайла = ПолучитьИмяВременногоФайла("xml");
				
				Если ЗначениеЗаполнено(ДвоичныеДанныеФайла) Тогда					
					ДвоичныеДанныеФайла.Записать(ИмяВременногоФайла);					
				Иначе					
					ТекстЛогаСобытий = СтрокаТаблицы.Представление + "не обработан. Причина: отсутствуют Двоичные данные XML";
					ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Предупреждение", ИмяСобытия);
					МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
					
					Продолжить;
				КонецЕсли;
				
			Исключение
				ТекстЛогаСобытий = СтрокаТаблицы.Представление + "не обработан." + "Описание ошибки: " + ОписаниеОшибки();
				ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Предупреждение", ИмяСобытия);					
				ЗаписьЖурналаРегистрации(НСтр("ru = 'Обработка ""Интеграция Docrobot""'"), УровеньЖурналаРегистрации.Ошибка, , , ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
				
				Продолжить;
			КонецПопытки;
			
			ТекущийФайл = Новый Файл(ИмяВременногоФайла);
			
			КодировкаXML = "UTF-8";
			ЧтениеXMLДляТекущегоФайла = ПолучитьЧтениеXMLДляФайла(ТекущийФайл.Имя, ТекущийФайл, КодировкаXML, МассивЛогаСобытий); 							
			Если ЧтениеXMLДляТекущегоФайла = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			ОбъектXDTO = Неопределено;
			ОбъектXDTO = ФабрикаXDTO.ПрочитатьXML(ЧтениеXMLДляТекущегоФайла);
			
			//&lt;Преобразование данных из XDTO в Структуру - "ДанныеФайла"&gt;
			Если ОбъектXDTO &lt;&gt; Неопределено Тогда
				РекурсивноПостроитьСтруктуруEDI(ОбъектXDTO, ЭлементыТипаТЗ, ДанныеФайла, ОписаниеПримитивныхТипов, ОписаниеТипаТЗ);
			Иначе
				Продолжить;
			КонецЕсли;
			
			ЧтениеXMLДляТекущегоФайла.Закрыть();
			
			//&lt;Удаление временного файла&gt;
			Попытка
				УдалитьФайлы(ИмяВременногоФайла);
			Исключение				
				ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), "Предупреждение", ИмяСобытия);
				МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);				
				ЗаписьЖурналаРегистрации(НСтр("ru = 'Обработка ""Интеграция Docrobot""'"), УровеньЖурналаРегистрации.Ошибка, , , ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));				
			КонецПопытки;
			
			//&lt;Поиск ID цепочки по ID эл.документа&gt;
			НайденнаяСтрока   = ТаблицаДокументовAPI.Найти(СтрокаТаблицы.ИдентификаторДокумента, "docUUID");
			
			//&lt;Найденный ID цепочки присваиваем эл. документу&gt;
			Если НайденнаяСтрока &lt;&gt; Неопределено Тогда
				
				ДатаAPI = СтрЗаменить(НайденнаяСтрока.date, "-", "");
				ДатаAPI = СтрЗаменить(ДатаAPI, ":", "");
				ДатаAPI = СтрЗаменить(ДатаAPI, " ", "");
				
				ДанныеДокумента.Вставить("ИдентификаторЦепочки", НайденнаяСтрока.chainID);
				ДанныеДокумента.Вставить("ДатаСообщения", Дата(ДатаAPI));
				
			ИначеЕсли СтрокаТаблицы.ФайлЗагруженЛокально = Истина Тогда
				ДанныеДокумента.Вставить("ИдентификаторЦепочки", "TMP_" + СтрокаТаблицы.ИдентификаторДокумента);
				ДанныеДокумента.Вставить("ДатаСообщения", ТекущаяДата());
				
			Иначе				
				Комментарий = "По RECADV (Уведомление о приемке) № " + ДанныеФайла.NUMBER + " не найден идентификатор цепочки в списке полученных идентификаторов с сервера.";
				 
				DR_ДокументОбъект = СтрокаТаблицы.DR_Документ.ПолучитьОбъект();
				DR_ДокументОбъект.Комментарий = Комментарий;
				DR_ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
				
				ТекстЛогаСобытий = СтрокаТаблицы.Представление + " не обработан. Причина: " + Комментарий;
				ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
				МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
				
				Продолжить;				
			КонецЕсли;
			
			//&lt;Проверка дублей по DR_Документам со статусом "Загружен"&gt; 
			ЭлементКоллекции = ТаблицаНовДокументов.Найти(СтрокаТаблицы.ИдентификаторДокумента, "DocUUID");
			
			Если ЭлементКоллекции &lt;&gt; Неопределено Тогда
				
				//&lt;Изменям статус DR_Документа определенного как дубль&gt;
				DR_ДокументСсылка = ЭлементКоллекции.ДанныеДокумента.DR_Документ; 
				DR_ДокументОбъект = DR_ДокументСсылка.ПолучитьОбъект();
				DR_ДокументОбъект.Статус = "Архивный";
				DR_ДокументОбъект.ДанныеФайла = Новый ХранилищеЗначения(Неопределено);
				DR_ДокументОбъект.Комментарий = "Документ определен как дубль";
				
				ТабличнаяЧасть = DR_ДокументОбъект.ДополнительныеРеквизиты;
				
				НовСтр = ТабличнаяЧасть.Добавить();
				НовСтр.Реквизит = "НеОбрабатывать";
				НовСтр.Значение = Истина;
				DR_ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
				
				ТекстЛогаСобытий =  "В процессе обработки " + СтрокаТаблицы.Представление + ". " + Строка(DR_ДокументСсылка) + " определен как дубль и обработан не будет.";
				ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Предупреждение", ИмяСобытия);
				МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
				
				//&lt;Удаляем найденную запись из таблицы&gt;
				ТаблицаНовДокументов.Удалить(ЭлементКоллекции);
				
			КонецЕсли;
			
			ДанныеДокумента.Вставить("ИдентификаторДокумента"	, СтрокаТаблицы.ИдентификаторДокумента);
			ДанныеДокумента.Вставить("DR_Документ"				, СтрокаТаблицы.DR_Документ);
			ДанныеДокумента.Вставить("Статус"					, СтрокаТаблицы.СтатусДокумента);
			ДанныеДокумента.Вставить("ДанныеФайла"				, ДанныеФайла);
			ДанныеДокумента.Вставить("ДатаФайла"				, СтрокаТаблицы.ДатаФайла);
			
			//&lt;Классификатор валют&gt;
			КлассификаторВалюты = Новый Соответствие;
			КлассификаторВалюты.Вставить("RUB", 	643);
			КлассификаторВалюты.Вставить("KZT", 	398);
			КлассификаторВалюты.Вставить("UAH", 	980);
			КлассификаторВалюты.Вставить("USD",		840);
			КлассификаторВалюты.Вставить("EUR",		978);
			КлассификаторВалюты.Вставить("MDL",		498);
			КлассификаторВалюты.Вставить("BYR",		974);
			КлассификаторВалюты.Вставить("TMT",		934);
			КлассификаторВалюты.Вставить("UZS",		860);
			КлассификаторВалюты.Вставить("kz",		398);
			КлассификаторВалюты.Вставить("ru",		643);
			
			//&lt;БКВ - Буквенный код валюты. ЦКВ - цифровой код валюты.&gt;
			БКВ = Неопределено;
			ДанныеФайла.Свойство("CURRENCY", БКВ);
			
			//&lt;Получение валюты из классификатора валют по буквенному коду&gt;
			Если БКВ &lt;&gt; Неопределено Тогда
				ЦКВ = КлассификаторВалюты[БКВ];
				ВалютаСсылка = Справочники.Валюты.НайтиПоКоду(ЦКВ);
			Иначе //&lt;иначе получаем по коду страны из профиля обмена&gt;
				ЗапросКодаСтраны = Новый Запрос;
				ЗапросКодаСтраны.Текст = 
				"ВЫБРАТЬ
				|	ВЫРАЗИТЬ(DR_НастройкиДополнительныеРеквизиты.Значение КАК СТРОКА(3)) КАК Страна
				|ИЗ
				|	Справочник.DR_Настройки КАК DR_Настройки
				|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.DR_Настройки.ДополнительныеРеквизиты КАК DR_НастройкиДополнительныеРеквизиты
				|		ПО DR_Настройки.Ссылка = DR_НастройкиДополнительныеРеквизиты.Ссылка
				|			И (DR_Настройки.ВидНастройки = ""ПрофилиОбмена"")
				|ГДЕ
				|	DR_Настройки.ПометкаУдаления = ЛОЖЬ
				|	И DR_Настройки.Статус = ""Активный""
				|	И DR_НастройкиДополнительныеРеквизиты.Реквизит = ""Страна""";
				
				РезультатЗапроса = ЗапросКодаСтраны.Выполнить();
				ВыборкаЗапрос = РезультатЗапроса.Выбрать();
				
				ВыборкаЗапрос.Следующий();
				ЦКВ = КлассификаторВалюты.Получить(ВыборкаЗапрос.Страна);
				ВалютаСсылка = Справочники.Валюты.НайтиПоКоду(ЦКВ);
				
			КонецЕсли;
			
			//&lt;Добавление валюты&gt;
			ДанныеФайла.Вставить("Валюта", ВалютаСсылка);
			
			# Область ПодменыGLNПоТорговымСетям
			
			//&lt;В созданной структуре документа подмену не делаем. Оставляем как передала сеть. 
			//Для этого создаем отдельную структуру "ЭДО_GLN" заполняем ее с учетом подмен.
			//Полученную структуру преобразуем в Таблицу значений "HEAD" для поиска УчастниковЭДО в базе&gt;
			HEAD 	= Новый ТаблицаЗначений;
			ЭДО_GLN = Новый Структура;
			
			INVOICEPARTNER = Неопределено;
			ДанныеФайла.Свойство("INVOICEPARTNER", INVOICEPARTNER);
			
			АТАК = Неопределено;
			ДанныеФайла.Свойство("SENDERNAME", АТАК);
			
			INVOICEPARTNER = Неопределено;
			ДанныеФайла.Свойство("INVOICEPARTNER", INVOICEPARTNER);
			
			ЭДО_GLN.Вставить("BUYER"			, ДанныеФайла.BUYER);			//Покупатель
			ЭДО_GLN.Вставить("RECIPIENT"		, ДанныеФайла.RECIPIENT);		//Продавец
			ЭДО_GLN.Вставить("DELIVERYPLACE"	, ДанныеФайла.DELIVERYPLACE);	//Грузополучатель
			
			Если АТАК = "АТАК" Тогда//&lt;ТС АТАК&gt;				
				ЭДО_GLN.Вставить("BUYER", "4660000949998"); //				
			ИначеЕсли INVOICEPARTNER &lt;&gt; Неопределено Тогда //&lt;ТС Красное и белое&gt;				
				Если ДанныеФайла.BUYER &lt;&gt; ДанныеФайла.INVOICEPARTNER Тогда
					ЭДО_GLN.Вставить("BUYER", ДанныеФайла.INVOICEPARTNER);
				КонецЕсли;				
			ИначеЕсли ДанныеФайла.SENDER = "4607070199991" Тогда //&lt;ТС Метро&gt;
				ЭДО_GLN.Вставить("BUYER", ДанныеФайла.SENDER);	
			КонецЕсли;
				
			//&lt;Заполнение таблицы GLN&gt;
			ДобавитьСтрокуВТаблицуШапка(HEAD, ЭДО_GLN);
			ДанныеФайла.Вставить("HEAD", HEAD);
			
			#КонецОбласти
			
			//&lt;Добавление реквизитов по Участникам ЭДО для последующего их заполнения&gt;
			ДанныеФайла.Вставить("Организация"		, "");
			ДанныеФайла.Вставить("Контрагент"		, "");
			ДанныеФайла.Вставить("ТочкаДоставки"	, "");
			
			//&lt;..Для проверки необходимости получения данных из базы по участникам ЭДО&gt;
			ДанныеФайла.Вставить("ЗаполнитьУчастниковЭДО", Истина);
			//&lt;..Для проверки необходимости получения данных из базы по не сопостваленной Номенклатуры в первый раз&gt;
			ДанныеФайла.Вставить("ПервичныйПоискНоменклатуры", Истина);
			//&lt;..Для проверки необходимости обработки DR_Документа по кастомному условию&gt;
			ДанныеФайла.Вставить("НеОбрабатывать", Ложь);
			//&lt;..Для необходимости создания записи в РС DR_ЦепочкиДокументов на основании Уведомления о приемке&gt;
			ДанныеФайла.Вставить("СозданиеЦепочки", Истина);
			
			//&lt;Получение номера ORDER&gt;
			Если ДанныеФайла.Свойство("ORDERNUMBER") Тогда 
				ORDERNUMBER = ?(ВРег(ДанныеФайла.ORDERNUMBER) = "Б/Н", "", ДанныеФайла.ORDERNUMBER);
				ДанныеФайла.ORDERNUMBER = ORDERNUMBER;
			Иначе
				ДанныеФайла.Вставить("ORDERNUMBER", "");
			КонецЕсли;
			
			//&lt;Преобразование даты формата 2023-02-12 в формат 12.02.2022&gt;
			СтруктураДат = Новый Структура("DATE, ORDERDATE, DESADVDATE, DELIVERYNOTEDATE", "ДатаЭлектронногоДокумента", "ДатаЗаказа", "ДатаУвОбОтгрузке", "ДатаНакладной");
			
			Для каждого Элемент Из СтруктураДат Цикл 
				Если ДанныеФайла.Свойство(Элемент.Ключ) Тогда
					ДанныеФайла.Вставить(Элемент.Значение, Дата(СтрЗаменить(ДанныеФайла[Элемент.Ключ], "-", "")));	 	
				Иначе
					ДанныеФайла.Вставить(Элемент.Значение, Дата(0001,01,01));
				КонецЕсли;				
			КонецЦикла;
			
			//&lt;Если сеть не передала дату приемки, берем дату RECADV&gt;
			ДатаПриемки = ?(ДанныеФайла.Свойство("RECEPTIONDATE"), Дата(СтрЗаменить(ДанныеФайла.RECEPTIONDATE,"-","")), ДанныеФайла.ДатаЭлектронногоДокумента);
			ДанныеФайла.Вставить("ДатаПриемки", ДатаПриемки);
			
			//&lt;Получение номера Накладной&gt;
			НомерНакладной = "";
			
			//&lt;Первым проверяется DESADVNUMBER как часто передаваемый в RECADV&gt;
			Если ДанныеФайла.Свойство("DESADVNUMBER") Тогда
				НомерНакладной = ДанныеФайла.DESADVNUMBER;
			ИначеЕсли ДанныеФайла.Свойство("DELIVERYNOTENUMBER") Тогда
				НомерНакладной = ДанныеФайла.DELIVERYNOTENUMBER;	
			КонецЕсли;
			
			ТипСтрока = Новый ОписаниеТипов("Строка",,,, Новый КвалификаторыСтроки(200));
			ТипЧисло = Новый ОписаниеТипов("Число",,,Новый КвалификаторыЧисла(15,3));
			
			//&lt;Поля табличной части POSITION&gt;
			Поля = Новый Структура;
			Поля.Вставить("Номенклатура"		, ОписаниеТиповНоменклатура);
			Поля.Вставить("Характеристика"		, ОписаниеТиповХарактеристи);
			Поля.Вставить("ЕдиницаИзмерения"	, ОписаниеТиповЕдИзм);
			Поля.Вставить("КоличествоИзРТУ"		, ТипЧисло);
			Поля.Вставить("DESCRIPTION"			, ТипСтрока);
			Поля.Вставить("PRODUCTIDSUPPLIER"	, ТипСтрока);
			Поля.Вставить("ACCEPTEDUNIT"		, ТипСтрока);
			Поля.Вставить("ORDERUNIT"			, ТипСтрока);
			Поля.Вставить("PRICE"				, ТипЧисло);
			Поля.Вставить("PRICEWITHVAT"		, ТипЧисло);
			Поля.Вставить("VAT"					, ТипЧисло);
			Поля.Вставить("ORDERQUANTITY"		, ТипЧисло);
			Поля.Вставить("DELIVERQUANTITY"		, ТипЧисло);
			Поля.Вставить("QUANTITYOFCUINTU"	, ТипЧисло);
			Поля.Вставить("AMOUNTWITHVAT"		, ТипЧисло);
			Поля.Вставить("AMOUNT"				, ТипЧисло);
			Поля.Вставить("VATAMOUNT"			, ТипЧисло);
			
			POSITION = ДанныеФайла.POSITION;
			
			//&lt;Добавление полей в табличную часть POSITION&gt;
			Для каждого Поле Из Поля Цикл
				
				Если POSITION.Колонки.Найти(Поле.Ключ) = Неопределено Тогда
					POSITION.Колонки.Добавить(Поле.Ключ, Поле.Значение);
				КонецЕсли;
				
			КонецЦикла;
			
			//&lt;Преобразование строковых значений в число&gt;
			СуммыHEAD = Новый Структура("TOTALVAT, TOTALAMOUNT, TOTALAMOUNTWITHVAT", 0, 0, 0);
			
			Для каждого Элемент Из СуммыHEAD Цикл 
				Если ДанныеФайла.Свойство(Элемент.Ключ) Тогда
					ДанныеФайла[Элемент.Ключ] = ЭКОМ_ПреобразоватьВЧисло(ДанныеФайла[Элемент.Ключ]);	 	
				Иначе
					ДанныеФайла.Вставить(Элемент.Ключ, Элемент.Значение);
				КонецЕсли;				
			КонецЦикла;
			
			Для Каждого Стр Из POSITION Цикл
				
				Стр.POSITIONNUMBER      = ЭКОМ_ПреобразоватьВЧисло(Стр.POSITIONNUMBER);                                     //Порядковый номер строки
				Стр.PRICE		   		= ?(Стр.PRICE = "", 			0, ЭКОМ_ПреобразоватьВЧисло(Стр.PRICE));  			//Цена продукта без НДС
				Стр.PRICEWITHVAT  		= ?(Стр.PRICEWITHVAT = "",    	0, ЭКОМ_ПреобразоватьВЧисло(Стр.PRICEWITHVAT));		//Цена продукта с НДС		
				Стр.VAT 				= ?(Стр.VAT = "", 				0, ЭКОМ_ПреобразоватьВЧисло(Стр.VAT));          	//Ставка НДС
				Стр.ORDERQUANTITY 		= ?(Стр.ORDERQUANTITY = "", 	0, ЭКОМ_ПреобразоватьВЧисло(Стр.ORDERQUANTITY));	//Заказанное количество
				Стр.ACCEPTEDQUANTITY    = ЭКОМ_ПреобразоватьВЧисло(Стр.ACCEPTEDQUANTITY); 									//Принятое количество
				Стр.DELIVERQUANTITY     = ?(Стр.DELIVERQUANTITY = "", 	0, ЭКОМ_ПреобразоватьВЧисло(Стр.DELIVERQUANTITY));  //Поставляемое количество
				Стр.QUANTITYOFCUINTU  	= ?(Стр.QUANTITYOFCUINTU = "", 	0, ЭКОМ_ПреобразоватьВЧисло(Стр.QUANTITYOFCUINTU)); //Количество в упаковке
				
				Стр.AMOUNTWITHVAT 	= ?(Стр.AMOUNTWITHVAT = "", 	0, ЭКОМ_ПреобразоватьВЧисло(Стр.AMOUNTWITHVAT));  		//Сумма с НДС
				Стр.VATAMOUNT 		= ?(Стр.VATAMOUNT = "", 		0, ЭКОМ_ПреобразоватьВЧисло(Стр.VATAMOUNT));  	  		//Сумма НДС
				Стр.AMOUNT 			= ?(Стр.AMOUNT = "", 			0, ЭКОМ_ПреобразоватьВЧисло(Стр.AMOUNT));               //Сумма без НДС
				
			КонецЦикла;
			
			//////////////////////////////////////////////////////////////////////////////////////////////////////////
			//Для того, что бы не обрабатывать Новый DR_Документы необходимо, значение реквизита "НеОбрабатывать"	//
			//по условию установить в Истина. Условие может быть любым.												//
			//////////////////////////////////////////////////////////////////////////////////////////////////////////			
			
			//&lt;Пример&gt;			
			//МассивТочкеДоставок = новый Массив;
			//МассивТочкеДоставок.Добавить("9864398478404");
			//
			//Если НЕ МассивТочкеДоставок.Найти(ДанныеФайла.DELIVERYPLACE) = Неопределено Тогда
			//	ДанныеФайла.Вставить("НеОбрабатывать", Истина);
			//КонецЕсли;
			
			Если ДанныеФайла.НеОбрабатывать Тогда
				
				//&lt;Для Нового DR_Документа устанавливаем статус "Обработан"&gt;
				DR_ДокументОбъект = СтрокаТаблицы.DR_Документ.ПолучитьОбъект();
				DR_ДокументОбъект.Статус = "Архивный";
				DR_ДокументОбъект.ДанныеФайла = Новый ХранилищеЗначения(Неопределено);
				DR_ДокументОбъект.Комментарий = "Документ не был обработан по условию описанному в шаблоне ""RECADV входящий""";
				
				ТабличнаяЧасть = DR_ДокументОбъект.ДополнительныеРеквизиты;
				
				НовСтр = ТабличнаяЧасть.Добавить();
				НовСтр.Реквизит = "НеОбрабатывать";
				НовСтр.Значение = Истина;
				DR_ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);				
				
				Продолжить;
			КонецЕсли;		
			
			ChainID_RECADV = ДанныеДокумента.ИдентификаторЦепочки;
			
			//&lt;Параметр отбора для поиска ID цепочки ORDER&gt;
			ПараметрыОтбора.Вставить("ИдентификаторЦепочки", ChainID_RECADV);
			
			//&lt;Поиск ID цепочки ORDER по ID цепочки RECADV&gt;
			РезультатПоиска = ТаблицаIDЦепочкиORDER.НайтиСтроки(ПараметрыОтбора);
			
			Если РезультатПоиска.Количество() = 0 Тогда
				
				//&lt;Проверка переданого в RECADV номера заказа. Встречаются случаи, когда сети в RECADV номер заказа не передают&gt;
				Если ЗначениеЗаполнено(ДанныеФайла.ORDERNUMBER) Тогда
					
					//&lt;Поиск ID цепочки ORDER по номеру заказа и дате поставки&gt;
					Запрос = Новый Запрос;
					Запрос.Текст = 
					"ВЫБРАТЬ
					|	DR_ЦепочкиДокументов.ИдентификаторЦепочки КАК ИдентификаторЦепочки
					|ПОМЕСТИТЬ ВТ_ChainID
					|ИЗ
					|	РегистрСведений.DR_ЦепочкиДокументов КАК DR_ЦепочкиДокументов
					|ГДЕ
					|	DR_ЦепочкиДокументов.ДатаПоставки МЕЖДУ &amp;ДатаНач И &amp;ДатаКон
					|	И DR_ЦепочкиДокументов.НомерЗаказа = &amp;НомерЗаказа
					|;
					|
					|////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	ВТ_ChainID.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
					|	DR_Документ.Ссылка КАК DR_Документ
					|ПОМЕСТИТЬ ВТ_DR_Документ
					|ИЗ
					|	ВТ_ChainID КАК ВТ_ChainID
					|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ КАК DR_Документ
					|		ПО ВТ_ChainID.ИдентификаторЦепочки = DR_Документ.ИдентификаторЦепочки
					|ГДЕ
					|	DR_Документ.ВидДокумента = ""ORDER_входящий""
					|	И НЕ DR_Документ.ПометкаУдаления
					|;
					|
					|////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ РАЗЛИЧНЫЕ
					|	ВТ_DR_Документ.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
					|	ЕСТЬNULL(DR_События_Накладная.Документ, НЕОПРЕДЕЛЕНО) КАК Накладная,
					|	DR_События_Накладная.Идентификатор КАК ИдентификаторНакладной,
					|	Данные.Значение КАК GLN_ТочкиДоставки
					|ИЗ
					|	ВТ_DR_Документ КАК ВТ_DR_Документ
					|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.DR_События КАК DR_События_Накладная
					|		ПО ВТ_DR_Документ.ИдентификаторЦепочки = DR_События_Накладная.ИдентификаторЦепочки
					|			И (DR_События_Накладная.ВидДокумента = ""Накладная_Исходящая"")
					|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК Данные
					|		ПО ВТ_DR_Документ.DR_Документ = Данные.Ссылка
					|ГДЕ
					|	Данные.Реквизит = ""DELIVERYPLACE""";
					
					ДатаНач = ДатаПриемки - (КоличествоДнейОтДатыПоставки * 86400);
					
					Запрос.УстановитьПараметр("ДатаКон"		, КонецДня(ДатаПриемки));
					Запрос.УстановитьПараметр("ДатаНач"		, НачалоДня(ДатаНач));
					Запрос.УстановитьПараметр("НомерЗаказа" , ДанныеФайла.ORDERNUMBER);
					
					РезультатЗапроса = Запрос.Выполнить();
					
					Если НЕ РезультатЗапроса.Пустой() Тогда
						
						ТЗ = РезультатЗапроса.Выгрузить();
						
						СписокНакладные = ТЗ.Скопировать(,"Накладная,ИдентификаторНакладной");
						
						Выборка = РезультатЗапроса.Выбрать();
						
						Пока Выборка.Следующий() Цикл							
							//&lt;Если записей найдено несколько выполняем доп. проверку на равенство GLN Грузополучателей RECADV и ORDER&gt;
							Если Выборка.GLN_ТочкиДоставки = ДанныеФайла.DELIVERYPLACE Тогда
								ChainID_ORDER = Выборка.ИдентификаторЦепочки;
							КонецЕсли;
						КонецЦикла;
						
					Иначе
						
						/////////////////////////////////////////////////////////////////////////////////////////////////////////////
						//Алгоритм описанный ниже применяется на проектах по клиентам с активным трафиком.                         //
						//Т.е. когда заказы от сетей были получены через платформу другого провайдера, а уведомления о приемки     //
						//поступили через нашу платформу. В таком случае необходимо найти созданные 1С документы (Заказ, РТУ, СЧФ) //
						// и на основании полученных данных создать необходимые записи в РС DR_События.                            //
						//                                                                                                         //
						//Алгоритм может быть переписан на проекте в силу различия конфигураций по типам документов (и т.п.)       //
						//или же вовсе убран из шаблона.																		   //
						/////////////////////////////////////////////////////////////////////////////////////////////////////////////
						
						//&lt;Начало алгоритма&gt;
						Если ПереводТрафика И ЗначениеЗаполнено(НомерНакладной) Тогда
							
							Запрос = Новый Запрос;
							Запрос.Текст = 
							"ВЫБРАТЬ
							|	РеализацияТоваровУслуг.Ссылка КАК Ссылка,
							|	РеализацияТоваровУслуг.Номер КАК Номер
							|ПОМЕСТИТЬ ВТ_РТУ
							|ИЗ
							|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
							|ГДЕ
							|	РеализацияТоваровУслуг.Дата МЕЖДУ &amp;ДатаНачал И &amp;ДатаКонец
							|;
							|
							|////////////////////////////////////////////////////////////////////////////////
							|ВЫБРАТЬ
							|	ВТ_РТУ.Ссылка КАК Ссылка,
							|	ВЫРАЗИТЬ(ВТ_РТУ.Ссылка.ЗаказКлиента КАК Документ.ЗаказКлиента) КАК ЗаказКлиента
							|ПОМЕСТИТЬ ВТ_Заказ
							|ИЗ
							|	ВТ_РТУ КАК ВТ_РТУ
							|ГДЕ
							|	ВТ_РТУ.Номер ПОДОБНО &amp;DESADVNUMBER
							|;
							|
							|////////////////////////////////////////////////////////////////////////////////
							|ВЫБРАТЬ
							|	СчетФактураВыданный.Ссылка КАК Ссылка,
							|	ВЫРАЗИТЬ(СчетФактураВыданный.ДокументОснование КАК Документ.РеализацияТоваровУслуг) КАК ДокументОснование
							|ПОМЕСТИТЬ ВТ_СЧФ
							|ИЗ
							|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
							|ГДЕ
							|	СчетФактураВыданный.ДокументОснование В
							|			(ВЫБРАТЬ
							|				ВТ_Заказ.Ссылка
							|			ИЗ
							|				ВТ_Заказ КАК ВТ_Заказ)
							|;
							|
							|////////////////////////////////////////////////////////////////////////////////
							|ВЫБРАТЬ
							|	ЕСТЬNULL(ВТ_Заказ.ЗаказКлиента, НЕОПРЕДЕЛЕНО) КАК Заказ,
							|	ВТ_Заказ.Ссылка КАК Накладная,
							|	ЕСТЬNULL(ВТ_СЧФ.Ссылка, НЕОПРЕДЕЛЕНО) КАК СЧФ
							|ИЗ
							|	ВТ_Заказ КАК ВТ_Заказ
							|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СЧФ КАК ВТ_СЧФ
							|		ПО (ВТ_СЧФ.ДокументОснование = ВТ_Заказ.Ссылка)";
							
							//&lt;Для поиска по номеру из переменной "НомерНакладной", убираем префикс и лидирующие нули&gt;
							НомерНакладной = ЭКОМ_ПолучитьНомерНаПечать(НомерНакладной, Истина, Истина);
							
							Запрос.УстановитьПараметр("DESADVNUMBER"	, "%" + НомерНакладной);
							Запрос.УстановитьПараметр("ДатаКонец"		, КонецДня(ДатаПриемки));
							Запрос.УстановитьПараметр("ДатаНачал"		, НачалоДня(ДатаНач));
							
							РезультатЗапроса = Запрос.Выполнить();
							
							Если НЕ РезультатЗапроса.Пустой() Тогда
								
								ТаблицаЗаписей = РезультатЗапроса.Выгрузить();
								
								Если НЕ ТаблицаЗаписей.Количество() = 0 Тогда
									
									НачатьТранзакцию();
									
									Попытка										
										СтруктураРСDR_События = Новый Структура;
										
										Для Каждого Запись Из ТаблицаЗаписей Цикл	
											
											//&lt;Если в результате выборки были найдены записи по нескольким накладным&gt;
											//&lt;Тогда необходимо добавить условие доп. проверки для получения нужной накладной по данным рекадв&gt;
											
											//....Код доп. проверки
											
											ИдентификаторОснования = "";
											ИдентификаторСсылки = "";
											
											Для Каждого Колонка Из ТаблицаЗаписей.Колонки Цикл
												
												ТекЯчейка = Запись[Колонка.Имя];
												
												Если ЗначениеЗаполнено(ТекЯчейка) Тогда
													
													Если Колонка.Имя = "Заказ" Тогда
														
														ВидДокумента = "Заказ_Входящий";
														ИдентификаторСсылки =  ТекЯчейка.УникальныйИдентификатор();
														
													ИначеЕсли Колонка.Имя = "Накладная" Тогда
														
														ИдентификаторОснования = ИдентификаторСсылки;
														ВидДокумента = "Накладная_Исходящая";
														ИдентификаторСсылки =  ТекЯчейка.УникальныйИдентификатор();
														//&lt;ID основания для события RECADV&gt;
														ДанныеФайла.Вставить("ИдентификаторОснования", ИдентификаторСсылки);
														ДанныеФайла.Вставить("Накладная1С", ТекЯчейка);
														
													ИначеЕсли Колонка.Имя = "СЧФ" Тогда
														
														ИдентификаторОснования = ИдентификаторСсылки;
														ВидДокумента = "СчетФактура_Исходящий";
														ИдентификаторСсылки =  ТекЯчейка.УникальныйИдентификатор();
														
													КонецЕсли;
													
													СтруктураРСDR_События.Вставить("ИдентификаторЦепочки"	, ChainID_RECADV);
													СтруктураРСDR_События.Вставить("ДатаЗаписи"				, ТекущаяДата());
													СтруктураРСDR_События.Вставить("Документ"				, ТекЯчейка);
													СтруктураРСDR_События.Вставить("ВидДокумента"			, ВидДокумента);
													СтруктураРСDR_События.Вставить("Идентификатор"			, ИдентификаторСсылки);
													СтруктураРСDR_События.Вставить("ИдентификаторОснования"	, ИдентификаторОснования);
													
													НЗ_DRСобытия = РегистрыСведений.DR_События.СоздатьНаборЗаписей();
													НЗ_DRСобытия.Отбор.ИдентификаторЦепочки.Установить(СтруктураРСDR_События.ИдентификаторЦепочки);
													НЗ_DRСобытия.Отбор.Документ.Установить(СтруктураРСDR_События.Документ);
													НЗ_DRСобытия.Отбор.ВидДокумента.Установить(СтруктураРСDR_События.ВидДокумента);
													НЗ_DRСобытия.Отбор.Идентификатор.Установить(СтруктураРСDR_События.Идентификатор);
													НЗ_DRСобытия.Прочитать();
													
													Если НЗ_DRСобытия.Количество() = 0 Тогда
														НоваяЗапись = НЗ_DRСобытия.Добавить();
													Иначе
														НоваяЗапись = НЗ_DRСобытия[0];
													КонецЕсли;
													
													Для Каждого Элемент Из СтруктураРСDR_События Цикл			
															НоваяЗапись[Элемент.Ключ] = Элемент.Значение; 	
													КонецЦикла;
													
													НЗ_DRСобытия.Записать();
													
												КонецЕсли;
											КонецЦикла;
											
										КонецЦикла;
										
										ЗафиксироватьТранзакцию();
										
									Исключение
										
										ОтменитьТранзакцию();
										
										ПредставлениеДокументаXML = "RECADV (Уведомление о приемке)" + " № " + ДанныеФайла.NUMBER + " от " + Формат(ДанныеФайла.ДатаЭлектронногоДокумента, "ДЛФ=D");
										ТекстЛогаСобытий = "На основании " + ПредставлениеДокументаXML + " формирование записей по документам 1С в РС DR_события "
																+ " не выполнено. По причине - " + ОписаниеОшибки();
										ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
										МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);										
										ЗаписьЖурналаРегистрации("Обработка ""Интеграция Docrobot""", УровеньЖурналаРегистрации.Ошибка, , , "Описание ошибки - " + ОписаниеОшибки());
										
										Продолжить;										
									КонецПопытки;
									
								КонецЕсли;
								
							КонецЕсли;
							
						КонецЕсли;
						
						//&lt;/Конец алгоритма&gt;
						
					КонецЕсли;
					
				КонецЕсли;
				
			Иначе				
				ChainID_ORDER = ChainID_RECADV;				
			КонецЕсли;
			
			//&lt;Получение ID основания и ссылки накладной по RECADV&gt;
			Если ЗначениеЗаполнено(НомерНакладной) И ЗначениеЗаполнено(ChainID_ORDER) Тогда				
				//&lt;Для сравнения по номеру полученному из RECADV, убираем префикс и лидирующие нули&gt;
				ЭлНомерНакладной = ЭКОМ_ПолучитьНомерНаПечать(НомерНакладной, Истина, Истина);
				
				Если РезультатПоиска.Количество() &gt; 0 Тогда					
					//&lt;В результате может быть более одной записи, например разделение заказа на две поставки&gt;
					Для каждого ЭлементМассива Из РезультатПоиска Цикл						
						//&lt;Убираем префикс и лидирующие нули из полученного номера накладной 1С&gt;
						НомерНакладной1С = ЭКОМ_ПолучитьНомерНаПечать(ЭлементМассива.Накладная, Истина, Истина);
						
						Если ЭлНомерНакладной = НомерНакладной1С Тогда
							ДанныеФайла.Вставить("ИдентификаторОснования", ЭлементМассива.ИдентификаторНакладной);
							ДанныеФайла.Вставить("Накладная1С", ЭлементМассива.Накладная); 
						КонецЕсли;
						
					КонецЦикла;
					
				Иначе					
					Для каждого Стр Из СписокНакладные Цикл 
						
						Если ЗначениеЗаполнено(Стр.Накладная) Тогда							
							//&lt;Убираем префикс и лидирующие нули из полученного номера накладной 1С&gt;
							НомерНакладной1С = ЭКОМ_ПолучитьНомерНаПечать(Стр.Накладная, Истина, Истина);
							
							Если ЭлНомерНакладной = НомерНакладной1С Тогда 
								ДанныеФайла.Вставить("ИдентификаторОснования", Стр.ИдентификаторНакладной);
								ДанныеФайла.Вставить("Накладная1С", Стр.Накладная);
							КонецЕсли;	
						КонецЕсли;
						
					КонецЦикла;					
				КонецЕсли;
				
			КонецЕсли;	
			
			//&lt;Если ID цепочки ORDER получен, тогда присваиваем его RECADV&gt;
			//&lt;Создание цепочки по RECADV не производится&gt; 
			Если ЗначениеЗаполнено(ChainID_ORDER) Тогда
				ДанныеДокумента.Вставить("ИдентификаторЦепочки", ChainID_ORDER);
				ДанныеФайла.Вставить("СозданиеЦепочки", Ложь);
			КонецЕсли;
			
			НовЭлКоллекции 				   = ТаблицаНовДокументов.Добавить();	
			НовЭлКоллекции.ChainID		   = ДанныеДокумента.ИдентификаторЦепочки;		
			НовЭлКоллекции.DocUUID         = ДанныеДокумента.ИдентификаторДокумента;
			НовЭлКоллекции.ДатаФайла       = ДанныеДокумента.ДатаФайла;
			НовЭлКоллекции.ДанныеДокумента = ДанныеДокумента;
			
			//&lt;Заполняем массивы для передачи в ЗапросПоискДублей&gt;
			DocUUID.Добавить(ДанныеДокумента.ИдентификаторДокумента);
			ChainID.Добавить(ДанныеДокумента.ИдентификаторЦепочки);
			
		КонецЦикла;
		
		//&lt;Очищаем коллекцию, данные которой уже не нужны&gt;
		ТаблицаЗагруженных = Неопределено;
		
		#КонецОбласти
		
		#Область ОбработкаКоллекцииДанных
		
		ЗапросПоискДублей = Новый Запрос;
		ЗапросПоискДублей.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	DR_Документ.Ссылка КАК DR_Документ,
		|	ПРЕДСТАВЛЕНИЕ(DR_Документ.Ссылка) КАК Представление,
		|	DR_Документ.Статус КАК СтатусДокумента,
		|   DR_Документ.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
		|   DR_Документ.ИдентификаторДокумента КАК ИдентификаторДокумента
		|ИЗ
		|	Документ.DR_Документ КАК DR_Документ
		|ГДЕ
		|	DR_Документ.ИдентификаторЦепочки В(&amp;ИдентификаторЦепочки)
		|	И DR_Документ.ИдентификаторДокумента В(&amp;ИдентификаторДокумента)
		|	И НЕ DR_Документ.ПометкаУдаления";
		
		ЗапросПоискДублей.УстановитьПараметр("ИдентификаторЦепочки"		, ChainID);
		ЗапросПоискДублей.УстановитьПараметр("ИдентификаторДокумента"	, DocUUID); 
		
		РезультатЗапроса 		 = ЗапросПоискДублей.Выполнить(); 
		ТаблицаDR_ДокументовПоID = РезультатЗапроса.Выгрузить();
		ТаблицаDR_ДокументовПоID.Индексы.Добавить("ИдентификаторЦепочки, ИдентификаторДокумента");
		
		//&lt;Выполняем сортировку документов в порядке их появления на FTP, т.е. в рамках цепочки по дате файла&gt;
		ТаблицаНовДокументов.Сортировать("ChainID, ДатаФайла");
		
		//&lt;ТаблицаНовДокументов - Тип ТаблицаЗначений&gt;
		//&lt;Поля&gt;
		//    &lt;ChainID 	- Тип Строка (Идентификатор цепочки)&gt;
		//    &lt;DocUIID 	- Тип Строка (Идентификатор документа)&gt;
		//    &lt;ДатаФайла - Тип Дата&gt;
		//    &lt;ДанныеДокумента 	- Тип Структура&gt;:
		//      	&lt;Ключ&gt;:
		//			- ДанныеФайла - Тип Структура
		//			- ИдентификаторДокумента - Тип Строка
		//			- ИдентификаторЦепочки - Тип Строка
		//			- DR_Документ - Тип ДокументСсылка.DR_Документ
		//			- Статус - Тип Строка
		//			- ДатаФайла - Тип Дата
		
		Для каждого Элемент ИЗ ТаблицаНовДокументов Цикл
			
			МассивНеСопоставленныхШК = Новый Массив;
			
			//&lt;Тип - Структура&gt;
			ДанныеДокумента 			= Элемент.ДанныеДокумента;
			ДанныеФайла				    = ДанныеДокумента.ДанныеФайла;  
			СтруктураРегистра_DRСобытия	= Новый Структура;
			СтруктураРегистра_DRЦепочки	= Новый Структура;
			ПараметрыОтбора				= Новый Структура;
			
			DR_ДокументСсылка = ДанныеДокумента.DR_Документ; 
			
			//&lt;Тип - Строка&gt;
			ИдентификаторДокумента	= ДанныеДокумента.ИдентификаторДокумента;
			ИдентификаторЦепочки	= ДанныеДокумента.ИдентификаторЦепочки;
			СтатусДокумента			= "НеОбработан";
			ТекстОшибки 			= "";
			Комментарий				= "";
			ЗаписьСообщение			= "";
			
			СоответствиеУчастникиЭДО   = Новый Соответствие;
			СоответствиеПоНоменклатуре = Новый Соответствие;
			
			//&lt;Параметры отбора для поиска дублей&gt;
			ПараметрыОтбора.Вставить("ИдентификаторЦепочки"		, ИдентификаторЦепочки);
			ПараметрыОтбора.Вставить("ИдентификаторДокумента"	, ИдентификаторДокумента);
			
			//&lt;Поиск дублей. РезультатПоиска - тип Массив&gt;
			РезультатПоиска = ТаблицаDR_ДокументовПоID.НайтиСтроки(ПараметрыОтбора);
			
			//&lt;Проверка на дубли по DR_Документам со статусом "Обработан" или "Не обработан" найденных по установленному отбору&gt;
			Если РезультатПоиска.Количество() &lt;&gt; 0 Тогда
				
				ЭлементМассива = РезультатПоиска[0];
				
				Если ВРег(ЭлементМассива.СтатусДокумента) = "НЕОБРАБОТАН" 
					ИЛИ ВРег(ЭлементМассива.СтатусДокумента) = "ОБРАБОТАН" Тогда 
					
					//&lt;Для Нового DR_Документа изменяем статус&gt;
					DR_ДокументОбъект = DR_ДокументСсылка.ПолучитьОбъект();
					DR_ДокументОбъект.Статус = "Архивный";
					DR_ДокументОбъект.ДанныеФайла = Новый ХранилищеЗначения(Неопределено);
					DR_ДокументОбъект.Комментарий = "Документ является дублем по ранее созданному " + ЭлементМассива.Представление;
					
					ТабличнаяЧасть = DR_ДокументОбъект.ДополнительныеРеквизиты;
					
					НовСтр = ТабличнаяЧасть.Добавить();
					НовСтр.Реквизит = "НеОбрабатывать";
					НовСтр.Значение = Истина;
					DR_ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
					
					Причина = "Документ является дублем по ранее созданному " + ЭлементМассива.Представление; 
					ТекстЛогаСобытий = Строка(DR_ДокументСсылка) + " не обработан. Причина: " + Причина;
					ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Предупреждение", ИмяСобытия);
					МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
					
					Продолжить;					
				КонецЕсли;
				
			КонецЕсли;
			
			//&lt;Поиск и заполнение Участников ЭДО&gt;
			Запрос = Новый Запрос;	
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	ПОДСТРОКА(ТаблицаGLN.RECIPIENT		, 1, 13) КАК xmlОрганизацияGLN,
			|	ПОДСТРОКА(ТаблицаGLN.BUYER			, 1, 13) КАК xmlКонтрагентGLN,
			|	ПОДСТРОКА(ТаблицаGLN.DELIVERYPLACE	, 1, 13) КАК xmlТочкаДоставкиGLN
			|ПОМЕСТИТЬ ВТ_УчастиникиЭДО
			|ИЗ
			|	&amp;ТаблицаGLN КАК ТаблицаGLN
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ЭКОМ_GLN_Организация.Объект КАК Организация,
			|	ЭКОМ_GLN_Контрагент.Объект КАК Контрагент,
			|	ЭКОМ_ТочкиДоставки.Объект КАК ТочкаДоставки
			|ИЗ
			|	ВТ_УчастиникиЭДО КАК ВТ_УчастиникиЭДО
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_GLN КАК ЭКОМ_GLN_Организация
			|		ПО ВТ_УчастиникиЭДО.xmlОрганизацияGLN = ЭКОМ_GLN_Организация.GLN
			|			И (НЕ ЭКОМ_GLN_Организация.Объект ССЫЛКА Справочник.Контрагенты)
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_GLN КАК ЭКОМ_GLN_Контрагент
			|		ПО ВТ_УчастиникиЭДО.xmlКонтрагентGLN = ЭКОМ_GLN_Контрагент.GLN
			|			И (ЭКОМ_GLN_Контрагент.Объект ССЫЛКА Справочник.Контрагенты)
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_ТочкиДоставки КАК ЭКОМ_ТочкиДоставки
			|		ПО ВТ_УчастиникиЭДО.xmlТочкаДоставкиGLN = ЭКОМ_ТочкиДоставки.GLN
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	ВТ_УчастиникиЭДО.xmlОрганизацияGLN,
			|	ВТ_УчастиникиЭДО.xmlКонтрагентGLN,
			|	ВТ_УчастиникиЭДО.xmlТочкаДоставкиGLN
			|ИЗ
			|	ВТ_УчастиникиЭДО КАК ВТ_УчастиникиЭДО";
			
			ТаблицаGLN = ДанныеФайла.HEAD;
			
			Запрос.УстановитьПараметр("ТаблицаGLN", ТаблицаGLN);
			
			РезультатЗапроса = Запрос.Выполнить();
			УчастникиЭДО = РезультатЗапроса.Выгрузить();
			
			Для Каждого Колонка Из УчастникиЭДО.Колонки Цикл
				
				Ссылка = УчастникиЭДО[0][Колонка.Имя];
				GLN = УчастникиЭДО[1][Колонка.Имя];
				
				Если ЗначениеЗаполнено(Ссылка) Тогда					
					ДанныеФайла[Колонка.Имя] = Ссылка;					
				Иначе					
					ТекстОшибки = ТекстОшибки + ?(ЗначениеЗаполнено(ТекстОшибки), Символы.ПС, "")
									+ "Не заполнен(а) " + Колонка.Имя + " (" + GLN + ")";
					
					СоотвествиеУчастник = Новый Соответствие;
					СоотвествиеУчастник.Вставить(Колонка.Имя + "_" + GLN, GLN);
					СоответствиеУчастникиЭДО.Вставить(Колонка.Имя + "_", СоотвествиеУчастник);					
				КонецЕсли;
				
			КонецЦикла;                                                     
			
			Если ПустаяСтрока(ТекстОшибки) Тогда 
				ДанныеФайла.ЗаполнитьУчастниковЭДО = Ложь;	
			КонецЕсли;
			
			//&lt;Поиск и заполнение номенклатуры&gt;
			Если ЗначениеЗаполнено(ДанныеФайла["Контрагент"]) Тогда
				
				ДанныеФайла.ПервичныйПоискНоменклатуры = Ложь;
				
				ЗапросНоменклатуры = Новый Запрос;
				ЗапросНоменклатуры.Текст =
				"ВЫБРАТЬ
				|	ВЫРАЗИТЬ(ТЧ_Товары.PRODUCT КАК СТРОКА(30)) КАК Штрихкод,
				|	&amp;Контрагент КАК Контрагент
				|ПОМЕСТИТЬ ВТ
				|ИЗ
				|	&amp;ТЧ_Товары КАК ТЧ_Товары
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ.Штрихкод КАК Штрихкод,
				|	ЕСТЬNULL(ЭКОМ_НоменклатураКонтрагентов.Номенклатура, НЕОПРЕДЕЛЕНО) КАК Номенклатура,
				|	ЕСТЬNULL(ЭКОМ_НоменклатураКонтрагентов.ХарактеристикаНоменклатуры, НЕОПРЕДЕЛЕНО) КАК ХарактеристикаНоменклатуры,
				|	ЕСТЬNULL(ЭКОМ_НоменклатураКонтрагентов.ЕдиницаНоменклатурыКонтрагента, НЕОПРЕДЕЛЕНО) КАК ЕдиницаИзмерения,
				|	ЕСТЬNULL(ЭКОМ_GLN.РасчетСумм, Ложь) КАК РасчетСумм
				|ИЗ
				|	ВТ КАК ВТ
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_НоменклатураКонтрагентов КАК ЭКОМ_НоменклатураКонтрагентов
				|		ПО ВТ.Контрагент = ЭКОМ_НоменклатураКонтрагентов.Контрагент
				|			И ВТ.Штрихкод = ЭКОМ_НоменклатураКонтрагентов.ШтрихКодНоменклатурыКонтрагента
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_GLN КАК ЭКОМ_GLN
				|		ПО (ЭКОМ_GLN.Объект = &amp;Контрагент)";
				
				POSITION = ДанныеФайла.POSITION;
				
				ЗапросНоменклатуры.УстановитьПараметр("ТЧ_Товары", POSITION.Скопировать(, "PRODUCT"));
				ЗапросНоменклатуры.УстановитьПараметр("Контрагент", ДанныеФайла.Контрагент);
				
				РезультатЗапроса = ЗапросНоменклатуры.Выполнить();
				СписокНоменклатуры = РезультатЗапроса.Выгрузить();
				
				POSITION.Индексы.Добавить("PRODUCT");
				
				ИтогСуммаНДС = 0;     //Общая Сумма налога
				ИтогСуммаБезНДС = 0;  //Общая Сумма без НДС
				ИтогСуммаСНДС = 0; 	  //Общая Сумма с НДС
				
				ЗаголовокРасхождений = "";				
				НакладнаяНайдена = Ложь;
				
				//&lt;Получение данных табличной части Накладной&gt;
				Если ДанныеФайла.Свойство("Накладная1С") Тогда
					
					НакладнаяСсылка = ДанныеФайла.Накладная1С;
					
					//&lt;Определение имени табличной части Накладной, взависимости от конфигурации&gt;	
					Если НакладнаяСсылка.Метаданные().ТабличныеЧасти.Найти("Запасы") = Неопределено Тогда 
						ИмяТабЧасти = "Товары";
					Иначе
						ИмяТабЧасти = "Запасы";
					КонецЕсли;
					
					ТЧНакладная = НакладнаяСсылка[ИмяТабЧасти].Выгрузить(, "Номенклатура, Количество");					
					//&lt;Группировка на случай партионного учета&gt;
					ТЧНакладная.Свернуть("Номенклатура", "Количество");
					
					НакладнаяНайдена = Истина;
					
				КонецЕсли;
				
				Для каждого Строка Из СписокНоменклатуры Цикл
					
					PRODUCT = СокрЛП(Строка.Штрихкод);
					НайденнаяСтрока = POSITION.Найти(PRODUCT, "PRODUCT");
					
					//&lt;Построчный расчет сумм&gt;
					Если Строка.РасчетСумм Тогда
						
						ЦенаБезНДС		= НайденнаяСтрока.PRICE;  			
						ЦенаСНДС   		= НайденнаяСтрока.PRICEWITHVAT;				
						ПринятоеКол 	= НайденнаяСтрока.ACCEPTEDQUANTITY;	
						
						СуммаСНДС 	= НайденнаяСтрока.AMOUNTWITHVAT;  	
						СуммаНДС	= НайденнаяСтрока.VATAMOUNT;  		
						СуммаБезНДС = НайденнаяСтрока.AMOUNT; 			
						
						Если ЦенаСНДС &lt;&gt; 0 Тогда
							СуммаСНДС = Окр(ЦенаСНДС * ПринятоеКол, 2);	
						КонецЕсли;
						
						Если ЦенаБезНДС &lt;&gt; 0 Тогда
							СуммаБезНДС = Окр(ЦенаБезНДС * ПринятоеКол, 2);
						КонецЕсли;
						
						Если СуммаСНДС &lt;&gt; 0 И СуммаБезНДС &lt;&gt; 0 Тогда
							СуммаНДС    = Окр(СуммаСНДС - СуммаБезНДС, 2);
						КонецЕсли;
						
						НайденнаяСтрока.AMOUNTWITHVAT 	= СуммаСНДС;  	
						НайденнаяСтрока.VATAMOUNT		= СуммаНДС;  		
						НайденнаяСтрока.AMOUNT 			= СуммаБезНДС; 			
						
						Если СуммаСНДС &lt;&gt; 0 И СуммаБезНДС &lt;&gt; 0 И СуммаНДС &lt;&gt; 0 Тогда
							
							ИтогСуммаНДС    = ИтогСуммаНДС + СуммаНДС;
							ИтогСуммаБезНДС = ИтогСуммаБезНДС + СуммаБезНДС;
							ИтогСуммаСНДС	= ИтогСуммаСНДС + СуммаСНДС;
							
						ИначеЕсли СуммаСНДС &lt;&gt; 0 И СуммаБезНДС &lt;&gt; 0 Тогда
							
							СуммаНДС = СуммаСНДС - СуммаБезНДС;
							
							ИтогСуммаНДС    = ИтогСуммаНДС + СуммаНДС;
							ИтогСуммаБезНДС = ИтогСуммаБезНДС + СуммаБезНДС;
							ИтогСуммаСНДС 	= ИтогСуммаСНДС + СуммаСНДС;
							
						КонецЕсли;
						
					КонецЕсли;				
					
					Если ЗначениеЗаполнено(Строка.Номенклатура) Тогда					
						
						НайденнаяСтрока.Номенклатура 		= Строка.Номенклатура;
						НайденнаяСтрока.Характеристика 		= Строка.ХарактеристикаНоменклатуры;
						НайденнаяСтрока.ЕдиницаИзмерения 	= Строка.ЕдиницаИзмерения;
						
						//&lt;Заполнение количества из Накладной по сопоставленной номенклатуре&gt; 
						Если НакладнаяНайдена Тогда 
							
							СтрокаТЧ = ТЧНакладная.Найти(Строка.Номенклатура,"Номенклатура"); 
							
							Если СтрокаТЧ &lt;&gt; Неопределено Тогда    
								НайденнаяСтрока.КоличествоИзРТУ = СтрокаТЧ.Количество;
							Иначе
								Комментарий = Комментарий + ?(ЗначениеЗаполнено(Комментарий), Символы.ПС, "")
											+ "Позиция № " + НайденнаяСтрока.POSITIONNUMBER + ". Не соответствие данных с накладной";	
							КонецЕсли;		
							
						КонецЕсли;
						
					Иначе
						
						//&lt;Заполняем массив ШК по которым не найдено сопоставление&gt;
						МассивНеСопоставленныхШК.Добавить(PRODUCT);
						
						ТекстОшибки = ТекстОшибки + ?(ЗначениеЗаполнено(ТекстОшибки), Символы.ПС, "")
									+ "Позиция № " + НайденнаяСтрока.POSITIONNUMBER + ". Не заполнена номенклатура по штрихкоду - " 
									+ "(" + НайденнаяСтрока.PRODUCT + ")";
						
						Код = ?(ЗначениеЗаполнено(НайденнаяСтрока.PRODUCT), НайденнаяСтрока.PRODUCT, НайденнаяСтрока.PRODUCTIDBUYER) + "_" + ДанныеФайла.HEAD[0].BUYER;
						
						СоответствиеПоНоменклатуре.Вставить("АртикулНоменклатурыКонтрагента_"      + Код, НайденнаяСтрока.PRODUCTIDSUPPLIER);
						СоответствиеПоНоменклатуре.Вставить("КодНоменклатурыКонтрагента_"          + Код, НайденнаяСтрока.PRODUCTIDBUYER);
						СоответствиеПоНоменклатуре.Вставить("ШтрихКодНоменклатурыКонтрагента_"     + Код, НайденнаяСтрока.PRODUCT);
						СоответствиеПоНоменклатуре.Вставить("НаименованиеНоменклатурыКонтрагента_" + Код, НайденнаяСтрока.DESCRIPTION);
						СоответствиеПоНоменклатуре.Вставить("ЕдиницаНоменклатурыКонтрагента_"      + Код, Строка.ЕдиницаИзмерения);
						СоответствиеПоНоменклатуре.Вставить("Контрагент_"                          + Код, ДанныеФайла.Контрагент);
						СоответствиеПоНоменклатуре.Вставить("xmlЕдиницаИзмерения_"                 + Код, НайденнаяСтрока.ACCEPTEDUNIT);
						
					КонецЕсли;
					
				КонецЦикла;
				
				Для каждого Строка Из POSITION Цикл
					
					//&lt;Определение значения поставленного количества&gt;
					КолПоставленное = 0;
					
					//&lt;Если в RECADV передан элемент DELIVERQUANTITY, тогда значение берем из элемента&gt;
					Если Строка.DELIVERQUANTITY &lt;&gt; 0 Тогда
						КолПоставленное = Строка.DELIVERQUANTITY;
					ИначеЕсли ЗначениеЗаполнено(Строка.КоличествоИзРТУ) Тогда //&lt;Иначе пробуем получить значение из Накладной&gt;
						КолПоставленное = Строка.КоличествоИзРТУ;
					КонецЕсли;
					
					//&lt;Проверяются кейсы, когда поставляемое количество передано либо в RECADV, либо получено из накладной&gt;
					//&lt;Возможен кейс когда: в RECADV не передано DELIVERQUANTITY и накладная найдена, но не сопоставлена номенкатура&gt;
					//&lt;Попытка повторной обработки сравнения принятого и поставленного количества,&gt;
					//&lt;будет выполнена в процессе повторной обработки DR_Документа&gt;
					Если КолПоставленное &lt;&gt; 0 Тогда
						
						//&lt;Сравнение принятого количества с поставленным&gt;
						Если Строка.ACCEPTEDQUANTITY &lt;&gt; КолПоставленное Тогда
							
							Комментарий = Комментарий + ?(ЗначениеЗаполнено(Комментарий), Символы.ПС, "")
							+ "Позиция № " + Строка.POSITIONNUMBER + "."
							+ " Штрихкод " + Строка.PRODUCT 
							+ ?(ЗначениеЗаполнено(Строка.DESCRIPTION), " (" + Строка.DESCRIPTION + ")", "") 
							+ " принято - " + Формат(Строка.ACCEPTEDQUANTITY,"ЧДЦ=3; ЧРД=.; ЧН=0; ЧГ=0") 
							+ ", поставлено - " + Формат(КолПоставленное,"ЧДЦ=3; ЧРД=.; ЧН=0; ЧГ=0");
							
							Если НЕ ЗначениеЗаполнено(ЗаголовокРасхождений) Тогда
								ЗаголовокРасхождений = "В следующих позициях есть расхождения:" + Символы.ПС;
							КонецЕсли;
							
						КонецЕсли;
						
					ИначеЕсли НЕ НакладнаяНайдена Тогда //Проверка покрывает кейс: DELIVERQUANTITY равно нулю и по строке нет сопоставления.  
						
						Комментарий = Комментарий + ?(ЗначениеЗаполнено(Комментарий), Символы.ПС, "")
						+ "Позиция № " + Строка.POSITIONNUMBER + "."
						+ " Штрихкод " + Строка.PRODUCT 
						+ ?(ЗначениеЗаполнено(Строка.DESCRIPTION), " (" + Строка.DESCRIPTION + ")", "") 
						+ " принято - " + Формат(Строка.ACCEPTEDQUANTITY,"ЧДЦ=3; ЧРД=.; ЧН=0; ЧГ=0")
						+ ". Поставленное количество определить не удалось, выполните сверку вручную.";
						
					КонецЕсли;
					
				КонецЦикла;
				
				Комментарий = ЗаголовокРасхождений + Комментарий;	
				
				Если НакладнаяНайдена Тогда
					
					//&lt;Сравнение табличных частей по количеству позиций&gt;
					Если ТЧНакладная.Количество() &lt;&gt; POSITION.Количество() Тогда
						Комментарий = "Количество позиций RECADV и Накладной отличаются, необходимо выполнить сверку вручную." + Символы.ПС
										+ Комментарий;						
					КонецЕсли;
					
				Иначе					
					Комментарий = "Накладная не найдена." + Символы.ПС + Комментарий;						
				КонецЕсли;
				
				Если СписокНоменклатуры[0].РасчетСумм Тогда
					
					Если ИтогСуммаНДС &lt;&gt; 0 Тогда
						ДанныеФайла.TOTALVAT = ИтогСуммаНДС;	
					КонецЕсли;
					
					Если ИтогСуммаБезНДС &lt;&gt; 0 Тогда
						ДанныеФайла.TOTALAMOUNT = ИтогСуммаБезНДС;
					КонецЕсли;
					
					Если ИтогСуммаСНДС &lt;&gt; 0 Тогда 
						ДанныеФайла.TOTALAMOUNTWITHVAT = ИтогСуммаСНДС;	
					КонецЕсли;
					
				КонецЕсли;
				
			Иначе				
				//&lt;Полчаем все ШК, т.к. контрагент не сопоставлен&gt;
				МассивНеСопоставленныхШК = ДанныеФайла.POSITION.ВыгрузитьКолонку("PRODUCT");				
			КонецЕсли;
			
			//&lt;Изменение статуса DR_Документа&gt;
			Если ПустаяСтрока(ТекстОшибки) Тогда
				СтатусДокумента = "Обработан";
			КонецЕсли;
			
			//&lt;Добавление записей в РС ЭКОМ_ЗначениеДополнительныхКонстант по не сопоставленным данным&gt;
			Если НЕ СоответствиеУчастникиЭДО.Количество() = 0 Тогда				    
				Для Каждого Участник Из СоответствиеУчастникиЭДО Цикл
					НастройкиПараметровЗаписатьНабором(Участник.Значение, Участник.Ключ);
				КонецЦикла;			
			КонецЕсли;
			
			Если НЕ СоответствиеПоНоменклатуре.Количество() = 0 Тогда
				НастройкиПараметровЗаписатьНабором(СоответствиеПоНоменклатуре    , "Номенклатура_");
			КонецЕсли;
			
			//&lt;Заполнение реквизитов и табл. части DR_Документа данными&gt;
			DR_ДокументОбъект 						= DR_ДокументСсылка.ПолучитьОбъект();
			DR_ДокументОбъект.ИдентификаторЦепочки	= ИдентификаторЦепочки;
			DR_ДокументОбъект.ДанныеФайла 			= Новый ХранилищеЗначения(Неопределено);
			DR_ДокументОбъект.Статус 				= СтатусДокумента;
			DR_ДокументОбъект.Сообщение 			= ТекстОшибки;
			DR_ДокументОбъект.Комментарий			= Комментарий;
			DR_ДокументОбъект.Пользователь 			= НайтиТекущегоПользователя();
			
			ТЧ_Документа = DR_ДокументОбъект.ДополнительныеРеквизиты;
			
			Для каждого ЭлСтруктуры Из ДанныеФайла Цикл
				
				НоваяСтрока = ТЧ_Документа.Добавить();
				НоваяСтрока.Реквизит = ЭлСтруктуры.Ключ;
				
				Если ТипЗнч(ЭлСтруктуры.Значение) = Тип("ТаблицаЗначений") Тогда				
					Хранилище = Новый ХранилищеЗначения(ЭлСтруктуры.Значение);
					НоваяСтрока.ХранилищеЗначения = Хранилище;
				Иначе
					НоваяСтрока.Значение = ЭлСтруктуры.Значение;				
				КонецЕсли;
				
			КонецЦикла;
			
			//&lt;Добавление в табл. часть DR_Документа данных по не сопоставленным ШК&gt;
			Для каждого Штрихкод Из МассивНеСопоставленныхШК Цикл
				
				НоваяСтрока = ТЧ_Документа.Добавить();
				НоваяСтрока.Реквизит = "ШК_НеСопоставлен";
				НоваяСтрока.Значение = Штрихкод;
				
			КонецЦикла;
			
			//&lt;Определение текста сообщения DR_События по DR_Документу&gt;
			Если Не ПустаяСтрока(ТекстОшибки) Тогда
				ЗаписьСообщение = "В документе есть ошибка";
			КонецЕсли;
			
			Если Не ПустаяСтрока(Комментарий) Тогда
				Если ПустаяСтрока(ЗаписьСообщение) Тогда
					ЗаписьСообщение = "Документ содержит комментарий";
				Иначе
					ЗаписьСообщение = ЗаписьСообщение + " и комментарий";
				КонецЕсли;
			КонецЕсли;
			
			НачатьТранзакцию();
			
			Попытка				
				
				DR_ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
				
				////////////////////////////&lt;Создание записи в РС DR_События&gt;/////////////////////////////////////
				
				//&lt;Заполнение структуры для DR_События&gt;
				СтруктураРегистра_DRСобытия.Вставить("ДатаСообщения"			, ДанныеДокумента.ДатаСообщения);
				СтруктураРегистра_DRСобытия.Вставить("ИдентификаторЦепочки"		, ИдентификаторЦепочки);
				СтруктураРегистра_DRСобытия.Вставить("ДатаЗаписи"				, ТекущаяДата());
				СтруктураРегистра_DRСобытия.Вставить("Документ"					, DR_ДокументСсылка);
				СтруктураРегистра_DRСобытия.Вставить("ВидДокумента"				, "RECADV_Входящий");
				СтруктураРегистра_DRСобытия.Вставить("Идентификатор"			, ИдентификаторДокумента);
				СтруктураРегистра_DRСобытия.Вставить("Статус"					, СтатусДокумента);
				СтруктураРегистра_DRСобытия.Вставить("Сообщение"				, ЗаписьСообщение);
				
				Если ДанныеФайла.Свойство("ИдентификаторОснования") Тогда 
					СтруктураРегистра_DRСобытия.Вставить("ИдентификаторОснования"	, ДанныеФайла.ИдентификаторОснования);	
				КонецЕсли;
				
				НЗ_DRСобытия = РегистрыСведений.DR_События.СоздатьНаборЗаписей();
				НЗ_DRСобытия.Отбор.ИдентификаторЦепочки.Установить(СтруктураРегистра_DRСобытия.ИдентификаторЦепочки);
				НЗ_DRСобытия.Отбор.Документ.Установить(СтруктураРегистра_DRСобытия.Документ);
				НЗ_DRСобытия.Отбор.ВидДокумента.Установить(СтруктураРегистра_DRСобытия.ВидДокумента);
				НЗ_DRСобытия.Отбор.Идентификатор.Установить(СтруктураРегистра_DRСобытия.Идентификатор);
				НЗ_DRСобытия.Прочитать();
				
				Если НЗ_DRСобытия.Количество() = 0 Тогда
					НоваяЗапись = НЗ_DRСобытия.Добавить();
				Иначе
					НоваяЗапись = НЗ_DRСобытия[0];
				КонецЕсли;
				
				Для Каждого Элемент Из СтруктураРегистра_DRСобытия Цикл			
						НоваяЗапись[Элемент.Ключ] = Элемент.Значение; 	
				КонецЦикла;
				
				НЗ_DRСобытия.Записать();
				
				////////////////////////////&lt;Создание записи в РС DR_ЦепочкиДокументов&gt;//////////////////////////////////
				Если ДанныеФайла.СозданиеЦепочки Тогда
					
					//&lt;Получение ORDERNUMBER, (не)переданного в RECADV&gt;
					НомерЗаказа = ?(ЗначениеЗаполнено(ДанныеФайла.ORDERNUMBER), ДанныеФайла.ORDERNUMBER, "");
					
					//&lt;Заполнение структуры для DR_ЦепочкиДокументов&gt;
					СтруктураРегистра_DRЦепочки.Вставить("ДатаЗаказа"			, ДанныеФайла.ДатаЗаказа);
					СтруктураРегистра_DRЦепочки.Вставить("ИдентификаторЦепочки"	, ИдентификаторЦепочки);
					СтруктураРегистра_DRЦепочки.Вставить("ДатаПоставки"			, ДанныеФайла.ДатаУвОбОтгрузке);
					СтруктураРегистра_DRЦепочки.Вставить("НомерЗаказа"			, НомерЗаказа);
					
					Если ЗначениеЗаполнено(ДанныеФайла["Организация"]) Тогда
						СтруктураРегистра_DRЦепочки.Вставить("Организация"			, ДанныеФайла.Организация);
					КонецЕсли;
					
					Если ЗначениеЗаполнено(ДанныеФайла["Контрагент"]) Тогда
						СтруктураРегистра_DRЦепочки.Вставить("Контрагент"			, ДанныеФайла.Контрагент);
					КонецЕсли;
					
					Если ЗначениеЗаполнено(ДанныеФайла["ТочкаДоставки"]) Тогда
						СтруктураРегистра_DRЦепочки.Вставить("ТочкаДоставки"		, ДанныеФайла.ТочкаДоставки);
					КонецЕсли;
					
					НЗ_DRЦепочкиДокументов = РегистрыСведений.DR_ЦепочкиДокументов.СоздатьНаборЗаписей();
					НЗ_DRЦепочкиДокументов.Отбор.НомерЗаказа.Установить(СтруктураРегистра_DRЦепочки.НомерЗаказа);
					НЗ_DRЦепочкиДокументов.Отбор.ДатаЗаказа.Установить(СтруктураРегистра_DRЦепочки.ДатаЗаказа);
					НЗ_DRЦепочкиДокументов.Отбор.ДатаПоставки.Установить(СтруктураРегистра_DRЦепочки.ДатаПоставки);
					НЗ_DRЦепочкиДокументов.Отбор.ИдентификаторЦепочки.Установить(СтруктураРегистра_DRЦепочки.ИдентификаторЦепочки);
					
					НЗ_DRЦепочкиДокументов.Прочитать();
					
					Если НЗ_DRЦепочкиДокументов.Количество() = 0 Тогда
						НоваяЗапись = НЗ_DRЦепочкиДокументов.Добавить();
					Иначе
						НоваяЗапись = НЗ_DRЦепочкиДокументов[0];
					КонецЕсли;
					
					Для Каждого Элемент Из СтруктураРегистра_DRЦепочки Цикл			
							НоваяЗапись[Элемент.Ключ] = Элемент.Значение; 	
					КонецЦикла;
					
					НЗ_DRЦепочкиДокументов.Записать();
					
				КонецЕсли;
				
				ЗафиксироватьТранзакцию();
				
			Исключение				
				ОтменитьТранзакцию();
				
				ТекстЛогаСобытий = НСтр("ru = 'Формирование записей в Регистрах Docrobot по %ПредставлениеДокументаXML% не выполнено.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
				ПредставлениеДокументаXML = "RECADV (Уведомление о приемке)" + " № " + ДанныеФайла.NUMBER + " от " + Формат(ДанныеФайла.ДатаЭлектронногоДокумента, "ДЛФ=D");
				ТекстЛогаСобытий = СтрЗаменить(ТекстЛогаСобытий, "%ПредставлениеДокументаXML%", ПредставлениеДокументаXML);
				ТекстЛогаСобытий = ТекстЛогаСобытий + Символы.ПС + "По причине: "+ ОписаниеОшибки();
				
				ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
				МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);				
				ЗаписьЖурналаРегистрации("Обработка ""Интеграция Docrobot""", УровеньЖурналаРегистрации.Ошибка, , , "Описание ошибки: " + ОписаниеОшибки());
				
			КонецПопытки;		
			
		КонецЦикла;
		
		#КонецОбласти
		
		#Область ОбработкаДокументовСоСтатустомНеОбработан
		
		//&lt;Очищаем коллекцию, данные которой уже не нужны&gt;
		ТаблицаНовДокументов = Неопределено;
		
		Индекс = МассивРезультатов.ВГраница();
		
		Если НЕ МассивРезультатов[Индекс].Пустой() Тогда
			
			//&lt;Получение коллекции колонок&gt;
			Колонки = МассивРезультатов[Индекс].Колонки;
			
			ВыборкаДетальныеЗаписи = МассивРезультатов[Индекс].Выбрать();
			
			Пока ВыборкаДетальныеЗаписи.Следующий() Цикл 
				
				МассивСопоставленныхШК = Новый Массив;
				
				МодификацияЦепочки	 	= Ложь;
				DRДокументМодифицирован = Ложь;
				
				СтатусДокумента	= "НеОбработан";
				Комментарий		= "";
				ТекстОшибки 	= "";
				ЗаписьСообщение	= "";
				
				СтруктураДанных 			= Новый Структура;
				СтруктураРегистра_DRСобытия = Новый Структура;
				СтруктураРегистра_DRЦепочки	= Новый Структура;
				
				СоответствиеПоНоменклатуре = Новый Соответствие;
				
				//&lt;Заполнение структуры данными, для их последующей обработки (изменению)&gt;
				Для каждого Колонка ИЗ Колонки Цикл
					
					Значение = ВыборкаДетальныеЗаписи[Колонка.Имя];
					
					Если ТипЗнч(Значение) = Тип("ХранилищеЗначения") Тогда
						
						ЗначениеИзХранилища = Значение.Получить();
						
						Если ЗначениеЗаполнено(ЗначениеИзХранилища) Тогда			
							СтруктураДанных.Вставить(Колонка.Имя, ЗначениеИзХранилища);		
						КонецЕсли;
						
					Иначе	
						СтруктураДанных.Вставить(Колонка.Имя, Значение);	
					КонецЕсли;
					
				КонецЦикла;
				
				DR_ДокументСсылка 	= СтруктураДанных.DR_Документ;
				
				//&lt;Если возраст RECADV больше срока обработки DR_Документов со статусом "Не обработан"&gt;
				//&lt;Тогда таким документам изменяем статус и переходим к обработке следующего DR_Документа&gt;
				Если СтруктураДанных.СрокОбработкиДокИстек Тогда
					
					DR_ДокументОбъект 			  = DR_ДокументСсылка.ПолучитьОбъект();
					DR_ДокументОбъект.Статус 	  = "Архивный";
					DR_ДокументОбъект.Комментарий = Комментарий + ?(ЗначениеЗаполнено(Комментарий), Символы.ПС, "")
													+ "Документу изменен статус на ""Архивный"" по причине: Срок повторной обработки документа истек.";
					
					НачатьТранзакцию();
					
					Попытка						
						
						DR_ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
						
						МЗ_DRСобытия = РегистрыСведений.DR_События.СоздатьМенеджерЗаписи();
						МЗ_DRСобытия.ИдентификаторЦепочки 	= СтруктураДанных.ИдентификаторЦепочки;
						МЗ_DRСобытия.Документ 				= DR_ДокументСсылка;
						МЗ_DRСобытия.ВидДокумента 			= "RECADV_Входящий";
						МЗ_DRСобытия.Идентификатор 			= СтруктураДанных.ИдентификаторДокумента;
						
						МЗ_DRСобытия.Прочитать();
						
						Если МЗ_DRСобытия.Выбран() Тогда							
							МЗ_DRСобытия.ДатаЗаписи = ТекущаяДата();
							МЗ_DRСобытия.Статус = "Архивный";
							МЗ_DRСобытия.Записать();							
						КонецЕсли;
						
						ЗафиксироватьТранзакцию();
						
					Исключение
						ОтменитьТранзакцию();
						
						ПредставлениеДокументаXML = "RECADV (Уведомление о приемке)" + " № " + СтруктураДанных.NUMBER + " от " + Формат(СтруктураДанных.ДатаЭлектронногоДокумента, "ДЛФ=D");
						ТекстЛогаСобытий = "Изменение статуса " + ПредставлениеДокументаXML + ", срок обработки которого истек, не выполнено. По причине - " + ОписаниеОшибки();
						ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
						МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);						
						ЗаписьЖурналаРегистрации("Обработка ""Интеграция Docrobot""", УровеньЖурналаРегистрации.Ошибка, , , "Описание ошибки - " + ОписаниеОшибки());
						
					КонецПопытки;
					
					Продолжить;					
				КонецЕсли;
				
				//&lt;Поиск и заполнение Участников ЭДО&gt;		
				Если СтруктураДанных["ЗаполнитьУчастниковЭДО"] Тогда 
					
					Запрос = Новый Запрос;	
					Запрос.Текст = 
					"ВЫБРАТЬ
					|	ПОДСТРОКА(ТаблицаGLN.RECIPIENT, 1, 13) КАК xmlОрганизацияGLN,
					|	ПОДСТРОКА(ТаблицаGLN.BUYER, 1, 13) КАК xmlКонтрагентGLN,
					|	ПОДСТРОКА(ТаблицаGLN.DELIVERYPLACE, 1, 13) КАК xmlТочкаДоставкиGLN
					|ПОМЕСТИТЬ ВТ_УчастиникиЭДО
					|ИЗ
					|	&amp;ТаблицаGLN КАК ТаблицаGLN
					|;
					|
					|////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	ЭКОМ_GLN_Организация.Объект КАК Организация,
					|	ЭКОМ_GLN_Контрагент.Объект КАК Контрагент,
					|	ЭКОМ_ТочкиДоставки.Объект КАК ТочкаДоставки
					|ИЗ
					|	ВТ_УчастиникиЭДО КАК ВТ_УчастиникиЭДО
					|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_GLN КАК ЭКОМ_GLN_Организация
					|		ПО ВТ_УчастиникиЭДО.xmlОрганизацияGLN = ЭКОМ_GLN_Организация.GLN
					|			И (НЕ ЭКОМ_GLN_Организация.Объект ССЫЛКА Справочник.Контрагенты)
					|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_GLN КАК ЭКОМ_GLN_Контрагент
					|		ПО ВТ_УчастиникиЭДО.xmlКонтрагентGLN = ЭКОМ_GLN_Контрагент.GLN
					|			И (ЭКОМ_GLN_Контрагент.Объект ССЫЛКА Справочник.Контрагенты)
					|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_ТочкиДоставки КАК ЭКОМ_ТочкиДоставки
					|		ПО ВТ_УчастиникиЭДО.xmlТочкаДоставкиGLN = ЭКОМ_ТочкиДоставки.GLN
					|
					|ОБЪЕДИНИТЬ ВСЕ
					|
					|ВЫБРАТЬ
					|	ВТ_УчастиникиЭДО.xmlОрганизацияGLN,
					|	ВТ_УчастиникиЭДО.xmlКонтрагентGLN,
					|	ВТ_УчастиникиЭДО.xmlТочкаДоставкиGLN
					|ИЗ
					|	ВТ_УчастиникиЭДО КАК ВТ_УчастиникиЭДО";
					
					ТаблицаGLN = СтруктураДанных.HEAD;
					
					Запрос.УстановитьПараметр("ТаблицаGLN", ТаблицаGLN);
					
					РезультатЗапроса = Запрос.Выполнить();
					УчастникиЭДО = РезультатЗапроса.Выгрузить();
					
					Для Каждого Колонка Из УчастникиЭДО.Колонки Цикл
						
						УчастникЭДО = Неопределено;				
						СтруктураДанных.Свойство(Колонка.Имя, УчастникЭДО);
						
						Если ЗначениеЗаполнено(УчастникЭДО) Тогда
							Продолжить;	
						КонецЕсли;
						
						Ссылка = УчастникиЭДО[0][Колонка.Имя];
						GLN = УчастникиЭДО[1][Колонка.Имя];
						
						Если ЗначениеЗаполнено(Ссылка) Тогда
							
							СтруктураДанных[Колонка.Имя] = Ссылка;							
							МодификацияЦепочки	 		 = Истина;
							DRДокументМодифицирован 	 = Истина;
							
						Иначе							
							ТекстОшибки = ТекстОшибки + ?(ЗначениеЗаполнено(ТекстОшибки), Символы.ПС, "")
											+ "Не заполнен(а) " + Колонка.Имя + " (" + GLN + ")";							
						КонецЕсли;
						
					КонецЦикла;                                                     
					
					Если ПустаяСтрока(ТекстОшибки) Тогда 
						СтруктураДанных.ЗаполнитьУчастниковЭДО = Ложь;	
					КонецЕсли;
					
				КонецЕсли;
				
				//&lt;Получение Таблицы значений POSITION&gt;
				ТЧ_ДопРеквизиты = DR_ДокументСсылка.ДополнительныеРеквизиты;
				
				НайденнаяСтрока = ТЧ_ДопРеквизиты.Найти("POSITION", "Реквизит");
				
				Если НайденнаяСтрока &lt;&gt; Неопределено Тогда 
					
					POSITION = НайденнаяСтрока.ХранилищеЗначения.Получить();
					
					Если ЗначениеЗаполнено(POSITION) Тогда
						СтруктураДанных.Вставить("POSITION", POSITION);	
					Иначе
						ПредставлениеДокументаXML = "RECADV (Уведомление о приемке)" + " № " + СтруктураДанных.NUMBER + " от " + Формат(СтруктураДанных.ДатаЭлектронногоДокумента, "ДЛФ=D");
						ТекстЛогаСобытий = "По " + ПредставлениеДокументаXML + ", отсутсвует значение реквизита POSITION";
						ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Предупреждение", ИмяСобытия);
						МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
						
						Продолжить;	
					КонецЕсли;
					
				Иначе
					ПредставлениеДокументаXML = "ORDER (Электронный заказ)" + " № " + СтруктураДанных.NUMBER + " от " + Формат(СтруктураДанных.ДатаЭлектронногоДокумента, "ДЛФ=D");
					ТекстЛогаСобытий = "По " + ПредставлениеДокументаXML + ", отсутсвует реквизит POSITION";
					ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Предупреждение", ИмяСобытия);
					МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
					
					Продолжить;					
				КонецЕсли;
				
				//&lt;Поиск и заполнение номенклатуры&gt;
				ЗапросНоменклатуры = Новый Запрос;
				ЗапросНоменклатуры.Текст =
				"ВЫБРАТЬ
				|	ВЫРАЗИТЬ(ТЧ_Товары.PRODUCT КАК СТРОКА(30)) КАК Штрихкод,
				|	&amp;Контрагент КАК Контрагент
				|ПОМЕСТИТЬ ВТ
				|ИЗ
				|	&amp;ТЧ_Товары КАК ТЧ_Товары
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВТ.Штрихкод КАК Штрихкод,
				|	ЕСТЬNULL(ЭКОМ_НоменклатураКонтрагентов.Номенклатура, НЕОПРЕДЕЛЕНО) КАК Номенклатура,
				|	ЕСТЬNULL(ЭКОМ_НоменклатураКонтрагентов.ХарактеристикаНоменклатуры, НЕОПРЕДЕЛЕНО) КАК ХарактеристикаНоменклатуры,
				|	ЕСТЬNULL(ЭКОМ_НоменклатураКонтрагентов.ЕдиницаНоменклатурыКонтрагента, НЕОПРЕДЕЛЕНО) КАК ЕдиницаИзмерения,
				|	ЕСТЬNULL(ЭКОМ_GLN.РасчетСумм, Ложь) КАК РасчетСумм
				|ИЗ
				|	ВТ КАК ВТ
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_НоменклатураКонтрагентов КАК ЭКОМ_НоменклатураКонтрагентов
				|		ПО ВТ.Контрагент = ЭКОМ_НоменклатураКонтрагентов.Контрагент
				|			И ВТ.Штрихкод = ЭКОМ_НоменклатураКонтрагентов.ШтрихКодНоменклатурыКонтрагента
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_GLN КАК ЭКОМ_GLN
				|		ПО (ЭКОМ_GLN.Объект = &amp;Контрагент)";
				
				ЗапросНоменклатуры.УстановитьПараметр("ТЧ_Товары", POSITION.Скопировать(, "PRODUCT"));
				ЗапросНоменклатуры.УстановитьПараметр("Контрагент", СтруктураДанных.Контрагент);
				
				ЗаголовокРасхождений = "";
				НакладнаяНайдена = Ложь;
				
				//&lt;Получение данных табличной части Накладной&gt;
				Если ЗначениеЗаполнено(СтруктураДанных.Накладная1С) Тогда
					
					НакладнаяСсылка = СтруктураДанных.Накладная1С;
					
					//&lt;Определение имени табличной части Накладной, взависимости от конфигурации&gt;
					Если НакладнаяСсылка.Метаданные().ТабличныеЧасти.Найти("Запасы") = Неопределено Тогда 
						ИмяТабЧасти = "Товары";
					Иначе
						ИмяТабЧасти = "Запасы";
					КонецЕсли;
					
					ТЧНакладная = НакладнаяСсылка[ИмяТабЧасти].Выгрузить(, "Номенклатура, Количество");					
					//&lt;Группировка на случай партионного учета&gt;
					ТЧНакладная.Свернуть("Номенклатура", "Количество");
					
					НакладнаяНайдена = Истина;
					
				КонецЕсли;
				
				//&lt;Заполнение сопоставленной номенклатуры&gt;
				Если СтруктураДанных.ШК_Сопоставлен Тогда
					
					РезультатЗапроса = ЗапросНоменклатуры.Выполнить();
					СписокНоменклатуры = РезультатЗапроса.Выгрузить();
					
					POSITION.Индексы.Добавить("PRODUCT");
					
					ИтогСуммаНДС = 0;     //Общая Сумма налога
					ИтогСуммаБезНДС = 0;  //Общая Сумма без НДС
					ИтогСуммаСНДС = 0; 	  //Общая Сумма с НДС 
					
					Для каждого Строка Из СписокНоменклатуры Цикл
						
						PRODUCT = СокрЛП(Строка.Штрихкод);
						НайденнаяСтрока = POSITION.Найти(PRODUCT, "PRODUCT");
						
						//&lt;Построчный расчет сумм&gt;
						Если Строка.РасчетСумм Тогда
							
							ЦенаБезНДС		= НайденнаяСтрока.PRICE;  			
							ЦенаСНДС   		= НайденнаяСтрока.PRICEWITHVAT;				
							ПринятоеКол 	= НайденнаяСтрока.ACCEPTEDQUANTITY;	
							
							СуммаСНДС 	= НайденнаяСтрока.AMOUNTWITHVAT;  	
							СуммаНДС	= НайденнаяСтрока.VATAMOUNT;  		
							СуммаБезНДС = НайденнаяСтрока.AMOUNT; 			
							
							Если ЦенаСНДС &lt;&gt; 0 Тогда
								СуммаСНДС = Окр(ЦенаСНДС * ПринятоеКол, 2);	
							КонецЕсли;
							
							Если ЦенаБезНДС &lt;&gt; 0 Тогда
								СуммаБезНДС = Окр(ЦенаБезНДС * ПринятоеКол, 2);
							КонецЕсли;
							
							Если СуммаСНДС &lt;&gt; 0 И СуммаБезНДС &lt;&gt; 0 Тогда
								СуммаНДС    = Окр(СуммаСНДС - СуммаБезНДС, 2);
							КонецЕсли;
							
							НайденнаяСтрока.AMOUNTWITHVAT 	= СуммаСНДС;  	
							НайденнаяСтрока.VATAMOUNT		= СуммаНДС;  		
							НайденнаяСтрока.AMOUNT 			= СуммаБезНДС; 			
							
							Если СуммаСНДС &lt;&gt; 0 И СуммаБезНДС &lt;&gt; 0 И СуммаНДС &lt;&gt; 0 Тогда
								
								ИтогСуммаНДС    = ИтогСуммаНДС + СуммаНДС;
								ИтогСуммаБезНДС = ИтогСуммаБезНДС + СуммаБезНДС;
								ИтогСуммаСНДС	= ИтогСуммаСНДС + СуммаСНДС;
								
							ИначеЕсли СуммаСНДС &lt;&gt; 0 И СуммаБезНДС &lt;&gt; 0 Тогда
								
								СуммаНДС = СуммаСНДС - СуммаБезНДС;
								
								ИтогСуммаНДС    = ИтогСуммаНДС + СуммаНДС;
								ИтогСуммаБезНДС = ИтогСуммаБезНДС + СуммаБезНДС;
								ИтогСуммаСНДС 	= ИтогСуммаСНДС + СуммаСНДС;
								
							КонецЕсли;
							
						КонецЕсли;
						
						Если ЗначениеЗаполнено(НайденнаяСтрока.Номенклатура) Тогда
							Продолжить;	
						КонецЕсли;
						
						Если ЗначениеЗаполнено(Строка.Номенклатура) Тогда					
							
							НайденнаяСтрока.Номенклатура 	 = Строка.Номенклатура;
							НайденнаяСтрока.Характеристика 	 = Строка.ХарактеристикаНоменклатуры;
							НайденнаяСтрока.ЕдиницаИзмерения = Строка.ЕдиницаИзмерения;
							
							DRДокументМодифицирован = Истина;
							
							//&lt;Заполнение массива сопоставленными ШК. С целью их исключения из повторной обработки&gt;
							МассивСопоставленныхШК.Добавить(PRODUCT);
							
							//&lt;Заполнение количества из Накладной по сопоставленной номенклатуре&gt; 
							Если НакладнаяНайдена Тогда 
								
								СтрокаТЧ = ТЧНакладная.Найти(Строка.Номенклатура,"Номенклатура"); 
								
								Если СтрокаТЧ &lt;&gt; Неопределено Тогда    
									НайденнаяСтрока.КоличествоИзРТУ = СтрокаТЧ.Количество;
								Иначе
									Комментарий = Комментарий + ?(ЗначениеЗаполнено(Комментарий), Символы.ПС, "")
											+ "Позиция № " + НайденнаяСтрока.POSITIONNUMBER + ". Не соответствие данных с накладной";
								КонецЕсли;		
								
							КонецЕсли;
							
						Иначе							
							ТекстОшибки = ТекстОшибки + ?(ЗначениеЗаполнено(ТекстОшибки), Символы.ПС, "")
											+ "Позиция № " + НайденнаяСтрока.POSITIONNUMBER + ". Не заполнена номенклатура по штрихкоду - " 
											+ "(" + НайденнаяСтрока.PRODUCT + ")";							
						КонецЕсли;
						
					КонецЦикла;
					
					Если СписокНоменклатуры[0].РасчетСумм Тогда
						
						Если ИтогСуммаНДС &lt;&gt; 0 Тогда
							СтруктураДанных.TOTALVAT = ИтогСуммаНДС;	
						КонецЕсли;
						
						Если ИтогСуммаБезНДС &lt;&gt; 0 Тогда
							СтруктураДанных.TOTALAMOUNT = ИтогСуммаБезНДС;
						КонецЕсли;
						
						Если ИтогСуммаСНДС &lt;&gt; 0 Тогда 
							СтруктураДанных.TOTALAMOUNTWITHVAT = ИтогСуммаСНДС;	
						КонецЕсли;
						
					КонецЕсли;
					
					Для каждого Строка Из POSITION Цикл
						//&lt;Определение значения поставленного количества&gt;
						КолПоставленное = 0;
						
						//&lt;Если в RECADV передан элемент DELIVERQUANTITY, тогда значение берем из элемента&gt;
						Если Строка.DELIVERQUANTITY &lt;&gt; 0 Тогда
							КолПоставленное = Строка.DELIVERQUANTITY;
						ИначеЕсли ЗначениеЗаполнено(Строка.КоличествоИзРТУ) Тогда //&lt;Иначе пробуем получить значение из Накладной&gt;
							КолПоставленное = Строка.КоличествоИзРТУ;
						КонецЕсли;
						
						//&lt;Проверяются кейсы, когда поставляемое количество передано либо в RECADV, либо получено из накладной&gt;
						//&lt;Возможен кейс когда: в RECADV не передано DELIVERQUANTITY и накладная найдена, но не сопоставлена номенкатура&gt;
						Если КолПоставленное &lt;&gt; 0 Тогда
							
							//&lt;Сравнение принятого количества с поставленным&gt;
							Если Строка.ACCEPTEDQUANTITY &lt;&gt; КолПоставленное Тогда
								
								Комментарий = Комментарий + ?(ЗначениеЗаполнено(Комментарий), Символы.ПС, "")
								+ "Позиция № " + Строка.POSITIONNUMBER + "."
								+ " Штрихкод " + Строка.PRODUCT 
								+ ?(ЗначениеЗаполнено(Строка.DESCRIPTION), " (" + Строка.DESCRIPTION + ")", "") 
								+ " принято - " + Формат(Строка.ACCEPTEDQUANTITY,"ЧДЦ=3; ЧРД=.; ЧН=0; ЧГ=0") 
								+ ", поставлено - " + Формат(КолПоставленное,"ЧДЦ=3; ЧРД=.; ЧН=0; ЧГ=0");
								
								Если НЕ ЗначениеЗаполнено(ЗаголовокРасхождений) Тогда
									ЗаголовокРасхождений = "В следующих позициях есть расхождения:" + Символы.ПС;
								КонецЕсли;
								
							КонецЕсли;
							
						ИначеЕсли НЕ НакладнаяНайдена Тогда //&lt;В RECADV не передано DELIVERQUANTITY и не найдена накладная&gt;
							
							Комментарий = Комментарий + ?(ЗначениеЗаполнено(Комментарий), Символы.ПС, "")
							+ "Позиция № " + Строка.POSITIONNUMBER + "."
							+ " Штрихкод " + Строка.PRODUCT 
							+ ?(ЗначениеЗаполнено(Строка.DESCRIPTION), " (" + Строка.DESCRIPTION + ")", "") 
							+ " принято - " + Формат(Строка.ACCEPTEDQUANTITY,"ЧДЦ=3; ЧРД=.; ЧН=0; ЧГ=0")
							+ ". Поставленное количество определить не удалось, выполните сверку вручную.";
							
						КонецЕсли;
						
					КонецЦикла;
					
					Комментарий = ЗаголовокРасхождений + Комментарий;	
					
					Если НакладнаяНайдена Тогда
						
						//&lt;Сравнение количества позиций по Накладной и RECADV&gt;
						Если ТЧНакладная.Количество() &lt;&gt; POSITION.Количество() Тогда
							Комментарий = "Количество позиций RECADV и Накладной отличаются, необходимо выполнить сверку вручную." + Символы.ПС
							+ Комментарий;						
						КонецЕсли;
						
					Иначе					
						Комментарий = "Накладная не найдена." + Символы.ПС + Комментарий;						
					КонецЕсли;
					
				Иначе
					
					Если ЗначениеЗаполнено(СтруктураДанных["Контрагент"]) И СтруктураДанных.ПервичныйПоискНоменклатуры Тогда
						
						Для каждого Строка Из POSITION Цикл
							
							ТекстОшибки = ТекстОшибки + ?(ЗначениеЗаполнено(ТекстОшибки), Символы.ПС, "")
											+ "Позиция № " + Строка.POSITIONNUMBER + ". Не заполнена номенклатура по штрихкоду - " 
											+ "(" + Строка.PRODUCT + ")";	
							
							Код = ?(ЗначениеЗаполнено(Строка.PRODUCT), Строка.PRODUCT, Строка.PRODUCTIDBUYER) + "_" + СтруктураДанных.HEAD[0].BUYER;
							
							СоответствиеПоНоменклатуре.Вставить("АртикулНоменклатурыКонтрагента_"      + Код, Строка.PRODUCTIDSUPPLIER);
							СоответствиеПоНоменклатуре.Вставить("КодНоменклатурыКонтрагента_"          + Код, Строка.PRODUCTIDBUYER);
							СоответствиеПоНоменклатуре.Вставить("ШтрихКодНоменклатурыКонтрагента_"     + Код, Строка.PRODUCT);
							СоответствиеПоНоменклатуре.Вставить("НаименованиеНоменклатурыКонтрагента_" + Код, Строка.DESCRIPTION);
							СоответствиеПоНоменклатуре.Вставить("ЕдиницаНоменклатурыКонтрагента_"      + Код, Строка.ЕдиницаИзмерения);
							СоответствиеПоНоменклатуре.Вставить("Контрагент_"                          + Код, СтруктураДанных.Контрагент);
							СоответствиеПоНоменклатуре.Вставить("xmlЕдиницаИзмерения_"                 + Код, Строка.ACCEPTEDUNIT);
							
						КонецЦикла; 
						
						СтруктураДанных.ПервичныйПоискНоменклатуры = Ложь;
						
					ИначеЕсли ЗначениеЗаполнено(СтруктураДанных["Контрагент"]) Тогда
						
						Для каждого Строка Из POSITION Цикл
							
							Если НЕ ЗначениеЗаполнено(Строка.Номенклатура) Тогда
								ТекстОшибки = ТекстОшибки + ?(ЗначениеЗаполнено(ТекстОшибки), Символы.ПС, "")
								+ "Позиция № " + Строка.POSITIONNUMBER + ". Не заполнена номенклатура по штрихкоду - " 
								+ "(" + Строка.PRODUCT + ")";
							КонецЕсли;
							
						КонецЦикла;
						
						Комментарий = СтруктураДанных.Комментарий;
						
					КонецЕсли;	
					
				КонецЕсли;
				
				//&lt;Проверка на запись повторно обрабатываемого DR_Документа&gt;
				Если НЕ DRДокументМодифицирован Тогда 
					Продолжить; 	
				КонецЕсли;
				
				//&lt;Изменение статуса DR_Документа&gt;
				Если ПустаяСтрока(ТекстОшибки) Тогда
					СтатусДокумента = "Обработан";
				КонецЕсли;
				
				//&lt;Добавление записей в ЭКОМ_ЗначениеДополнительныхКонстант по не сопоставленным данным&gt;
				Если НЕ СоответствиеПоНоменклатуре.Количество() = 0 Тогда
					НастройкиПараметровЗаписатьНабором(СоответствиеПоНоменклатуре    , "Номенклатура_");
				КонецЕсли;
				
				//&lt;Обновление данных DR_Документа&gt;
				DR_ДокументОбъект 				= DR_ДокументСсылка.ПолучитьОбъект();
				DR_ДокументОбъект.Статус 		= СтатусДокумента;
				DR_ДокументОбъект.Сообщение 	= ТекстОшибки;
				DR_ДокументОбъект.Комментарий   = Комментарий;
				
				ТЧ_Документа = DR_ДокументОбъект.ДополнительныеРеквизиты;
				
				Для каждого ЭлСтруктуры Из СтруктураДанных Цикл
					
					НайденнаяСтрока	= ТЧ_Документа.Найти(ЭлСтруктуры.Ключ, "Реквизит");
					
					Если ТипЗнч(ЭлСтруктуры.Значение) = Тип("ТаблицаЗначений") Тогда				
						Хранилище = Новый ХранилищеЗначения(ЭлСтруктуры.Значение);
						НайденнаяСтрока.ХранилищеЗначения = Хранилище;
					Иначе
						
						Если НайденнаяСтрока = Неопределено Тогда
							Продолжить;
						Иначе
							НайденнаяСтрока.Значение = ЭлСтруктуры.Значение;
						КонецЕсли;
						
					КонецЕсли;
					
				КонецЦикла;
				
				//&lt;Удаление из табл. части DR_Документа записей ШК_НеСопоставлен, по сопоставленному штрихкоду&gt;
				Для Каждого Штрихкод Из МассивСопоставленныхШК Цикл 
					ТЧ_Документа.Удалить(ТЧ_Документа.Найти(Штрихкод, "Значение"));	
				КонецЦикла;
				
				//&lt;Определение текста сообщения DR_События по DR_Документу&gt;
				Если Не ПустаяСтрока(ТекстОшибки) Тогда
					ЗаписьСообщение = "В документе есть ошибка";
				КонецЕсли;
				
				Если Не ПустаяСтрока(Комментарий) Тогда
					Если ПустаяСтрока(ЗаписьСообщение) Тогда
						ЗаписьСообщение = "Документ содержит комментарий";
					Иначе
						ЗаписьСообщение = ЗаписьСообщение + " и комментарий";
					КонецЕсли;
				КонецЕсли;
				
				НачатьТранзакцию();
				
				Попытка					
					
					DR_ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
					
					//&lt;Обновление данных DR_События&gt;
					Если ВРег(СтатусДокумента) = "ОБРАБОТАН" Тогда
						
						СтруктураРегистра_DRСобытия.Вставить("ИдентификаторЦепочки"		, СтруктураДанных.ИдентификаторЦепочки);
						СтруктураРегистра_DRСобытия.Вставить("ДатаЗаписи"				, ТекущаяДата());
						СтруктураРегистра_DRСобытия.Вставить("Документ"					, DR_ДокументСсылка);
						СтруктураРегистра_DRСобытия.Вставить("ВидДокумента"				, "RECADV_Входящий");
						СтруктураРегистра_DRСобытия.Вставить("Идентификатор"			, СтруктураДанных.ИдентификаторДокумента);
						СтруктураРегистра_DRСобытия.Вставить("Статус"					, СтатусДокумента);
						СтруктураРегистра_DRСобытия.Вставить("Сообщение"				, ЗаписьСообщение);
						
						НЗ_DRСобытия = РегистрыСведений.DR_События.СоздатьНаборЗаписей();
						НЗ_DRСобытия.Отбор.ИдентификаторЦепочки.Установить(СтруктураРегистра_DRСобытия.ИдентификаторЦепочки);
						НЗ_DRСобытия.Отбор.Документ.Установить(СтруктураРегистра_DRСобытия.Документ);
						НЗ_DRСобытия.Отбор.ВидДокумента.Установить(СтруктураРегистра_DRСобытия.ВидДокумента);
						НЗ_DRСобытия.Отбор.Идентификатор.Установить(СтруктураРегистра_DRСобытия.Идентификатор);
						НЗ_DRСобытия.Прочитать();
						
						НоваяЗапись = НЗ_DRСобытия[0];
						
						Для Каждого Элемент Из СтруктураРегистра_DRСобытия Цикл			
							НоваяЗапись[Элемент.Ключ] = Элемент.Значение; 	
						КонецЦикла;
						
						НЗ_DRСобытия.Записать();
						
					КонецЕсли;
					
					//&lt;Обновление данных DR_ЦепочкиДокументов&gt;
					Если МодификацияЦепочки И СтруктураДанных.СозданиеЦепочки Тогда
						
						НомерЗаказа = ?(ЗначениеЗаполнено(СтруктураДанных.ORDERNUMBER), СтруктураДанных.ORDERNUMBER, "");
						
						СтруктураРегистра_DRЦепочки.Вставить("ДатаЗаказа"				, СтруктураДанных.ДатаЗаказа);
						СтруктураРегистра_DRЦепочки.Вставить("ИдентификаторЦепочки"		, СтруктураДанных.ИдентификаторЦепочки);
						СтруктураРегистра_DRЦепочки.Вставить("ДатаПоставки"				, СтруктураДанных.ДатаУвОбОтгрузке);
						СтруктураРегистра_DRЦепочки.Вставить("НомерЗаказа"				, НомерЗаказа);
						
						Если ЗначениеЗаполнено(СтруктураДанных["Организация"]) Тогда
							СтруктураРегистра_DRЦепочки.Вставить("Организация"			, СтруктураДанных.Организация);
						КонецЕсли;
						
						Если ЗначениеЗаполнено(СтруктураДанных["Контрагент"]) Тогда
							СтруктураРегистра_DRЦепочки.Вставить("Контрагент"			, СтруктураДанных.Контрагент);
						КонецЕсли;
						
						Если ЗначениеЗаполнено(СтруктураДанных["ТочкаДоставки"]) Тогда
							СтруктураРегистра_DRЦепочки.Вставить("ТочкаДоставки"		, СтруктураДанных.ТочкаДоставки);
						КонецЕсли;
						
						НЗ_DRЦепочкиДокументов = РегистрыСведений.DR_ЦепочкиДокументов.СоздатьНаборЗаписей();
						НЗ_DRЦепочкиДокументов.Отбор.НомерЗаказа.Установить(СтруктураРегистра_DRЦепочки.НомерЗаказа);
						НЗ_DRЦепочкиДокументов.Отбор.ДатаЗаказа.Установить(СтруктураРегистра_DRЦепочки.ДатаЗаказа);
						НЗ_DRЦепочкиДокументов.Отбор.ДатаПоставки.Установить(СтруктураРегистра_DRЦепочки.ДатаПоставки);
						НЗ_DRЦепочкиДокументов.Отбор.ИдентификаторЦепочки.Установить(СтруктураРегистра_DRЦепочки.ИдентификаторЦепочки);
						
						НЗ_DRЦепочкиДокументов.Прочитать();
						
						Если НЗ_DRЦепочкиДокументов.Количество() = 0 Тогда
							НоваяЗапись = НЗ_DRЦепочкиДокументов.Добавить();
						Иначе
							НоваяЗапись = НЗ_DRЦепочкиДокументов[0];
						КонецЕсли;
						
						Для Каждого Элемент Из СтруктураРегистра_DRЦепочки Цикл			
							НоваяЗапись[Элемент.Ключ] = Элемент.Значение; 	
						КонецЦикла;
						
						НЗ_DRЦепочкиДокументов.Записать();				
						
					КонецЕсли;
					
					ЗафиксироватьТранзакцию();
					
				Исключение					
					ОтменитьТранзакцию();
					
					ТекстЛогаСобытий = НСтр("ru = 'Изменение данных в Регистрах Docrobot по %ПредставлениеДокументаXML% не выполнено.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
					ПредставлениеДокументаXML = "RECADV (Уведомление о приемке)" + " № " + СтруктураДанных.NUMBER + " от " + Формат(СтруктураДанных.ДатаЭлектронногоДокумента, "ДЛФ=D");
					ТекстЛогаСобытий = СтрЗаменить(ТекстЛогаСобытий, "%ПредставлениеДокументаXML%", ПредставлениеДокументаXML);
					ТекстЛогаСобытий = ТекстЛогаСобытий + Символы.ПС + "По причине: "+ ОписаниеОшибки();
					
					ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
					МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);				
					ЗаписьЖурналаРегистрации("Обработка ""Интеграция Docrobot""", УровеньЖурналаРегистрации.Ошибка, , , "Описание ошибки: " + ОписаниеОшибки());
					
				КонецПопытки;
				
			КонецЦикла;
			
		КонецЕсли;
		
		#КонецОбласти

		
	Иначе
		ТекстЛогаСобытий = "Ошибка получения Идентификаторов. Проверьте доступность сети и корректность заполнения профилей обмена.";
		ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
		МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
		
	КонецЕсли;


</Value>
		<Value xsi:type="xs:string"/>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="xs:string">Уведомление о приемке (RECADV)</Value>
		<Value xsi:type="ValueListType">
			<valueType/>
			<lastId xsi:type="xs:decimal">3</lastId>
			<item>
				<value xsi:type="xs:string">Прайс-лист</value>
				<id xsi:type="xs:decimal">0</id>
			</item>
			<item>
				<value xsi:type="xs:string">Поставщик</value>
				<presentation>СписокRecadvВходящие</presentation>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">1</id>
			</item>
			<item>
				<value xsi:type="xs:string">Покупатель</value>
				<id xsi:type="xs:decimal">2</id>
			</item>
			<item>
				<value xsi:type="xs:string">ИмяКнопки</value>
				<presentation>Уведомление о приемке (RECADV)</presentation>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">3</id>
			</item>
		</Value>
	</row>
</ValueTree>