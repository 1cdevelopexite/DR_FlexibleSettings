<ValueTree xmlns="http://v8.1c.ru/8.1/data/core" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ValueTree">
	<column>
		<Name xsi:type="xs:string">Использовать</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">ТипТранзакции</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Служебные</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Данные</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Сохранение</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Загрузка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Кнопка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">КоллекцияТЧ</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Источник</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Приемник</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Атрибуты</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">ДанныеЗначения</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">ДоступныеЗначения</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Связи</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Обязательный</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">ИмяКнопки</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Регламент</Name>
		<ValueType/>
	</column>
	<row>
		<Value xsi:type="xs:boolean">true</Value>
		<Value xsi:type="xs:string">Исходящий DP_UVUTOCH_09</Value>
		<Value xsi:type="xs:string">МассивСтруктурИсходящих = Новый Массив;

//&lt;МЧД&gt;
ЗапросМЧД = Новый Запрос;
ЗапросМЧД.Текст = ТекстЗапроса_МЧД_ПоОрганизациям();

ЗапросМЧД.УстановитьПараметр("ЭтоРегламентноеЗадание", ЭтоРегламентноеЗадание); 
ЗапросМЧД.УстановитьПараметр("Пользователь", НайтиТекущегоПользователя()); 
ЗапросМЧД.УстановитьПараметр("ТекущаяДата", ТекущаяДата()); 

ТаблицаМЧД = ЗапросМЧД.Выполнить().Выгрузить();
//&lt;/МЧД&gt;

ИмяСобытия = "Формирование DP_UVUTOCH_09";

Если Источник.Количество() = 0 Тогда

	ТекстЛогаСобытий = "Новые документы для обработки отсутствуют.";
	ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Информация", ИмяСобытия);
	МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
	
	Возврат МассивСтруктурИсходящих;
	
КонецЕсли;

ВидыДокументовЮЗД = Новый Массив;

Выполнить("DR_EDI_ОбщегоНазначения.ПолучитьПервичныеВидыДокументовЮЗД(ВидыДокументовЮЗД);");
Выполнить("DR_EDI_ОбщегоНазначения.ПолучитьИсправительныеВидыДокументовЮЗД(ВидыДокументовЮЗД);");
Выполнить("DR_EDI_ОбщегоНазначения.ПолучитьКорректировочныеВидыДокументовЮЗД(ВидыДокументовЮЗД);");

МассивПодписейВидовДокументовЮЗД  = Вычислить("DR_EDI_ОбщегоНазначения.ВидыДокументовИсходящихПодписейЮЗД()");

Запрос = Новый Запрос;
Запрос.Текст = 
"ВЫБРАТЬ
|	ТаблицаМЧД.Организация КАК Организация,
|	ТаблицаМЧД.Сертификат КАК Сертификат,
|	ТаблицаМЧД.СертификатИНН КАК СертификатИНН,
|	ТаблицаМЧД.СертификатНаСервере КАК СертификатНаСервере,
|	ТаблицаМЧД.ДолжностьПодписанта КАК ДолжностьПодписанта,
|	ТаблицаМЧД.ФамилияПодписанта КАК ФамилияПодписанта,
|	ТаблицаМЧД.ИмяПодписанта КАК ИмяПодписанта,
|	ТаблицаМЧД.ОтчествоПодписанта КАК ОтчествоПодписанта,
|	ТаблицаМЧД.ОбластьПолномочий КАК ОбластьПолномочий,
|	ТаблицаМЧД.ОснованиеПолномочий КАК ОснованиеПолномочий,
|	ТаблицаМЧД.СтатусПодписанта КАК СтатусПодписанта,
|	ТаблицаМЧД.СтрокаМЧД КАК СтрокаМЧД,
|	ТаблицаМЧД.Организация_ПоддерживаетМЧД КАК Организация_ПоддерживаетМЧД,
|	ТаблицаМЧД.ТипСертификата КАК ТипСертификата,
|	ТаблицаМЧД.МЧД_Актуальна КАК МЧД_Актуальна
|ПОМЕСТИТЬ ВТ_DR_МЧД
|ИЗ
|	&amp;ТаблицаМЧД КАК ТаблицаМЧД
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	DR_Документ.Ссылка КАК Ссылка,
|	DR_Документ.ДанныеЭЦП КАК ДанныеЭЦП,
|	DR_Организация.Значение КАК Организация,
|	DR_Контрагент.Значение КАК Контрагент,
|	DR_ИдФайл.Значение КАК ИмяПостФайла,
|	СобытияПоЮЗД.ВидДокумента КАК ВидДокумента,
|	DR_Документ.Комментарий КАК Комментарий,
|	DR_Документ.Номер КАК Номер,
|	DR_Документ.Дата КАК Дата,
|	ВЫБОР
|		КОГДА DR_GLN_Организация.ПоддерживаетМЧД = ИСТИНА
|				И DR_GLN_Контрагенты.ПоддерживаетМЧД = ИСТИНА
|			ТОГДА DR_МЧД.Сертификат
|		ИНАЧЕ DR_GLN_Организация.Сертификат
|	КОНЕЦ КАК СертификатОрганизации,
|	ВЫБОР
|		КОГДА DR_GLN_Организация.ПоддерживаетМЧД = ИСТИНА
|				И DR_GLN_Контрагенты.ПоддерживаетМЧД = ИСТИНА
|			ТОГДА DR_МЧД.СертификатНаСервере
|		ИНАЧЕ DR_СертификатНаСервере.Значение
|	КОНЕЦ КАК СертификатНаСервере,
|	ВЫБОР
|		КОГДА DR_GLN_Организация.ПоддерживаетМЧД = ИСТИНА
|				И DR_GLN_Контрагенты.ПоддерживаетМЧД = ИСТИНА
|			ТОГДА DR_МЧД.ДолжностьПодписанта
|		ИНАЧЕ DR_ДолжностьПодписанта.Значение
|	КОНЕЦ КАК ДолжностьПодписанта,
|	ВЫБОР
|		КОГДА DR_GLN_Организация.ПоддерживаетМЧД = ИСТИНА
|				И DR_GLN_Контрагенты.ПоддерживаетМЧД = ИСТИНА
|			ТОГДА DR_МЧД.ФамилияПодписанта
|		ИНАЧЕ DR_ФамилияПодписанта.Значение
|	КОНЕЦ КАК ФамилияПодписанта,
|	ВЫБОР
|		КОГДА DR_GLN_Организация.ПоддерживаетМЧД = ИСТИНА
|				И DR_GLN_Контрагенты.ПоддерживаетМЧД = ИСТИНА
|			ТОГДА DR_МЧД.ИмяПодписанта
|		ИНАЧЕ DR_ИмяПодписанта.Значение
|	КОНЕЦ КАК ИмяПодписанта,
|	ВЫБОР
|		КОГДА DR_GLN_Организация.ПоддерживаетМЧД = ИСТИНА
|				И DR_GLN_Контрагенты.ПоддерживаетМЧД = ИСТИНА
|			ТОГДА DR_МЧД.ОтчествоПодписанта
|		ИНАЧЕ DR_ОтчествоПодписанта.Значение
|	КОНЕЦ КАК ОтчествоПодписанта,
|	DR_GLN_Организация.Партнер КАК ОператорОрганизации,
|	ОператорОрганизацииИНН.Значение КАК ОператорОрганизацииИНН,
|	ОператорОрганизацииИдентификатор.Значение КАК ОператорОрганизацииИдентификатор,
|	DR_GLN_Контрагенты.Партнер КАК ОператорКонтрагента,
|	ОператорКонтрагентаИНН.Значение КАК ОператорКонтрагентаИНН,
|	ОператорКонтрагентаИдентификатор.Значение КАК ОператорКонтрагентаИдентификатор,
|	DR_GLN_Организация.Ид_ОЭД КАК Ид_ОЭД_Организации,
|	DR_GLN_Контрагенты.Ид_ОЭД КАК Ид_ОЭД_Контрагента,
|	DR_ФайлНомер.Значение КАК СЧФНомер,
|	DR_ФайлДата.Значение КАК СЧФДата,
|	DR_ФайлНомерКор.Значение КАК СЧФНомерКор,
|	DR_ФайлДатаКор.Значение КАК СЧФДатаКор,
|	СобытияПоУточнению.ВидДокумента КАК ПроверкаНаУточнение,
|	СобытияПодпись.ВидДокумента КАК ПроверкаНаПодпись,
|	DR_ФайлНомер.Значение КАК НомерДокумента,
|	DR_ФайлДата.Значение КАК ДатаДокумента,
|	DR_ФайлНомерКор.Значение КАК НомерДокументаКор,
|	DR_ФайлДатаКор.Значение КАК ДатаДокументаКор,
|	СобытияПоЮЗД.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
|	DR_GLN_Контрагенты.ПоддерживаетМЧД
|		И DR_GLN_Организация.ПоддерживаетМЧД
|		И DR_МЧД.ТипСертификата = 2 КАК ОтправитьМЧД,
|	DR_МЧД.МЧД_Актуальна КАК МЧД_Актуальна,
|	DR_МЧД.СтрокаМЧД КАК СтрокаМЧД,
|   DR_Сверено.Значение КАК Сверено
|ПОМЕСТИТЬ ВТ
|ИЗ
|	Документ.DR_Документ КАК DR_Документ
|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК DR_Организация
|		ПО DR_Документ.Ссылка = DR_Организация.Ссылка
|			И (DR_Организация.Реквизит = ""Организация"")
|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК DR_Контрагент
|		ПО DR_Документ.Ссылка = DR_Контрагент.Ссылка
|			И (DR_Контрагент.Реквизит = ""Контрагент"")
|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК DR_ФайлНомер
|		ПО DR_Документ.Ссылка = DR_ФайлНомер.Ссылка
|			И (DR_ФайлНомер.Реквизит = ""Документ_СвСчФакт_НомерСчФ"")
|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК DR_ФайлДата
|		ПО DR_Документ.Ссылка = DR_ФайлДата.Ссылка
|			И (DR_ФайлДата.Реквизит = ""Документ_СвСчФакт_ДатаСчФ"")
|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК DR_ФайлНомерКор
|		ПО (DR_Документ.Ссылка = DR_ФайлНомер.Ссылка)
|			И (DR_ФайлНомер.Реквизит = ""Документ_СвКСчФ_НомерКСчФ"")
|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК DR_ФайлДатаКор
|		ПО (DR_Документ.Ссылка = DR_ФайлДата.Ссылка)
|			И (DR_ФайлДата.Реквизит = ""Документ_СвКСчФ_ДатаКСчФ"")
|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК DR_ИдФайл
|		ПО DR_Документ.Ссылка = DR_ИдФайл.Ссылка
|			И (DR_ИдФайл.Реквизит = ""ИдФайл"")
|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.DR_Документ.ДополнительныеРеквизиты КАК DR_Сверено
|		ПО DR_Документ.Ссылка = DR_Сверено.Ссылка
|			И (DR_Сверено.Реквизит = ""Сверено"")
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.DR_GLN КАК DR_GLN_Организация
|		ПО (DR_Организация.Значение = DR_GLN_Организация.Объект)
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.DR_Настройки.ДополнительныеРеквизиты КАК DR_СертификатНаСервере
|		ПО (DR_GLN_Организация.Сертификат = DR_СертификатНаСервере.Ссылка)
|			И (DR_СертификатНаСервере.Реквизит = ""СертификатНаСервере"")
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.DR_Настройки.ДополнительныеРеквизиты КАК DR_ДолжностьПодписанта
|		ПО (DR_GLN_Организация.Сертификат = DR_ДолжностьПодписанта.Ссылка)
|			И (DR_ДолжностьПодписанта.Реквизит = ""ДолжностьПодписанта"")
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.DR_Настройки.ДополнительныеРеквизиты КАК DR_ИмяПодписанта
|		ПО (DR_GLN_Организация.Сертификат = DR_ИмяПодписанта.Ссылка)
|			И (DR_ИмяПодписанта.Реквизит = ""ИмяПодписанта"")
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.DR_Настройки.ДополнительныеРеквизиты КАК DR_ФамилияПодписанта
|		ПО (DR_GLN_Организация.Сертификат = DR_ФамилияПодписанта.Ссылка)
|			И (DR_ФамилияПодписанта.Реквизит = ""ФамилияПодписанта"")
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.DR_Настройки.ДополнительныеРеквизиты КАК DR_ОтчествоПодписанта
|		ПО (DR_GLN_Организация.Сертификат = DR_ОтчествоПодписанта.Ссылка)
|			И (DR_ОтчествоПодписанта.Реквизит = ""ОтчествоПодписанта"")
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.DR_Настройки.ДополнительныеРеквизиты КАК ОператорОрганизацииИНН
|		ПО (DR_GLN_Организация.Партнер = ОператорОрганизацииИНН.Ссылка)
|			И (ОператорОрганизацииИНН.Реквизит = ""ИНН"")
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.DR_Настройки.ДополнительныеРеквизиты КАК ОператорОрганизацииИдентификатор
|		ПО (DR_GLN_Организация.Партнер = ОператорОрганизацииИдентификатор.Ссылка)
|			И (ОператорОрганизацииИдентификатор.Реквизит = ""Идентификатор"")
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.DR_GLN КАК DR_GLN_Контрагенты
|		ПО (DR_Контрагент.Значение = DR_GLN_Контрагенты.Объект)
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.DR_Настройки.ДополнительныеРеквизиты КАК ОператорКонтрагентаИНН
|		ПО (DR_GLN_Контрагенты.Партнер = ОператорКонтрагентаИНН.Ссылка)
|			И (ОператорКонтрагентаИНН.Реквизит = ""ИНН"")
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.DR_Настройки.ДополнительныеРеквизиты КАК ОператорКонтрагентаИдентификатор
|		ПО (DR_GLN_Контрагенты.Партнер = ОператорКонтрагентаИдентификатор.Ссылка)
|			И (ОператорКонтрагентаИдентификатор.Реквизит = ""Идентификатор"")
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.DR_События КАК СобытияПоУточнению
|		ПО DR_Документ.Ссылка = СобытияПоУточнению.Документ
|			И (СобытияПоУточнению.ВидДокумента = ""DP_UVUTOCH_09"")
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.DR_События КАК СобытияПоЮЗД
|		ПО DR_Документ.Ссылка = СобытияПоЮЗД.Документ
|			И DR_Документ.ВидДокумента = СобытияПоЮЗД.ВидДокумента
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.DR_События КАК СобытияПодпись
|		ПО DR_Документ.Ссылка = СобытияПодпись.Документ
|			И (СобытияПодпись.ВидДокумента В (&amp;МассивПодписейВидовДокументовЮЗД))
|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_DR_МЧД КАК DR_МЧД
|		ПО (DR_Организация.Значение = DR_МЧД.Организация)
|ГДЕ
|	НЕ ПОДСТРОКА(DR_Документ.Комментарий, 0, 250) = """" 
|	И DR_Документ.Ссылка В(&amp;МассивДок)
|	И DR_Документ.Статус = ""Обработан""
|	И DR_Документ.ВидДокумента В(&amp;ВидыДокументовЮЗД)
|	И ВЫБОР
|		КОГДА &amp;АвтосверкаЮЗД = Истина
|			Тогда ВЫРАЗИТЬ(DR_Сверено.Значение КАК БУЛЕВО)
|		ИНАЧЕ Истина
|	КОНЕЦ
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	ВТ.ВидДокумента КАК ВидДокумента,
|	ВТ.Дата КАК Дата,
|	ВТ.Ид_ОЭД_Контрагента КАК Ид_ОЭД_Контрагента,
|	ВТ.Ид_ОЭД_Организации КАК Ид_ОЭД_Организации,
|	ВТ.ИмяПостФайла КАК ИмяПостФайла,
|	ВТ.Комментарий КАК Комментарий,
|	ВТ.Контрагент КАК Контрагент,
|	ВТ.Номер КАК Номер,
|	ВТ.ОператорКонтрагента КАК ОператорКонтрагента,
|	ВТ.ОператорКонтрагентаИНН КАК ОператорКонтрагентаИНН,
|	ВТ.ОператорКонтрагентаИдентификатор КАК ОператорКонтрагентаИдентификатор,
|	ВТ.ОператорОрганизации КАК ОператорОрганизации,
|	ВТ.ОператорОрганизацииИНН КАК ОператорОрганизацииИНН,
|	ВТ.ОператорОрганизацииИдентификатор КАК ОператорОрганизацииИдентификатор,
|	ВТ.Организация КАК Организация,
|	ВТ.ПроверкаНаУточнение КАК ПроверкаНаУточнение,
|	ВТ.СертификатОрганизации КАК СертификатОрганизации,
|	ВТ.СертификатНаСервере КАК СертификатНаСервере,
|	ВТ.ДолжностьПодписанта КАК ДолжностьПодписанта,
|	ВТ.ФамилияПодписанта КАК ФамилияПодписанта,
|	ВТ.ИмяПодписанта КАК ИмяПодписанта,
|	ВТ.ОтчествоПодписанта КАК ОтчествоПодписанта,
|	ВТ.Ссылка КАК Ссылка,
|	ВТ.ДанныеЭЦП КАК ДанныеЭЦП,
|	ВТ.СЧФДата КАК СЧФДата,
|	ВТ.СЧФНомер КАК СЧФНомер,
|	ВТ.СЧФДатаКор КАК СЧФДатаКор,
|	ВТ.СЧФНомерКор КАК СЧФНомерКор,
|	ВТ.ПроверкаНаПодпись КАК ПроверкаНаПодпись,
|	ВТ.НомерДокумента КАК НомерДокумента,
|	ВТ.ДатаДокумента КАК ДатаДокумента,
|	ВТ.НомерДокументаКор КАК НомерДокументаКор,
|	ВТ.ДатаДокументаКор КАК ДатаДокументаКор,
|	ВТ.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
|	ВТ.ОтправитьМЧД КАК ОтправитьМЧД,
|	ВТ.МЧД_Актуальна КАК МЧД_Актуальна,
|	ВТ.СтрокаМЧД КАК СтрокаМЧД
|ИЗ
|	ВТ КАК ВТ
|ГДЕ
|	(ВТ.ПроверкаНаУточнение ЕСТЬ NULL
|			ИЛИ ВТ.ПроверкаНаУточнение = НЕОПРЕДЕЛЕНО
|			ИЛИ ВТ.ПроверкаНаУточнение = """")
|	И (ВТ.ПроверкаНаПодпись ЕСТЬ NULL
|			ИЛИ ВТ.ПроверкаНаПодпись = НЕОПРЕДЕЛЕНО
|			ИЛИ ВТ.ПроверкаНаПодпись = """"
|			ИЛИ ВТ.ВидДокумента = ""ON_NSCHFDOPPRMARK_01""
|			ИЛИ ВТ.ВидДокумента = ""ON_NSCHFDOPPRMARK_01_Испр""
|			ИЛИ ВТ.ВидДокумента = ""ON_NKORSCHFDOPPRMARK_01""
|			ИЛИ ВТ.ВидДокумента = ""ON_NKORSCHFDOPPRMARK_01_Испр"")";		

Запрос.УстановитьПараметр("МассивДок"						, Источник);
Запрос.УстановитьПараметр("ТаблицаМЧД"						, ТаблицаМЧД);
Запрос.УстановитьПараметр("АвтосверкаЮЗД"					, Настройка_Параметр_Прочитать("EDI_АвтосверкаЮЗД", Ложь));
Запрос.УстановитьПараметр("ВидыДокументовЮЗД"				, ВидыДокументовЮЗД);
Запрос.УстановитьПараметр("МассивПодписейВидовДокументовЮЗД", МассивПодписейВидовДокументовЮЗД);

ВременныйКаталог = ПутьВременногоКаталогаЭКОМ("DP_UVUTOCH_out");
КаталогВременный = ЭКОМ_СоздатьКаталогПроверитьНаЗапись(ВременныйКаталог, МассивЛогаСобытий);	

Если КаталогВременный = Неопределено Тогда		
	
	ТекстЛогаСобытий = "Не удалось создать временный каталог, обработка была прервана.";
	ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
	МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);		
	
	Перейти ~Выход;
	
КонецЕсли;

Результат = Запрос.Выполнить();

Если Результат.Пустой() Тогда
	
	ТекстЛогаСобытий = "Уточнение не сформировано! Возможно уточнение уже отправлено или документ подписан ранее.";
	ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
	МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);

Иначе	
	
	ВыборкаДок = Результат.Выбрать();
	
	СтруктураМетаДанных = ЮрФизЛицоОпределитьМетаданные();
	
	Пока ВыборкаДок.Следующий() Цикл	
		
		Если ПустаяСтрока(ВыборкаДок.Комментарий) Тогда
			
			ТекстЛогаСобытий = "По " + Строка(ВыборкаДок.Ссылка) + " вида """ + ВыборкаДок.ВидДокумента + """, уточнение не сформировано! " + "Отсутствует текст уточнения.";
			ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Предупреждение", ИмяСобытия);
			МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);		
			
			Продолжить;
			
		КонецЕсли;
		
		Если ВыборкаДок.ОтправитьМЧД = Истина И (НЕ ЗначениеЗаполнено(ВыборкаДок.СтрокаМЧД) ИЛИ НЕ ВыборкаДок.МЧД_Актуальна) Тогда
			
			ТекстЛогаСобытий = "Не определена МЧД для текущего пользователя по организации! - " + Строка(ВыборкаДок.Организация);			
			ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
			МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
			
			Продолжить;
			
		КонецЕсли;
	
		Если НЕ ЗначениеЗаполнено(ВыборкаДок.СертификатОрганизации) Тогда	
			
			ТекстЛогаСобытий = "Данные для организации не определены, заполните регистр ЭКОМ GLN! Возможно пользователя нет в списке.";
			ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
			МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
			
			Продолжить;
			
		КонецЕсли; 
					
		Если НЕ ЗначениеЗаполнено(ВыборкаДок.ОператорОрганизации) Тогда		
			
			ТекстЛогаСобытий = "Нет данных по организации! - " + Строка(ВыборкаДок.Организация);
			ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
			МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);

			Продолжить;
						
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(ВыборкаДок.ОператорКонтрагента) Тогда
			
			ТекстЛогаСобытий = "Нет данных по контрагенту! - " + Строка(ВыборкаДок.Контрагент 
								+ ". ЭКОМ Документ № " + СокрЛП(ВыборкаДок.Номер) + " от " + ВыборкаДок.Дата);
								
			ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
			МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);

			Продолжить;
			
		КонецЕсли;
				
		ЭЦППолФайл = ВыборкаДок.ДанныеЭЦП.Получить();
		
		Если ЭЦППолФайл = Неопределено Тогда	
			
			ТекстЛогаСобытий = "Не найдена ЭЦП для входящего ЮЗД документа (не найдена запись в РС ""Docrobot События по документам"" документ: " + ВыборкаДок.Ссылка + ")";
			ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, "Ошибка", ИмяСобытия);
			МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
			
			Продолжить;
			
		КонецЕсли; 
		
		ПредставлениеДок = "ЭКОМ Документ (" + СокрЛП(ВыборкаДок.ВидДокумента) + ") № " 
							+ СокрЛП(ВыборкаДок.Номер) + " от " + ВыборкаДок.Дата;
		
		СтруктураДокумента = Новый Структура;	
		
		// Оператор ОЭД контрагента
		КонтрагентСвОЭДОтпрНаимОрг = ВыборкаДок.ОператорКонтрагента.Наименование;
		КонтрагентСвОЭДОтпрИННЮЛ   = ВыборкаДок.ОператорКонтрагентаИНН; 
		КонтрагентСвОЭДОтпрИдЭДО   = ВыборкаДок.ОператорКонтрагентаИдентификатор; 		
		
		// Оператор ОЭД организации
		ОрганизацияСвОЭДОтпрНаимОрг = ВыборкаДок.ОператорОрганизации.Наименование;
		ОрганизацияСвОЭДОтпрИННЮЛ   = ВыборкаДок.ОператорОрганизацииИНН; 
		ОрганизацияСвОЭДОтпрИдЭДО   = ВыборкаДок.ОператорОрганизацииИдентификатор; 		
		
		Если НЕ ЗначениеЗаполнено(ВыборкаДок.Ид_ОЭД_Организации) Тогда
			Сообщить("Не заполнен Ид_ОЭД для организации &lt;" + СокрЛП(ВыборкаДок.Организация.Наименование) + "&gt; для документа " + ПредставлениеДок + "!", СтатусСообщения.Важное);
			Продолжить;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(ВыборкаДок.Ид_ОЭД_Контрагента) Тогда
			Сообщить("Не заполнен Ид_ОЭД для контрагента &lt;" + СокрЛП(ВыборкаДок.Контрагент.Наименование) + "&gt; для документа " + ПредставлениеДок + "!", СтатусСообщения.Важное);
			Продолжить;
		КонецЕсли;
		
		ЭтоЮрЛицоКонтрагент = ЮрФизЛицоОпределитьТипОбъекта(ВыборкаДок.Контрагент, 
															СтруктураМетаДанных.ИмяРеквизитаКонтрагента, 
															СтруктураМетаДанных.ПеречислениеЮрЛицо);
		
		ЭтаОрганизацияЮрЛицо = ЭтаОрганизацияФизЛицоИлиИП(ВыборкаДок.Организация);
		
		Идентификатор = Новый УникальныйИдентификатор;
		
		ИдФайл = "DP_UVUTOCH_" + КонтрагентСвОЭДОтпрИдЭДО + ВыборкаДок.Ид_ОЭД_Контрагента + "_" 
				  + ОрганизацияСвОЭДОтпрИдЭДО + ВыборкаДок.Ид_ОЭД_Организации + "_" 
				  + Формат(ВыборкаДок.Дата, "ДФ=yyyyMMdd") + "_" + Идентификатор;
		
		СтруктураДокумента = Новый Структура;
		СтруктураДокумента.Вставить("ИдФайл"           , ИдФайл); 
		СтруктураДокумента.Вставить("ИдОтпр"           , ОрганизацияСвОЭДОтпрИдЭДО + ВыборкаДок.Ид_ОЭД_Организации); 
		СтруктураДокумента.Вставить("ИдПок"            , КонтрагентСвОЭДОтпрИдЭДО  + ВыборкаДок.Ид_ОЭД_Контрагента);
		СтруктураДокумента.Вставить("СвОЭДОтпрНаимОрг" , ОрганизацияСвОЭДОтпрНаимОрг);
		СтруктураДокумента.Вставить("СвОЭДОтпрИННЮЛ"   , ОрганизацияСвОЭДОтпрИННЮЛ); 
		СтруктураДокумента.Вставить("СвОЭДОтпрИдЭДО"   , ОрганизацияСвОЭДОтпрИдЭДО); 
		СтруктураДокумента.Вставить("ДатаДок"          , Формат(ВыборкаДок.Дата, "ДФ=dd.MM.yyyy"));
		СтруктураДокумента.Вставить("ВремДок"          , Формат(ВыборкаДок.Дата, "ДФ=HH.mm.ss")); 
		СтруктураДокумента.Вставить("НаимПервДок"      , "Акт об установленном расхождении по количеству и качеству при приемке товарно-материальных ценностей");
		
		Если ЭтоЮрЛицоКонтрагент Тогда
			
			СтруктураДокумента.Вставить("ТипПолучателя", 	"ЮЛ");
			СтруктураДокумента.Вставить("ПоставщикНаимОрг", СокрЛП(ВыборкаДок.Контрагент.Наименование)); 
			СтруктураДокумента.Вставить("ПоставщикИННЮЛ", 	СокрЛП(ВыборкаДок.Контрагент.ИНН));     
			СтруктураДокумента.Вставить("ПоставщикКПП",		СокрЛП(ВыборкаДок.Контрагент.КПП));
			
		Иначе
			
			СтруктураДокумента.Вставить("ТипПолучателя", 	"ФЛ");
			СтруктураДокумента.Вставить("ПоставщикИННФЛ", 	СокрЛП(ВыборкаДок.Контрагент.ИНН));
			СтруктураДокумента.Вставить("ПоставщикФамилияФЛ", "");
			СтруктураДокумента.Вставить("ПоставщикИмяФЛ", 	"");
			СтруктураДокумента.Вставить("ПоставщикОтчествоФЛ", "");
			
			НаименованиеФЛ = ВыборкаДок.Контрагент.Наименование;
			
			Если Найти(ВРег(НаименованиеФЛ), "ИП ") = 1 Тогда
				НаименованиеФЛ = Прав(НаименованиеФЛ, СтрДлина(НаименованиеФЛ) - 3);
			КонецЕсли;
			
			МассивИмяФЛ = Эком_РазложитьСтрокуВМассивПодстрок(НаименованиеФЛ, " ");
			
			Если МассивИмяФЛ.Количество() &gt;= 3 Тогда
				
				СтруктураДокумента.ПоставщикФамилияФЛ 	= СокрЛП(МассивИмяФЛ.Получить(0));
				СтруктураДокумента.ПоставщикИмяФЛ 		= СокрЛП(МассивИмяФЛ.Получить(1));
				СтруктураДокумента.ПоставщикОтчествоФЛ 	= СокрЛП(МассивИмяФЛ.Получить(2));
				
			ИначеЕсли МассивИмяФЛ.Количество() = 2 Тогда
				
				СтруктураДокумента.ПоставщикФамилияФЛ 	= СокрЛП(МассивИмяФЛ.Получить(0));
				СтруктураДокумента.ПоставщикИмяФЛ 		= СокрЛП(МассивИмяФЛ.Получить(1));
				
			ИначеЕсли МассивИмяФЛ.Количество() = 1 Тогда
				СтруктураДокумента.ПоставщикФамилияФЛ 	= СокрЛП(МассивИмяФЛ.Получить(0));
			КонецЕсли;
			
		КонецЕсли;
		
		Если ЭтаОрганизацияЮрЛицо Тогда
			
			СтруктураДокумента.Вставить("ТипОтправителя"	, "ЮЛ");	
			СтруктураДокумента.Вставить("ПлательщикНаимОрг"	, СокрЛП(ВыборкаДок.Организация.Наименование)); 
			СтруктураДокумента.Вставить("ПлательщикИННЮЛ"  	, СокрЛП(ВыборкаДок.Организация.ИНН)); 	
			СтруктураДокумента.Вставить("ПлательщикКПП"    	, СокрЛП(ВыборкаДок.Организация.КПП)); 
			
		Иначе 
			
			СтруктураДокумента.Вставить("ТипОтправителя"		, "ФЛ");
			СтруктураДокумента.Вставить("ПокупательИННФЛ"		, СокрЛП(ВыборкаДок.Организация.ИНН));
			СтруктураДокумента.Вставить("ПокупательФамилияФЛ"	, "");
			СтруктураДокумента.Вставить("ПокупательИмяФЛ"		, "");
			СтруктураДокумента.Вставить("ПокупательОтчествоФЛ"	, "");
			
			НаименованиеФЛ = ВыборкаДок.Организация.Наименование;
			
			Если Найти(ВРег(НаименованиеФЛ), "ИП ") = 1 Тогда
				НаименованиеФЛ = Прав(НаименованиеФЛ, СтрДлина(НаименованиеФЛ) - 3);
			КонецЕсли;
			
			МассивИмяФЛ = Эком_РазложитьСтрокуВМассивПодстрок(НаименованиеФЛ, " ");
			
			Если МассивИмяФЛ.Количество() &gt;= 3 Тогда
				
				СтруктураДокумента.ПокупательФамилияФЛ 	= СокрЛП(МассивИмяФЛ.Получить(0));
				СтруктураДокумента.ПокупательИмяФЛ 		= СокрЛП(МассивИмяФЛ.Получить(1));
				СтруктураДокумента.ПокупательОтчествоФЛ = СокрЛП(МассивИмяФЛ.Получить(2));
				
			ИначеЕсли МассивИмяФЛ.Количество() = 2 Тогда
				
				СтруктураДокумента.ПокупательФамилияФЛ 	= СокрЛП(МассивИмяФЛ.Получить(0));
				СтруктураДокумента.ПокупательИмяФЛ 		= СокрЛП(МассивИмяФЛ.Получить(1));
				
			ИначеЕсли МассивИмяФЛ.Количество() 	= 1 Тогда
				СтруктураДокумента.ПокупательФамилияФЛ 	= СокрЛП(МассивИмяФЛ.Получить(0));
			КонецЕсли;
			
		КонецЕсли;
		
		СтруктураДокумента.Вставить("НомСФ"            	, ВыборкаДок.СЧФНомер);
		СтруктураДокумента.Вставить("ДатаСФ"           	, Формат(ВыборкаДок.СЧФДата, "ДФ=dd.MM.yyyy"));
		СтруктураДокумента.Вставить("ИмяПостФайла"     	, ВыборкаДок.ИмяПостФайла);
		СтруктураДокумента.Вставить("ТекстУведУточ"    	, ВыборкаДок.Комментарий);
		
		СтруктураДокумента.Вставить("ЭЦППолФайл"       	, ЭЦППолФайл);
		
		СтруктураДокумента.Вставить("ПодписантИННЮЛ"   	, СокрЛП(ВыборкаДок.Организация.ИНН));
		СтруктураДокумента.Вставить("ПодписантДолжн"   	, ВыборкаДок.ДолжностьПодписанта);
		СтруктураДокумента.Вставить("ПодписантФамилия" 	, ВыборкаДок.ФамилияПодписанта);
		СтруктураДокумента.Вставить("ПодписантИмя"     	, ВыборкаДок.ИмяПодписанта);
		
		ФайлXMLПолноеИмя = ВременныйКаталог + СтруктураДокумента.ИдФайл + ".xml";
		 
		СтрокаXML = ЗаписатьФайлDP_UVUTOCH_УведОбУточЭлДок(СтруктураДокумента, ФайлXMLПолноеИмя);  
		
		СтрокаСтруктура = Новый Структура;			
		СтрокаСтруктура.Вставить("ИмяФайлаXML"          , СтруктураДокумента.ИдФайл + ".xml");
		СтрокаСтруктура.Вставить("СтруктураДокумента"   , СтруктураДокумента);
		СтрокаСтруктура.Вставить("ДанныеСертификатаЭКОМ", ВыборкаДок.СертификатОрганизации);
		СтрокаСтруктура.Вставить("СертификатНаСервере"  , ВыборкаДок.СертификатНаСервере);
		СтрокаСтруктура.Вставить("Документ"             , ВыборкаДок.Ссылка);
		СтрокаСтруктура.Вставить("Организация"          , ВыборкаДок.Организация);
		СтрокаСтруктура.Вставить("Контрагент"           , ВыборкаДок.Контрагент);
		СтрокаСтруктура.Вставить("ВидДокументаУПД"      , ВыборкаДок.ВидДокумента);
		СтрокаСтруктура.Вставить("Статус"               , "Отправлен");
		СтрокаСтруктура.Вставить("ВидДокумента"         , "DP_UVUTOCH_09_Исходящий");
		СтрокаСтруктура.Вставить("ИдентификаторЦепочки" , ВыборкаДок.ИдентификаторЦепочки);
		
		Если ЗначениеЗаполнено(ВыборкаДок.ИмяПостФайла) Тогда
			СтрокаСтруктура.Вставить("ИдентификаторОснования", Прав(ВыборкаДок.ИмяПостФайла, 36));
		КонецЕсли;
		
		СтрокаСтруктура.Вставить("ИдентификаторИспр"    , СтруктураДокумента.ИмяПостФайла);
		СтрокаСтруктура.Вставить("СтрокаXML"            , СтрокаXML);
		СтрокаСтруктура.Вставить("КодировкаФайла"       , "windows-1251");
		СтрокаСтруктура.Вставить("НомерДокумента"       , ВыборкаДок.НомерДокумента);
		СтрокаСтруктура.Вставить("ДатаДокумента"        , ВыборкаДок.ДатаДокумента);
		СтрокаСтруктура.Вставить("Идентификатор"		, Идентификатор);
		СтрокаСтруктура.Вставить("ТекстСообщения"		, ВыборкаДок.Комментарий);
		
		СтрокаСтруктура.Вставить("ТипФайла", "DP_UVUTOCH");
		
		Если ВыборкаДок.ОтправитьМЧД = Истина Тогда
			СтрокаСтруктура.Вставить("СтрокаМЧД", СтрЗаменить(ВыборкаДок.СтрокаМЧД, "&amp;GUID", СтрЗаменить(Идентификатор, "-", "")));
		КонецЕсли;
		
		МассивСтруктурИсходящих.Добавить(СтрокаСтруктура);
		
	КонецЦикла;
	
КонецЕсли;

~Выход:
Возврат МассивСтруктурИсходящих;</Value>
		<Value xsi:type="xs:string"/>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="xs:string">Исходящий DP_UVUTOCH_09</Value>
		<Value xsi:type="ValueListType">
			<valueType/>
			<lastId xsi:type="xs:decimal">8</lastId>
			<item>
				<value xsi:type="xs:string">Прайс-лист</value>
				<id xsi:type="xs:decimal">0</id>
			</item>
			<item>
				<value xsi:type="xs:string">Поставщик</value>
				<id xsi:type="xs:decimal">1</id>
			</item>
			<item>
				<value xsi:type="xs:string">Покупатель</value>
				<presentation>СписокСчетаФактурыВходящиеПокупатель; СписокКорректировочныеСчетаФактурыВходящиеПокупатель; СписокИсправительныеСчетаФактурыВходящиеПокупатель</presentation>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">2</id>
			</item>
			<item>
				<value xsi:type="xs:string">Синоним</value>
				<presentation>Исходящий DP_UVUTOCH_09</presentation>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">3</id>
			</item>
			<item>
				<value xsi:type="xs:string">ИмяКнопки</value>
				<presentation>ИсходящийDP_UVUTOCH_09</presentation>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">4</id>
			</item>
			<item>
				<value xsi:type="xs:string">ПередаватьТекстПричины</value>				
				<id xsi:type="xs:decimal">5</id>
			</item>
			<item>
				<value xsi:type="xs:string">ПриемникВидДокумента</value>
				<presentation>DP_UVUTOCH_09_Исходящий</presentation>
				<id xsi:type="xs:decimal">6</id>
			</item>
			<item>
				<value xsi:type="xs:string">ИсточникВидДокумента</value>
				<presentation>ON_NSCHFDOPPR_01_Входящий; ON_NSCHFDOPPR_01_Испр_Входящий; ON_NSCHFDOPPRMARK_01_Входящий; ON_NSCHFDOPPRMARK_01_Испр_Входящий; ON_NSCHFDOPPRPROS_01_Входящий; ON_NSCHFDOPPRPROS_01_Испр_Входящий; ON_NKORSCHFDOPPR_01_Входящий; ON_NKORSCHFDOPPR_01_Испр_Входящий; ON_NKORSCHFDOPPRMARK_01_Входящий; ON_NKORSCHFDOPPRMARK_01_Испр_Входящий; ON_NKORSCHFDOPPRPROS_01_Входящий; ON_NKORSCHFDOPPRPROS_01_Испр_Входящий</presentation>
				<id xsi:type="xs:decimal">7</id>
			</item>
			<item>
				<value xsi:type="xs:string">НужнаПодпись</value>
				<presentation>Да</presentation>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">8</id>
			</item>
		</Value>
		<Value xsi:type="xs:string"/>
		<Value xsi:type="xs:string"/>
		<Value xsi:type="ValueListType">
			<valueType/>
			<lastId xsi:type="xs:decimal">-1</lastId>
		</Value>
		<Value xsi:type="ValueTable">
			<column>
				<Name xsi:type="xs:string">Реквизит1</Name>
				<ValueType>
					<Type>xs:string</Type>
					<StringQualifiers>
						<Length>0</Length>
						<AllowedLength>Variable</AllowedLength>
					</StringQualifiers>
				</ValueType>
			</column>
		</Value>
		<Value xsi:type="ValueListType">
			<valueType/>
			<lastId xsi:type="xs:decimal">-1</lastId>
		</Value>
		<Value xsi:type="ValueListType">
			<valueType/>
			<lastId xsi:type="xs:decimal">-1</lastId>
		</Value>
		<Value xsi:type="xs:boolean">false</Value>
		<Value xsi:type="xs:string">ИсходящийDP_UVUTOCH_09</Value>
		<Value xsi:type="ValueListType">
			<valueType/>
			<lastId xsi:type="xs:decimal">-1</lastId>
		</Value>
	</row>
</ValueTree>